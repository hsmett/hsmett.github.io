(function(){function a(b,c){if(!Object[b]){Object[b]=c}}a("property",function(d,b,c){if(c===undefined){return d[b]}d[b]=c;return d});a("keys",function(e,c){var d=[];for(var b in e){if(c||e.hasOwnProperty(b)){d.push(b)}}return d});a("values",function(e,d){var b=[];for(var c in e){if(d||e.hasOwnProperty(c)){b.push(e[c])}}return b});a("entries",function(e,d){var b=[];for(var c in e){if(d||e.hasOwnProperty(c)){b.push([c,e[c]])}}return b});a("isNone",function(b){return b===undefined||b===null});a("isEmpty",function(c){if(Object.isNone(c)||c.length===0){return true}if(typeof c==="number"){return false}for(var b in c){return false}return true});a("isType",function(c,b){return(typeof c===b)});a("assertIsTypeOf",function(c,b){if(typeof c!==b){throw Error('"'+c+'" is not a '+b)}});a("isFunc",function(b){return(typeof b==="function")});a("isString",function(b){if(!Object.isNone(b)){return(typeof b==="string")||(b instanceof String)}else{return false}});a("proxy",function(g,e,b){if(Object.isNone(g)){return}b=b||{};e=e||g;var d={__context__:e};var f=Object.isFunc(b.filter)?b.filter:function(){return true};var h=Object.isFunc(b.arguments)?function(j){return b.arguments(Array.copy(j))}:Array.copy;for(var c in g){var i=g[c];if(!Object.isFunc(i)||f(c,i)===false){continue}(function(k,l,j){k[j]=function(){return l.apply(this.__context__,h(arguments))}})(d,i,c)}return d});a("getPrototypeOf",function(b){if(typeof"".__proto__==="object"){return b.__proto__}if(Object.isNone(b)||b===Object.prototype){return null}return Object.isNone(b.constructor)?null:b.constructor.prototype});a("isSubClassOf",function(b,c){if(c&&Object.isFunc(c.prototype.isPrototypeOf)){return c.prototype.isPrototypeOf(b)}return false})}());(function(c){function a(d,e){if(!Array.prototype[d]){Array.prototype[d]=e}}function b(d,e){if(!Array[d]){Array[d]=e}}a("indexOf",function(e,f){for(var d=f||0;d<this.length;d++){if(this[d]===e){return d}}return -1});b("isArray",function(d){return(d!==undefined&&d!==null&&d.toString()==="[object Array]")||d instanceof Array});b("copy",function(g,h,d){var f=[];h=Math.min(Math.max(0,h||0),g.length);d=d!==undefined?Math.min(Math.max(0,d),g.length):g.length;for(var e=h;e<d;++e){f.push(g[e])}return f});a("map",function(f,e){e=e||window;var g=[];for(var d=0;d<this.length;d++){g[g.length]=f.call(e,this[d],d,this)}return g});a("forEach",function(f,e){for(var d=0;d<this.length;d++){f.call(e||window,this[d],d,this)}});if(c!==undefined){return}a("exfiltrate",function(d){return this.filter(function(e){return this.indexOf(e)<0},d)});a("contains",function(d){return this.indexOf(d)>=0});a("every",function(f,e){for(var d=0;d<this.length;d++){if(!f.call(e||window,this[d],d,this)){return false}}return true});a("filter",function(f,e){var g=[];for(var d=0;d<this.length;d++){if(f.call(e||window,this[d],d,this)){g.push(this[d])}}return g});a("getRange",function(h,d){var e=this;if(e.length<1){return[]}h=h||0;d=Math.min(d===undefined?this.length-1:d,this.length-1);var g=[],f;if(h<=d){for(f=h;f<=d;f++){g[g.length]=e[f]}}else{for(f=h;f>=d;f--){g[g.length]=e[f]}}return g});a("inArray",function(e){for(var d=0;d<this.length;d++){if(e===this[d]){return true}}return false});a("insertAt",function(e,f){for(var d=this.length;d>e;d--){this[d]=this[d-1]}this[e]=f;return this});a("removeAt",function(e){for(var d=e;d<this.length-1;d++){this[d]=this[d+1]}this.length--;return this});a("some",function(f,e){for(var d=0;d<this.length;d++){if(f.call(e||window,this[d],d,this)){return true}}return false});a("unique",function(){return this.filter(function(e,d,f){return f.indexOf(e)>=d})})}(jQuery));(function(){function c(f,g){if(!String.prototype[f]){String.prototype[f]=g}}c("startsWith",function(f){return this.slice(0,f.length)===f});c("endsWith",function(f){return this.slice(-f.length)===f});c("trim",function(){return this.replace(/^\s+|\s+$/g,"")});c("ltrim",function(){return this.replace(/^\s+/,"")});c("rtrim",function(){return this.replace(/\s+$/,"")});c("capitalize",function(){return this.length>0?this.slice(0,1).toUpperCase().concat(this.slice(1,this.length)):this});c("isDigit",function(){return this.match(/^(\+|\-)?[\.0-9]+/)!==null});c("isAlpha",function(){return this.match(/^[a-zA-z]+$/)!==null});c("isSpace",function(){return this.match(/^[\s]+$/)!==null});c("template",function(g,f){if(Object.isNone(g)){return String(this)}f=f||/\$\{([^\}]+)\}/g;return this.replace(f,function(h,i){var j=g[i];return j!==undefined?j:h})});function b(f){if(f.charAt(2)==="x"){return String.fromCharCode(parseInt(f.substr(3,f.length-4),16))}else{return String.fromCharCode(f.substr(2,f.length-3))}}function d(f){return String.fromCharCode(parseInt(f.substr(2,f.length-2),16))}c("decodeHTMLEntities",function(){return this.replace(/\\u[0-9A-F]{4,6}/gi,d).replace(/&(#([0-9]{2,4})|#x([0-9A-F]{2,6}));/gi,b)});var a=[["A","\u0041\u24B6\uFF21\u00C0\u00C1\u00C2\u1EA6\u1EA4\u1EAA\u1EA8\u00C3\u0100\u0102\u1EB0\u1EAE\u1EB4\u1EB2\u0226\u01E0\u00C4\u01DE\u1EA2\u00C5\u01FA\u01CD\u0200\u0202\u1EA0\u1EAC\u1EB6\u1E00\u0104\u023A\u2C6F]"],["AA","\uA732]"],["AE","\u00C6\u01FC\u01E2]"],["AO","\uA734]"],["AU","\uA736]"],["AV","\uA738\uA73A]"],["AY","\uA73C]"],["B","\u0042\u24B7\uFF22\u1E02\u1E04\u1E06\u0243\u0182\u0181]"],["C","\u0043\u24B8\uFF23\u0106\u0108\u010A\u010C\u00C7\u1E08\u0187\u023B\uA73E]"],["D","\u0044\u24B9\uFF24\u1E0A\u010E\u1E0C\u1E10\u1E12\u1E0E\u0110\u018B\u018A\u0189\uA779]"],["DZ","\u01F1\u01C4]"],["Dz","\u01F2\u01C5]"],["E","\u0045\u24BA\uFF25\u00C8\u00C9\u00CA\u1EC0\u1EBE\u1EC4\u1EC2\u1EBC\u0112\u1E14\u1E16\u0114\u0116\u00CB\u1EBA\u011A\u0204\u0206\u1EB8\u1EC6\u0228\u1E1C\u0118\u1E18\u1E1A\u0190\u018E]"],["F","\u0046\u24BB\uFF26\u1E1E\u0191\uA77B]"],["G","\u0047\u24BC\uFF27\u01F4\u011C\u1E20\u011E\u0120\u01E6\u0122\u01E4\u0193\uA7A0\uA77D\uA77E]"],["H","\u0048\u24BD\uFF28\u0124\u1E22\u1E26\u021E\u1E24\u1E28\u1E2A\u0126\u2C67\u2C75\uA78D]"],["I","\u0049\u24BE\uFF29\u00CC\u00CD\u00CE\u0128\u012A\u012C\u0130\u00CF\u1E2E\u1EC8\u01CF\u0208\u020A\u1ECA\u012E\u1E2C\u0197]"],["J","\u004A\u24BF\uFF2A\u0134\u0248]"],["K","\u004B\u24C0\uFF2B\u1E30\u01E8\u1E32\u0136\u1E34\u0198\u2C69\uA740\uA742\uA744\uA7A2]"],["L","\u004C\u24C1\uFF2C\u013F\u0139\u013D\u1E36\u1E38\u013B\u1E3C\u1E3A\u0141\u023D\u2C62\u2C60\uA748\uA746\uA780]"],["LJ","\u01C7]"],["Lj","\u01C8]"],["M","\u004D\u24C2\uFF2D\u1E3E\u1E40\u1E42\u2C6E\u019C]"],["N","\u004E\u24C3\uFF2E\u01F8\u0143\u00D1\u1E44\u0147\u1E46\u0145\u1E4A\u1E48\u0220\u019D\uA790\uA7A4]"],["NJ","\u01CA]"],["Nj","\u01CB]"],["O","\u004F\u24C4\uFF2F\u00D2\u00D3\u00D4\u1ED2\u1ED0\u1ED6\u1ED4\u00D5\u1E4C\u022C\u1E4E\u014C\u1E50\u1E52\u014E\u022E\u0230\u00D6\u022A\u1ECE\u0150\u01D1\u020C\u020E\u01A0\u1EDC\u1EDA\u1EE0\u1EDE\u1EE2\u1ECC\u1ED8\u01EA\u01EC\u00D8\u01FE\u0186\u019F\uA74A\uA74C]"],["OI","\u01A2]"],["OO","\uA74E]"],["OU","\u0222]"],["P","\u0050\u24C5\uFF30\u1E54\u1E56\u01A4\u2C63\uA750\uA752\uA754]"],["Q","\u0051\u24C6\uFF31\uA756\uA758\u024A]"],["R","\u0052\u24C7\uFF32\u0154\u1E58\u0158\u0210\u0212\u1E5A\u1E5C\u0156\u1E5E\u024C\u2C64\uA75A\uA7A6\uA782]"],["S","\u0053\u24C8\uFF33\u1E9E\u015A\u1E64\u015C\u1E60\u0160\u1E66\u1E62\u1E68\u0218\u015E\u2C7E\uA7A8\uA784]"],["T","\u0054\u24C9\uFF34\u1E6A\u0164\u1E6C\u021A\u0162\u1E70\u1E6E\u0166\u01AC\u01AE\u023E\uA786]"],["TZ","\uA728]"],["U","\u0055\u24CA\uFF35\u00D9\u00DA\u00DB\u0168\u1E78\u016A\u1E7A\u016C\u00DC\u01DB\u01D7\u01D5\u01D9\u1EE6\u016E\u0170\u01D3\u0214\u0216\u01AF\u1EEA\u1EE8\u1EEE\u1EEC\u1EF0\u1EE4\u1E72\u0172\u1E76\u1E74\u0244]"],["V","\u0056\u24CB\uFF36\u1E7C\u1E7E\u01B2\uA75E\u0245]"],["VY","\uA760]"],["W","\u0057\u24CC\uFF37\u1E80\u1E82\u0174\u1E86\u1E84\u1E88\u2C72]"],["X","\u0058\u24CD\uFF38\u1E8A\u1E8C]"],["Y","\u0059\u24CE\uFF39\u1EF2\u00DD\u0176\u1EF8\u0232\u1E8E\u0178\u1EF6\u1EF4\u01B3\u024E\u1EFE]"],["Z","\u005A\u24CF\uFF3A\u0179\u1E90\u017B\u017D\u1E92\u1E94\u01B5\u0224\u2C7F\u2C6B\uA762]"],["a","\u0061\u24D0\uFF41\u1E9A\u00E0\u00E1\u00E2\u1EA7\u1EA5\u1EAB\u1EA9\u00E3\u0101\u0103\u1EB1\u1EAF\u1EB5\u1EB3\u0227\u01E1\u00E4\u01DF\u1EA3\u00E5\u01FB\u01CE\u0201\u0203\u1EA1\u1EAD\u1EB7\u1E01\u0105\u2C65\u0250]"],["aa","\uA733]"],["ae","\u00E6\u01FD\u01E3]"],["ao","\uA735]"],["au","\uA737]"],["av","\uA739\uA73B]"],["ay","\uA73D]"],["b","\u0062\u24D1\uFF42\u1E03\u1E05\u1E07\u0180\u0183\u0253]"],["c","\u0063\u24D2\uFF43\u0107\u0109\u010B\u010D\u00E7\u1E09\u0188\u023C\uA73F\u2184]"],["d","\u0064\u24D3\uFF44\u1E0B\u010F\u1E0D\u1E11\u1E13\u1E0F\u0111\u018C\u0256\u0257\uA77A]"],["dz","\u01F3\u01C6]"],["e","\u0065\u24D4\uFF45\u00E8\u00E9\u00EA\u1EC1\u1EBF\u1EC5\u1EC3\u1EBD\u0113\u1E15\u1E17\u0115\u0117\u00EB\u1EBB\u011B\u0205\u0207\u1EB9\u1EC7\u0229\u1E1D\u0119\u1E19\u1E1B\u0247\u025B\u01DD]"],["f","\u0066\u24D5\uFF46\u1E1F\u0192\uA77C]"],["g","\u0067\u24D6\uFF47\u01F5\u011D\u1E21\u011F\u0121\u01E7\u0123\u01E5\u0260\uA7A1\u1D79\uA77F]"],["h","\u0068\u24D7\uFF48\u0125\u1E23\u1E27\u021F\u1E25\u1E29\u1E2B\u1E96\u0127\u2C68\u2C76\u0265]"],["hv","\u0195]"],["i","\u0069\u24D8\uFF49\u00EC\u00ED\u00EE\u0129\u012B\u012D\u00EF\u1E2F\u1EC9\u01D0\u0209\u020B\u1ECB\u012F\u1E2D\u0268\u0131]"],["j","\u006A\u24D9\uFF4A\u0135\u01F0\u0249]"],["k","\u006B\u24DA\uFF4B\u1E31\u01E9\u1E33\u0137\u1E35\u0199\u2C6A\uA741\uA743\uA745\uA7A3]"],["l","\u006C\u24DB\uFF4C\u0140\u013A\u013E\u1E37\u1E39\u013C\u1E3D\u1E3B\u017F\u0142\u019A\u026B\u2C61\uA749\uA781\uA747]"],["lj","\u01C9]"],["m","\u006D\u24DC\uFF4D\u1E3F\u1E41\u1E43\u0271\u026F]"],["n","\u006E\u24DD\uFF4E\u01F9\u0144\u00F1\u1E45\u0148\u1E47\u0146\u1E4B\u1E49\u019E\u0272\u0149\uA791\uA7A5]"],["nj","\u01CC]"],["o","\u006F\u24DE\uFF4F\u00F2\u00F3\u00F4\u1ED3\u1ED1\u1ED7\u1ED5\u00F5\u1E4D\u022D\u1E4F\u014D\u1E51\u1E53\u014F\u022F\u0231\u00F6\u022B\u1ECF\u0151\u01D2\u020D\u020F\u01A1\u1EDD\u1EDB\u1EE1\u1EDF\u1EE3\u1ECD\u1ED9\u01EB\u01ED\u00F8\u01FF\u0254\uA74B\uA74D\u0275]"],["oi","\u01A3]"],["ou","\u0223]"],["oo","\uA74F]"],["p","\u0070\u24DF\uFF50\u1E55\u1E57\u01A5\u1D7D\uA751\uA753\uA755]"],["q","\u0071\u24E0\uFF51\u024B\uA757\uA759]"],["r","\u0072\u24E1\uFF52\u0155\u1E59\u0159\u0211\u0213\u1E5B\u1E5D\u0157\u1E5F\u024D\u027D\uA75B\uA7A7\uA783]"],["s","\u0073\u24E2\uFF53\u00DF\u015B\u1E65\u015D\u1E61\u0161\u1E67\u1E63\u1E69\u0219\u015F\u023F\uA7A9\uA785\u1E9B]"],["t","\u0074\u24E3\uFF54\u1E6B\u1E97\u0165\u1E6D\u021B\u0163\u1E71\u1E6F\u0167\u01AD\u0288\u2C66\uA787]"],["tz","\uA729]"],["u","\u0075\u24E4\uFF55\u00F9\u00FA\u00FB\u0169\u1E79\u016B\u1E7B\u016D\u00FC\u01DC\u01D8\u01D6\u01DA\u1EE7\u016F\u0171\u01D4\u0215\u0217\u01B0\u1EEB\u1EE9\u1EEF\u1EED\u1EF1\u1EE5\u1E73\u0173\u1E77\u1E75\u0289]"],["v","\u0076\u24E5\uFF56\u1E7D\u1E7F\u028B\uA75F\u028C]"],["vy","\uA761]"],["w","\u0077\u24E6\uFF57\u1E81\u1E83\u0175\u1E87\u1E85\u1E98\u1E89\u2C73]"],["x","\u0078\u24E7\uFF58\u1E8B\u1E8D]"],["y","\u0079\u24E8\uFF59\u1EF3\u00FD\u0177\u1EF9\u0233\u1E8F\u00FF\u1EF7\u1E99\u1EF5\u01B4\u024F\u1EFF]"],["z","\u007A\u24E9\uFF5A\u017A\u1E91\u017C\u017E\u1E93\u1E95\u01B6\u0225\u0240\u2C6C\uA763]"]];var e={};a.forEach(function(f){var g=f[1].split("");g.forEach(function(h){e[h]=f[0]})});c("removeDiacritics",function(){return this.replace(/[^\u0000-\u007E]/g,function(f){return e[f]||f})});c("format",function(){function h(u,i,r,t){var s=(u.length>=i)?"":Array(1+i-u.length>>>0).join(r);return t?u+s:s+u}function f(t){var s=String(t);for(var r=10;r>0;r--){if(s===(s=s.replace(/^(\d+)(\d{3})/,"$1"+q+"$2"))){break}}return s}function j(v,u,x,s,t,r){var w=s-v.length;if(w>0){var i=" ";if(r){i="&nbsp;"}if(x||!t){v=h(v,s,i,x)}else{v=v.slice(0,u.length)+h("",w,"0",true)+v.slice(u.length)}}return v}function p(y,r,w,s,i,v,x,u){var t=y>>>0;w=(w&&t&&{"2":"0b","8":"0","16":"0x"}[r])||"";y=w+h(t.toString(r),v||0,"0",false);return j(y,w,s,i,x,u)}function k(u,v,s,i,t,r){if(i!=null){u=u.slice(0,i)}return j(u,"",v,s,t,r)}var o=arguments,l=0;var q=",";var m=".";var n=/%%|%(\d+\$)?([-+#0&\' ]*)(\*\d+\$|\*|\d+)?(\.(\*\d+\$|\*|\d+))?([nAscboxXuidfegpEGP])/g;if(o.length===1&&Array.isArray(o[0])){o=o[0]}var g=String(this);return g.replace(n,function(M,x,y,B,O,J,v){if(M==="%%"){return"%"}var D=false,z="",A=false,L=false,w=false,u=false;y=y||"";for(var I=0;I<y.length;I++){switch(y.charAt(I)){case" ":z=" ";break;case"+":z="+";break;case"-":D=true;break;case"0":A=true;break;case"#":L=true;break;case"&":w=true;break;case"'":u=true;break}}if(!B){B=0}else{if(B==="*"){B=+o[l++]}else{if(B.charAt(0)==="*"){B=+o[B.slice(1,-1)]}else{B=+B}}}if(B<0){B=-B;D=true}if(!isFinite(B)){throw new Error("String.sprintf: (minimum-)width must be finite")}if(!J){J="fFeE".indexOf(v)>-1?6:(v==="d")?0:void (0)}else{if(J==="*"){J=+o[l++]}else{if(J.charAt(0)==="*"){J=+o[J.slice(1,-1)]}else{J=+J}}}var F=x?o[x.slice(0,-1)]:o[l++];var s,H,K,N,t;switch(v){case"s":if(F==null){return""}return k(String(F),D,B,J,A,w);case"c":return k(String.fromCharCode(+F),D,B,J,A,w);case"b":return p(F,2,L,D,B,J,A,w);case"o":return p(F,8,L,D,B,J,A,w);case"x":return p(F,16,L,D,B,J,A,w);case"X":return p(F,16,L,D,B,J,A,w).toUpperCase();case"u":return p(F,10,L,D,B,J,A,w);case"i":s=parseInt(+F,10);if(isNaN(s)){return""}H=s<0?"-":z;K=u?f(String(Math.abs(s))):String(Math.abs(s));F=H+h(K,J,"0",false);return j(F,H,D,B,A,w);case"d":s=Math.round(+F);if(isNaN(s)){return""}H=s<0?"-":z;K=u?f(String(Math.abs(s))):String(Math.abs(s));F=H+h(K,J,"0",false);return j(F,H,D,B,A,w);case"e":case"E":case"f":case"F":case"g":case"G":s=+F;if(isNaN(s)){return""}H=s<0?"-":z;t=["toExponential","toFixed","toPrecision"]["efg".indexOf(v.toLowerCase())];N=["toString","toUpperCase"]["eEfFgG".indexOf(v)%2];K=Math.abs(s)[t](J);K=u?f(K):K;F=H+K;var C=j(F,H,D,B,A,w)[N]();if(m!=="."&&m!==q){return C.replace(/\./,m)}else{return C}case"p":case"P":s=+F;if(isNaN(s)){return""}H=s<0?"-":z;var E=String(Number(Math.abs(s)).toExponential()).split(/e|E/);var r=(E[0].indexOf(".")!==-1)?E[0].length-1:E[0].length;var G=(E[1]<0)?-E[1]-1:0;if(Math.abs(s)<1){if(r+G<=J){F=H+Math.abs(s).toPrecision(r)}else{if(r<=J-1){F=H+Math.abs(s).toExponential(r-1)}else{F=H+Math.abs(s).toExponential(J-1)}}}else{var i=(r<=J)?r:J;F=H+Math.abs(s).toPrecision(i)}N=["toString","toUpperCase"]["pP".indexOf(v)%2];return j(F,H,D,B,A,w)[N]();case"n":return"";default:return M}})})})();(function(){window.console=window.console||{};function b(d,e){if(!window.console[d]){window.console[d]=e}}function c(){var e=navigator.appVersion.match(/MSIE ([\d.]+)/);if(e===null){return false}if(arguments.length===0){return true}for(var d=0;d<arguments.length;++d){if(e[1].indexOf(""+arguments[d])!==-1){return true}}return false}b("log",function(){if(window.opera&&window.opera.postError){return window.opera.postError.apply(window.opera,arguments)}});b("warn",window.console.log);b("error",window.console.log);if(c(9,10)){var a=["log","warn","error"];a.forEach(function(d){var e=Function.prototype.bind.call(console[d],console);console[d]=function(){return e.apply(console,Array.copy(arguments).map(function(f){if(typeof f==="object"&&JSON&&JSON.stringify){return JSON.stringify(f,function(g,h){if(typeof h==="function"){h=h.toString();return h.slice(0,h.indexOf(")")+1)}else{return h}})+" "}return f+" "}))}})}}());(function(){if(!window.Event){window.Event=function(){}}function a(b,c){if(!Event.prototype[b]){Event.prototype[b]=c}}a("stopPropagation",function(){this.cancelBubble=true});a("preventDefault",function(){this.returnValue=false})}());(function(){if(!window.HTMLDocument){window.HTMLDocument=function(){}}if(!window.CSSStyleDeclaration){window.CSSStyleDeclaration=function(){}}function a(b,c){if(!HTMLDocument.prototype[b]){HTMLDocument.prototype[b]=c}}a("createElementNS",function(c,b){return this.createElement(b)})}());(function(){window.ArrayTools={get:function(d,b,a){var c=null;if(b===-1||b===(d.length-1)){c=d.slice(b)}else{c=d.slice(b,b+1)}return c.length?c[0]:a},set:function(d,a,c){if(a>=0){d[a]=c;return d}if(a>=-d.length){d.splice(a,1,c);return d}var b=[];b[-(d.length+a+1)]=c;Array.prototype.unshift.apply(d,b.reverse());return d},remove:function(b,a){return b.splice(a,1)[0]},sum:function(c,d,a){var b=0;c=(d!==undefined)?c.slice(d,a):c;c.forEach(function(e){b+=window.isNaN(e)?0:e});return b},swap:function(d,b,a){var c=this.get(d,a);var e=this.get(d,b);this.set(d,a,e);this.set(d,b,c);return d},};window.Generator=function(){this._getter=undefined;this._processor=undefined};Generator.prototype={_next:function(b,a,d){var c=this._getter?this._getter.bind(this)(b,a,d):b;if(c!==undefined&&this._processor){c=this._processor.bind(this)(c,a,d)}return c},get:function(a){if(a===undefined){return this._getter}if(typeof a==="number"){var c=a;this._getter=function(e,d,f){return ArrayTools.get(e,c)}}else{if(Object.isFunc(a)){this._getter=a}else{if(a!==null){var b=a;this._getter=function(e,d,f){return e[b]}}else{this._getter=undefined}}}return this},each:function(a){if(a===undefined){return this._processor}this._processor=Object.isFunc(a)?a:undefined;return this},iterator:function(){var a=this;return function(c,b,d){return a._next(c,b,d)}}};window.GeneratorTools={array:{swap:function(b,a){return function(e,c,d){return ArrayTools.swap(e.slice(),b,a)}},ratio:function(d,c,b,a){return function(g,e,f){var h=(ArrayTools.get(g,d,0)*b)/c;var i=g.slice();if(a!==undefined){i.splice(a,0,h)}else{ArrayTools.set(i,d,h)}return i}},format:function(b,a){return function(e,c,d){var f=e.slice();f.splice(a!==undefined?a:e.length,0,b.format(e));return f}}}}}());creme=window.creme||{};(function(a){creme.color=creme.color||{};creme.color.HEXtoRGB=function(b){var b=parseInt(((b.indexOf("#")>-1)?b.substring(1):b),16);return{r:b>>16,g:(b&65280)>>8,b:(b&255)}};creme.color.luminance=function(e,d,c){e=Math.pow(e/255,2.2);d=Math.pow(d/255,2.2);c=Math.pow(c/255,2.2);return 0.212671*e+0.71516*d+0.072169*c};creme.color.contrast=function(j,i,d,f,e,h){var c=creme.color.luminance(j,i,d);var k=creme.color.luminance(f,e,h);return(Math.max(c,k)+0.05)/(Math.min(c,k)+0.05)};creme.color.maxContrastingColor=function(h,f,d){var e=creme.color.contrast(h,f,d,255,255,255);var c=creme.color.contrast(h,f,d,0,0,0);if(e>c){return"white"}return"black"}}(jQuery));(function(a){creme.utils=creme.utils||{};creme.utils.openWindow=function(c,b,d){window[b]=window.open(c,b,d||"menubar=no, status=no, scrollbars=yes, menubar=no, width=800, height=600")};creme.utils.reload=function(b){var b=b||window;b.location.href=b.location.href};creme.utils.goTo=function(b,c){var c=c||window;c.location.href=b};creme.utils.showPageLoadOverlay=function(){creme.utils.loading("",false)};creme.utils.hidePageLoadOverlay=function(){creme.utils.loading("",true)};creme.utils.loading=function(d,b,f){var c=creme.utils._overlay;if(c===undefined){c=creme.utils._overlay=new creme.dialog.Overlay();c.bind(a("body")).addClass("page-loading").content(a("<h2>").append(a("<img>").attr("src",creme_media_url("images/wait.gif")),a("<span>").text(gettext("Loading..."))));c._loadstack=0}c._loadstack+=!b?1:-1;var e=c._loadstack>0;c.update(e,null,e?100:0)};creme.utils.showDialog=function(g,c,e){var b=a("#"+e);if(b.size()==0){var f=new Date();e=f.getTime().toString()+Math.ceil(Math.random()*1000000);b=a('<div id="'+e+'"  style="display:none;"></div>');a(document.body).append(b)}b.html(g);b.dialog(jQuery.extend({buttons:[{text:gettext("Ok"),click:function(){a(this).dialog("close")}}],closeOnEscape:false,title:"",modal:true,width:"auto",close:function(d,h){a(this).dialog("destroy");a(this).remove()}},c))};creme.utils.confirmBeforeGo=function(c,d,b){console.warn("creme.utils.confirmBeforeGo() is deprecated.");creme.dialogs.confirm(gettext("Are you sure ?")).onOk(function(){if(d){a.ajax(jQuery.extend({url:c,data:{},success:function(g,e,f){creme.utils.reload()},error:function(g,e,f){creme.dialogs.warning(g.responseText||gettext("Error")).open()},complete:function(e,f){},sync:false,parameters:undefined},b))}else{creme.utils.goTo(c)}}).open()};creme.utils.confirmSubmit=function(b,c){creme.dialogs.confirm(c||gettext("Are you sure ?")).onOk(function(){a("form",a(b)).submit()}).open()};if(typeof(creme.utils.stackedPopups)=="undefined"){creme.utils.stackedPopups=[]}creme.utils.showInnerPopup=function(f,e,h,c,g){var i=creme.object.isTrue(g);var e=e||{};var b=a("#"+h);if(b.size()==0){var j=new Date();h=j.getTime().toString()+Math.ceil(Math.random()*1000000);b=a('<div id="'+h+'"  style="display:none;"></div>');a(document.body).append(b)}f+=(f.indexOf("?")!=-1)?"&whoami="+h:"?whoami="+h;a.ajax(jQuery.extend({url:f,type:"GET",success:function(d){creme.utils.stackedPopups.push("#"+h);creme.utils.showDialog(d,jQuery.extend({buttons:[{text:gettext("Cancel"),click:function(){if(e!==undefined&&a.isFunction(e.cancel)){e.cancel(a(this))}creme.utils.closeDialog(a(this),i)}}],close:function(k,l){creme.utils.closeDialog(a(this),false)},open:function(o,p){var m=a(o.target);var l=a("[name=inner_body]",m).find("form");var q=e.send_button;creme.widget.ready(m);if(l.size()||q){var k;if(a.isFunction(q)){k=function(r){r.preventDefault();r.stopPropagation();q(m)}}else{k=function(r){r.preventDefault();r.stopPropagation();creme.utils.handleDialogSubmit(m)}}var n=m.dialog("option","buttons");n.unshift({text:e.send_button_label||gettext("Save"),click:k});m.dialog("option","buttons",n)}},closeOnEscape:e.closeOnEscape},e),h)},error:function(l,d,k){creme.dialogs.warning(l.responseText||gettext("Error during loading the page.")).open()}},c));return h};creme.utils.handleDialogSubmit=function(d){var e=d.attr("id");var c=a("[name=inner_body]",d).find("form");var b=a("[name=inner_header_from_url]",d).val();var f=c.serialize();if(f.length>0){f+="&"}f+="whoami="+e;a.ajax({type:c.attr("method"),url:b,data:f,beforeSend:function(g){creme.utils.loading("loading",false,{})},success:function(l,h){var m=l.startsWith('<div class="in-popup" closing="true"');if(!m){l+='<input type="hidden" name="whoami" value="'+e+'"/>';creme.widget.shutdown(d);a("[name=inner_body]","#"+e).html(l);creme.widget.ready(d);creme.utils.scrollTo(a(".errorlist:first",".non_field_errors"))}else{var j=a(l);var g=j.attr("redirect");var k=j.is("[force-reload]");var i=j.is("[delegate-reload]");if(g){creme.utils.closeDialog(d,k,undefined,callback_url)}else{if(!i){creme.utils.closeDialog(d,k)}else{d.dialog("close")}}}},error:function(i,g,h){creme.utils.showErrorNReload()},complete:function(g,h){creme.utils.loading("loading",true,{})}});return false};creme.utils.scrollTo=function(c){if(Object.isNone(c)===false){var d=a(".header-menu").outerHeight();var b=a.extend({left:0,top:0},a(c).position());scrollTo(b.left,b.top+d)}};creme.utils.closeDialog=function(c,d,e,b){a(c).dialog("destroy");creme.widget.shutdown(a(c));a(c).remove();creme.utils.stackedPopups.pop();if(a.isFunction(e)){e()}if(b!=undefined){document.location=b}else{if(d){creme.utils.reloadDialog(creme.utils.stackedPopups[creme.utils.stackedPopups.length-1]||window)}}};creme.utils.reloadDialog=function(c){if(c==window){creme.utils.reload(window);return}var b=a(c).find("[name=inner_header_from_url]").val();var d=a(c).find("[name=whoami]").val();b+=(b.indexOf("?")!=-1)?"&whoami="+d:"?whoami="+d;a.get(b,function(e){a(c).html(e)})};creme.utils.appendInUrl=function(e,g){var b=e.indexOf("?");var d="",c="";if(b>-1){d=e.substring(b,e.length);e=e.substring(0,b)}var f=e.indexOf("#");if(f>-1){c=e.substring(f,e.length);e=e.substring(0,f)}if(g.indexOf("?")>-1){e+=g+d.replace("?","&")}else{if(g.indexOf("&")>-1){e+=d+g}else{e+=g+d}}return e+c};creme.utils.openQuickForms=function(b){console.warn("creme.utils.openQuickForms() is deprecated.");var e="/creme_core/quickforms/%s/%s";var c=a('[name="ct_id"]',b).val();var d=a('[name="entity_count"]',b).val();creme.dialogs.form(e.format(c,d),{reloadOnSuccess:true}).open()};creme.utils.showErrorNReload=function(){creme.dialogs.warning("<p><b>"+gettext("Error !")+"</b></p><p>"+gettext("The page will be reload !")+"</p>").open();setTimeout(creme.utils.reload,3000)};creme.utils.confirmPOSTQuery=function(c,b,d){return creme.utils.confirmAjaxQuery(c,a.extend({action:"post"},b),d)};creme.utils.confirmAjaxQuery=function(c,b,f){var b=a.extend({action:"get",warnOnFail:true},b||{});var d=b.confirm||gettext("Are you sure ?");var e=new creme.component.Action(function(){var g=this;var h=creme.ajax.query(c,b,f);h.onFail(function(l,j,i){if(b.warnOnFail){var k=Object.isType(j,"string")?j:(j.message||gettext("Error"));creme.dialogs.error(k,{title:b.warnOnFailTitle},i).onClose(function(){g.fail(j,i)}).open()}else{g.fail(j,i)}}).onDone(function(j,i){if(b.messageOnSuccess){creme.dialogs.html("<p>%s</p>".format(b.messageOnSuccess)).onClose(function(){g.done(i)}).open()}else{g.done(i)}});if(b.waitingOverlay){h.onStart(function(){creme.utils.showPageLoadOverlay()});h.onComplete(function(){creme.utils.hidePageLoadOverlay()})}creme.dialogs.confirm("<h4>%s</h4>".format(d)).onOk(function(){h.start()}).onClose(function(){g.cancel()}).open({width:250,height:150})},b);if(b.reloadOnSuccess){e.onDone(function(g,h){creme.utils.reload()})}return e};creme.utils.ajaxQuery=function(c,b,e){var b=a.extend({action:"get",warnOnFail:true},b||{});var d=creme.ajax.query(c,b,e);if(b.warnOnFail){d.onFail(function(i,g,f){var h=Object.isType(g,"string")?g:(g.message||gettext("Error"));creme.dialogs.error(h,{title:b.warnOnFailTitle},f).onClose(function(){if(b.reloadOnFail){creme.utils.reload()}}).open()})}else{if(b.reloadOnFail){d.onFail(function(f,g){creme.utils.reload()})}}if(b.messageOnSuccess){d.onDone(function(f,g){creme.dialogs.html("<p>%s</p>".format(b.messageOnSuccess)).onClose(function(){if(b.reloadOnSuccess){creme.utils.reload()}}).open()})}else{if(b.reloadOnSuccess){d.onDone(function(f,g){creme.utils.reload()})}}if(b.waitingOverlay){d.onStart(function(){creme.utils.showPageLoadOverlay()});d.onComplete(function(){creme.utils.hidePageLoadOverlay()})}return d};creme.utils.innerPopupFormAction=function(c,b,d){var b=a.extend({submit_label:gettext("Save"),submit:function(e){creme.utils.handleDialogSubmit(e)},reloadOnSuccess:false},b||{});return new creme.component.Action(function(){var e=this;creme.utils.showInnerPopup(c,{send_button_label:b.submit_label,send_button:function(f){try{var g=b.submit.apply(this,arguments);if(g&&Object.isFunc(b.validator)&&b.validator(g)){e.done(g);creme.utils.closeDialog(f,b.reloadOnSuccess)}}catch(h){e.fail(h)}},cancel:function(f,g){e.cancel()},close:function(f,g){creme.utils.closeDialog(a(this),false);e.done()},closeOnEscape:b.closeOnEscape},null,{error:function(h,f,g){try{creme.dialogs.warning(gettext("Error during loading the page.")).open();e.fail(h,f,g)}catch(i){e.fail(h,f,g)}},data:d})})};creme.utils.isHTMLDataType=function(c){if(!c||!Object.isString(c)){return false}var b=c.toLowerCase();return b=="html"||b=="text/html"};creme.utils.debounce=function(c,e,b){var d;return function(){var i=this,h=arguments;var g=function(){d=null;if(!b){c.apply(i,h)}};var f=b&&!d;clearTimeout(d);d=setTimeout(g,e);if(f){c.apply(i,h)}}}}(jQuery));(function(a){creme.forms={};creme.forms.Select={};creme.forms.Select.optionsFromData=function(d,h,i){var l=[];i=(i!==undefined)?i:0;h=(h!==undefined)?h:1;var c=function(m){if(Object.isFunc("function")){return m}return function(n){return n[m]}};var f=c(h);var e=c(i);for(var g=0;g<d.length;++g){var j=d[g];var b=e(j);var k=f(j);if((b===undefined)||(k===undefined)){continue}l.push([b,k])}return l};creme.forms.Select.fill=function(i,k,c){if((i===undefined)||(k===undefined)){return}var f=i.val();var g,e;i.empty();for(e=0;e<k.length;++e){var h=k[e];var b=h[0];var j=h[1];var d=a("<option/>").val(b).text(j);if(b===c){d.attr("selected","selected");g=c}i.append(d)}if(g===undefined){if(k.length>0){g=k[0][0]}if(f!==undefined){for(e=0;e<k.length;++e){if(k[e][0]===f){g=f;break}}}}i.val(g);i.change();return i};creme.forms.TimePicker={};creme.forms.TimePicker.init=function(b){var c=creme.forms.TimePicker.timeval(b);a('li.hour input[type="text"]',b).val(c.hour);a('li.minute input[type="text"]',b).val(c.minute);a('li input[type="text"]',b).bind("change",function(){creme.forms.TimePicker.update(b)});a("li button",b).bind("click",function(){var d=new Date();creme.forms.TimePicker.set(b,d.getHours(),d.getMinutes())})};creme.forms.TimePicker.parseTime=function(d){var c=(d!==undefined)?d.split(":"):[];var b=(c.length>1)?c[0]:"";var e=(c.length>1)?c[1]:"";return{hour:b,minute:e}};creme.forms.TimePicker.val=function(b){return a('input[type="hidden"]',b).val()};creme.forms.TimePicker.timeval=function(b){return creme.forms.TimePicker.parseTime(a('input[type="hidden"]',b).val())};creme.forms.TimePicker.update=function(c){var b=a('li.hour input[type="text"]',c).val();var d=a('li.minute input[type="text"]',c).val();a('input[type="hidden"]',c).val(b+":"+d)};creme.forms.TimePicker.clear=function(b){a('li.hour input[type="text"]',b).val("");a('li.minute input[type="text"]',b).val("");a('input[type="hidden"]',b).val("")};creme.forms.TimePicker.set=function(c,b,d){a('li.hour input[type="text"]',c).val(b);a('li.minute input[type="text"]',c).val(d);a('input[type="hidden"]',c).val(b+":"+d)};creme.forms.DateTimePicker={};creme.forms.DateTimePicker.init=function(b,c){c=c||"yy-mm-dd";var d=creme.forms.DateTimePicker.datetimeval(b);a('li.date input[type="text"]',b).val(d.date);a('li.hour input[type="text"]',b).val(d.hour);a('li.minute input[type="text"]',b).val(d.minute);a('li input[type="text"]',b).bind("change propertychange keyup input paste",function(){creme.forms.DateTimePicker.update(b)});a("li.now button",b).bind("click",function(f){f.preventDefault();creme.forms.DateTimePicker.setDate(b,new Date())});a("li.clear button",b).bind("click",function(f){f.preventDefault();creme.forms.DateTimePicker.clear(b)});a('li.date input[type="text"]',b).datepicker({dateFormat:c,showOn:"button",buttonText:gettext("Calendar"),buttonImage:creme_media_url("images/icon_calendar.gif"),buttonImageOnly:true})};creme.forms.DateTimePicker.val=function(b){return a('input[type="hidden"]',b).val()};creme.forms.DateTimePicker.datetimeval=function(b){return creme.forms.DateTimePicker.parseDateTime(a('input[type="hidden"]',b).val())};creme.forms.DateTimePicker.parseDateTime=function(d){var b=(d!==undefined)?d.split(" "):[];var c=(b.length>1)?b[0]:"";var e=creme.forms.TimePicker.parseTime((b.length>1)?b[1]:"");return a.extend({date:c},e)};creme.forms.DateTimePicker.update=function(c){var d=a('li.date input[type="text"]',c).val();var b=a('li.hour input[type="text"]',c).val();var e=a('li.minute input[type="text"]',c).val();a('input[type="hidden"]',c).val(d+" "+b+":"+e)};creme.forms.DateTimePicker.clear=function(b){a('li.date input[type="text"]',b).val("");a('li.hour input[type="text"]',b).val("");a('li.minute input[type="text"]',b).val("");a('input[type="hidden"]',b).val("")};creme.forms.DateTimePicker.setDate=function(c,d){var b=d.getHours();var e=d.getMinutes();a('li.date input[type="text"]',c).datepicker("setDate",d);a('li.hour input[type="text"]',c).val(b);a('li.minute input[type="text"]',c).val(e);creme.forms.DateTimePicker.update(c)};creme.forms.DateTimePicker.set=function(d,e,f,c,b,g){creme.forms.DateTimePicker.setDate(d,new Date(e,f,c,b,g))};creme.forms._toDualColumnMultiSelect=function(f,q,y,m,t){var I=a('<div class="dcms_div"></div>');var F=a("#"+f);var C=a('<ul name="available"></ul>');var s=a('<ul name="chosen"></ul>');var G='<input class="dcms_button" type="button"/>';var v=a(G).attr("value",gettext("Add"));var g=a(G).attr("value",gettext("Remove"));var w=a(G).attr("value",gettext("Add all"));var c=a(G).attr("value",gettext("Remove all"));var l=a(G).attr("value",gettext("Up"));var z=a(G).attr("value",gettext("Down"));if(!q){l.css("display","none");z.css("display","none")}function e(){I.find(".dcms_focused").removeClass("dcms_focused")}function D(L,K,M){var N=a("<li></li>").attr("name",K).append(L).click(E).dblclick(k);if(M){N.hide()}C.append(N)}function d(L,K){s.append(a("<li></li>").attr("name",K).append(L).click(p).dblclick(j))}function n(N){if(N===undefined){v.attr("disabled","disabled");g.attr("disabled","disabled");l.attr("disabled","disabled");z.attr("disabled","disabled")}else{var M=N.parent();if(M.attr("name")==="chosen"){v.attr("disabled","disabled");g.removeAttr("disabled");var L=N.attr("name");if(L===s.find("li:first").attr("name")){l.attr("disabled","disabled")}else{l.removeAttr("disabled")}if(L===s.find("li:last").attr("name")){z.attr("disabled","disabled")}else{z.removeAttr("disabled")}}else{v.removeAttr("disabled");g.attr("disabled","disabled");l.attr("disabled","disabled");z.attr("disabled","disabled")}}var K=s.find("li").size();if(K===0){c.attr("disabled","disabled")}else{c.removeAttr("disabled")}if((C.find("li").size()-K)===0){w.attr("disabled","disabled")}else{w.removeAttr("disabled")}}function B(K){m(F,s);n(K)}function k(){var K=C.find(".dcms_focused");d(K.html(),K.attr("name"));K.hide();B()}function A(){C.find("li").each(function(){var K=a(this).attr("name");if(s.find('li[name="'+K+'"]').size()===0){d(a(this).html(),K);a(this).hide()}});B()}function j(){var K=s.find(".dcms_focused");C.find('[name="'+K.attr("name")+'"]').show();K.remove();B()}function x(){s.empty();C.find("li").each(function(){a(this).show()});B()}function H(){var L=s.find(".dcms_focused");var K=s.find(".dcms_focused").prev();L.insertBefore(K);B(L)}function J(){var L=s.find(".dcms_focused");var K=s.find(".dcms_focused").next();L.insertAfter(K);B(L)}function E(){e();a(this).addClass("dcms_focused");n(a(this))}function p(){e();a(this).addClass("dcms_focused");n(a(this))}function o(){a(".buttons a",b).toggleClass("view_more view_less");b.toggleClass("reduced")}y(F,D,d);var i=a("<div></div>").append(v.click(k)).append(g.click(j)).append("<br/>").append(w.click(A)).append(c.click(x)).append("<br/>").append(l.click(H)).append(z.click(J));n();F.css("display","none");F.replaceWith(I);var b=a("<table></table>");var h=a('<div class="buttons"></div>').append(a('<a class="view_less"></a>').click(o));a("<tbody></tbody>").appendTo(b).append(a('<tr class="header"></tr>').append(a('<th width="3%"></th>').append(h)).append(a('<th class="available more"></th>').append(gettext("Available"))).append(a('<th class="buttons more"></th>')).append(a('<th class="chosen more"></th>').append(gettext("Chosen"))).append(a('<th class="less"></th>').append(gettext("Select")))).append(a('<tr class="content"></tr>').append(a("<td></td>")).append(a('<td class="available"></td>').append(C)).append(a('<td class="buttons"></td>').append(i)).append(a('<td class="chosen"></td>').append(s)));I.append(F).append(b);var r=Math.max(C.height()+s.height(),i.height());if(r!==0){s.height(r);C.height(r);var u=Math.max(C.width(),s.width());s.width(u);C.width(u)}else{s.css("min-height",200);C.css("min-height",200)}if(t===true){o()}};creme.forms.toOrderedMultiSelect=function(e,b){function d(f,j,h){var k=[];f.find("tr").each(function(m){var p=a(this);var o=p.find(".oms_check").is(":checked");var l=p.find(".oms_value").html();var n="oms_row_"+m;if(o===true){j(l,n,true);k.push([p.find(".oms_order").attr("value"),l,n])}else{j(l,n,false)}});k.sort(function(l,i){return l[0]-i[0]});for(var g=0;g<k.length;++g){h(k[g][1],k[g][2])}}function c(g,h){var f={};h.find("li").each(function(j){f[a(this).attr("name")]=j+1});g.find("tr").each(function(k){var l=a(this);var j=f[l.attr("name")];if(j!==undefined){l.find(".oms_check").prop("checked",true);l.find(".oms_order").attr("value",j)}else{l.find(".oms_check").prop("checked",false);l.find(".oms_order").attr("value","")}})}creme.forms._toDualColumnMultiSelect(e,true,d,c,b)};creme.forms.toImportField=function(h,e){var d=a("#"+h);var f=d.find(".csv_col_select");var b=d.find(e);function g(){return f.find('[value="0"]').attr("selected")}if(g()){b.hide()}function c(){if(g()){b.hide("normal")}else{b.show("normal")}}f.change(c)};creme.forms.initialize=function(b){if(b.is(":not(.is-form-active)")){b.addClass("is-form-active");a("input,select,textarea",b).on("invalid",function(c){this.scrollIntoView(false);a(c.target).addClass("is-field-invalid")});b.on("click",'[type="submit"]',function(f){var c=a(this);if(c.is("[data-no-validate]")){b.attr("novalidate","novalidate")}var d=Object.isEmpty(b.validateHTML5());if(d===true){if(c.is(":not(.is-form-submit)")){c.addClass("is-form-submit")}else{f.preventDefault()}}}).submit(function(){b.find('[type="submit"]').addClass("is-form-submit")});creme.utils.scrollTo(a(".errorlist:first, .non_field_errors",b))}};creme.forms.validateHtml5Field=function(d,b){b=b||{};var e={};if(b.noValidate||d.is("[novalidate]")){return e}if(d.is(":invalid")){var c=d.get(0).validationMessage||"";e[a(d).prop("name")]=c;d.addClass("is-field-invalid");d.trigger("html5-invalid",[true,c])}else{d.removeClass("is-field-invalid");d.trigger("html5-invalid",[false])}return e};creme.forms.validateHtml5Form=function(d,b){b=b||{};var e={};var c={noValidate:b.noValidate||d.is("[novalidate]")};a("input, select, textarea, datalist, output",d).each(function(){a.extend(e,creme.forms.validateHtml5Field(a(this),c))});return e}}(jQuery));(function(a){a(document).ajaxSend(function(d,e,c){function b(f){var k=null;if(Object.isEmpty(document.cookie)===false){var j=document.cookie.split(";");for(var h=0;h<j.length;h++){var g=jQuery.trim(j[h]);if(g.substring(0,f.length+1)===(f+"=")){k=decodeURIComponent(g.substring(f.length+1));break}}}return k}if(!(/^http:.*/.test(c.url)||/^https:.*/.test(c.url))){e.setRequestHeader("X-CSRFToken",b("csrftoken"))}});jQuery.ajaxSettings.traditional=true;creme.ajax=creme.ajax||{};creme.ajax.submit=function(e,f,c){var b=a(e);var g={method:b.attr("method"),action:(b.attr("action")==="")?window.location.href:b.attr("action"),async:true,cache:true,beforeSend:null,success:null,beforeError:null,beforeComplete:null,error:function(){creme.utils.showErrorNReload()},afterError:null,complete:null};var d=a.extend(g,c);if(f===true){f=b.serialize()}a.ajax({url:d.action,type:d.method,data:f,async:d.async,beforeSend:function(h){creme.utils.loading("loading",false,{});if(d.beforeSend){d.beforeSend(h)}},success:function(i,h){if(d.success){d.success(i,h)}},error:function(j,h,i){if(d.beforeError){d.beforeError(j,h,i)}if(d.error){d.error(j,h,i)}if(d.afterError){d.afterError(j,h,i)}},complete:function(i,h){if(d.beforeComplete){d.beforeComplete(i,h)}creme.utils.loading("loading",true,{});if(d.complete){d.complete(i,h)}}})};creme.ajax.ajax=function(b){b=a.extend({type:"GET",url:"",async:true,data:{},dataType:"html",cache:true,beforeSend:null,success:null,beforeError:null,beforeComplete:null,error:function(){creme.utils.showErrorNReload()},afterError:null,complete:null},b);a.ajax({url:b.url,type:b.type,data:b.data,async:b.async,dataType:b.dataType,beforeSend:function(c){creme.utils.loading("loading",false,{});if(b.beforeSend&&a.isFunction(b.beforeSend)){b.beforeSend(c)}},success:function(d,c){if(b.success&&a.isFunction(b.success)){b.success(d,c)}},error:function(e,c,d){if(b.beforeError&&a.isFunction(b.beforeError)){b.beforeError(e,c,d)}if(b.error&&a.isFunction(b.error)){b.error(e,c,d)}if(b.afterError&&a.isFunction(b.afterError)){b.afterError(e,c,d)}},complete:function(d,c){if(b.beforeComplete){b.beforeComplete(d,c)}creme.utils.loading("loading",true,{});if(b.complete){b.complete(d,c)}}})};creme.ajax.get=function(b){creme.ajax.ajax(a.extend({type:"GET"},b))};creme.ajax.post=function(b){creme.ajax.ajax(a.extend({type:"POST"},b))};creme.ajax.reloadContent=function(b,c){creme.ajax.get({url:c,success:function(d){b.empty().html(d)}})};creme.ajax.json={};creme.ajax.json._handleSendError=function(c,e,d){var b;switch(e){case"parsererror":b="JSON parse error";break;default:b=String(c.status)+" "+c.statusText}return{type:"request",status:c.status,request:c,message:b}};creme.ajax.json.send=function(d,h,b,g,f,i,e){var c={async:!f,type:i,url:d,data:h!==undefined?h:"",dataType:"json",success:function(j,k){if(Object.isFunc(b)){b(j,k)}},error:function(j,l,k){if(Object.isFunc(g)){g(j.responseText,creme.ajax.json._handleSendError(j,l,k))}}};if(e!==undefined){c=a.extend(c,e)}a.ajax(c)};creme.ajax.json.post=function(c,g,b,f,e,d){creme.ajax.json.send(c,g,b,f,e,"POST",d)};creme.ajax.json.get=function(c,g,b,f,e,d){creme.ajax.json.send(c,g,b,f,e,"GET",d)};creme.ajax.json.isvalid=function(b){return Object.isString(b)&&/^[\],:{}\s]*$/.test(b.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))};creme.ajax.json.parse=function(c){if(!c||!Object.isString(c)){return null}c=c.trim();if(creme.ajax.json.isvalid(c)){try{if(window.JSON&&window.JSON.parse){return window.JSON.parse(c)}else{return a.parseJSON(c)}}catch(b){return null}}else{return null}};creme.ajax.json.ajaxFormSubmit=function(c,b,f,e,d){creme.ajax.json.post(c.attr("action"),c.serialize(),b||function(g){c.html(g.form)},f,e,d)}}(jQuery));(function(a){creme.object={invoke:function(){if(arguments.length===0){return}var b=arguments[0];if(Object.isFunc(b)){return b.apply(this,Array.copy(arguments,1))}},delegate:function(){if(arguments.length<2){return}var c=arguments[0];var b=arguments[1];if(Object.isEmpty(c)||typeof c!=="object"){return}if(Object.isString(b)){b=c[b]}if(Object.isFunc(b)){return b.apply(c,Array.copy(arguments,2))}},build_callback:function(b,c){return creme.utils.lambda(b,c)},deferred_start:function(f,d,h,c){var e="deferred__"+d;var g=f.data(e);if(g!==undefined){g.reject()}var b=a.Deferred();a.when(b.promise()).then(function(i){f.removeData(e);creme.object.invoke(h,f,i)},null,null);f.data(e,b);if(c){window.setTimeout(function(){b.resolve()},c)}else{b.resolve()}return b},deferred_cancel:function(d,b){var c="deferred__"+b;var e=d.data(c);if(e!==undefined){d.removeData(c);e.reject()}return e},uuid:function(){return a.uidGen({prefix:"jqplot_target_",mode:"random"})},isFalse:function(b){return Object.isNone(b)||b===false},isTrue:function(b){return !Object.isNone(b)&&b!==false}};creme.widget={};creme.widget.Widget=function(){return{options:{},arguments:{},_create:function(d,c,b,e){},_destroy:function(b){},destroy:function(b){creme.widget.destroy(b)},isActive:function(b){return creme.widget.is_valid(b)},cleanedval:function(b){if(!this.isActive(b)){return null}var c=b.creme().widget().val();return creme.widget.cleanval(c,c)}}};a.extend(creme.widget,{_widgets:{},ready:function(b){var c=creme.widget;a(".ui-creme-widget.widget-auto",b).each(function(){c.create(a(this))})},shutdown:function(b){var c=creme.widget;a(".ui-creme-widget.widget-ready",b).each(function(){c.destroy(a(this))})},register:function(b,c){creme.widget._widgets[b]=c},unregister:function(b){if(creme.widget._widgets[b]!==undefined){delete creme.widget._widgets[b]}},find:function(b){return creme.widget._widgets[b]},proxy:function(b,c){if(Object.isNone(c)){return}var d={element:b,delegate:c,options:function(){return this.delegate.options},arguments:function(){return this.delegate.arguments}};(function(e){a.each(e.delegate,function(f,g){if(typeof g!=="function"||f.match("^_.*")!==null){return}e[f]=function(){return g.apply(e.delegate,[e.element].concat(Array.copy(arguments)))}})})(d);return d},create:function(e,c,b,g){if(e.data("CremeWidget")!==undefined){return}var h=creme.widget.find(e.attr("widget"));if(typeof h!=="object"){return}var f=a.extend({},h);f.options=creme.widget.parseopt(e,h.options,c);f.arguments=creme.widget.parseattr(e,a.extend({widget:"","class":""},f.options));var d=creme.widget.proxy(e,f);e.data("CremeWidget",d);e.addClass("widget-active");f._create(e,f.options,b,g,f.arguments);return d},destroy:function(b){if(!creme.widget.is_valid(b)){return b}b.data("CremeWidget").delegate._destroy(b);b.removeData("CremeWidget");b.removeClass("widget-ready widget-active");return b},declare:function(c,b,d){var e=a.extend(new creme.widget.Widget(),d,b);creme.widget.register(c,e);return e},template:function(h,k){if(h===undefined||k===undefined){return h}var c=h.match(/\$\{[\w\d]+\}/g);if(c===null){return h}var d=""+h;var e;if(typeof k!=="function"){e=function(i){return k[i]}}else{e=k}for(var b=0;b<c.length;b++){var g=c[b];var j=g.slice(2,-1);var f=e(j);if(f!==undefined){d=d.replace(g,e(j))}}return d},parseattr:function(f,g){var d={};var e;if(f.length===0){return d}for(e=0;e<f[0].attributes.length;++e){var b=f[0].attributes[e];d[b.name]=b.value}g=g||[];if(a.isArray(g)){for(e in g){if(d[g[e]]!==undefined){delete d[g[e]]}}}else{for(var c in g){if(d[c]!==undefined){delete d[c]}}}return d},parseopt:function(c,e,b){var d={};Object.keys(e||{}).forEach(function(f){var g=c.attr(f);if(g!==undefined){d[f]=c.attr(f)}});d=a.extend({},e,d,b);return d},parseval:function(b,c){if((b!==undefined)&&(typeof b==="string")&&(c!==undefined)){return c(b)}return b},cleanval:function(e,c,f){var d=(f!==undefined)?f:creme.ajax.json.parse;var b=(typeof e==="object")?e:creme.widget.parseval(e,d);return(b!==null&&b!==undefined)?b:c},val:function(b,d){var c=a(b).creme().widget()||a(b);if(d===undefined){return c.val()}return c.val(d)},values_list:function(d,c,e){var b;if(c===undefined){b=[];d.each(function(){b.push(creme.widget.val(a(this)))});return b}b=creme.widget.parseval(c,e);b=(b===null)?"":b;b=(!a.isArray(b))?[b]:b;d.each(function(f,g){var h=(f<b.length)?b[f]:"";creme.widget.val(g,h)})},input:function(c){var d="input.ui-creme-input."+a(c).attr("widget");var b=a("input.ui-creme-input."+a(c).attr("widget"),c);if(a(c).is(d)){b.push(c)}return b},is_valid:function(b){if(Object.isEmpty(b)){return false}return Object.isFunc(b.data)&&!Object.isNone(b.data("CremeWidget"))},writeAttr:function(d,b){for(var c in b){var e=b[c];if(e!==undefined){d.attr(c,e)}}return d},buildTag:function(c,d,b,e){c.addClass("ui-creme-widget").addClass(d).attr("widget",d);if(e===true){c.addClass("widget-auto")}if(Object.isEmpty(b)){return c}return this.writeAttr(c,b)}});a.fn.creme=function(){var b=a(this);return{widget:function(){return b.data("CremeWidget")},create:function(d,c,e){creme.widget.create(b,d,c,e)},destroy:function(){creme.widget.destroy(b)},isActive:function(){return creme.widget.is_valid(b)}}};a(document).ready(function(){creme.widget.ready()})}(jQuery));(function(a){creme.component={};creme.component.extend=function(c,e){c=c||Object;e=e||{};var d=function(){this._init_.apply(this,arguments)};d.prototype=new c();d.__super__=c.prototype;d.prototype.constructor=d;d.prototype._init_=c.prototype._init_||function(){};d.sub=function(f){return creme.component.extend(d,f)};for(var b in e){d.prototype[b]=e[b]}return d};creme.component.Component=creme.component.extend(Object,{_init_:function(){},_super_:function(b,c){if(c!==undefined){return b.prototype[c].apply(this,Array.copy(arguments).slice(2))}return Object.proxy(b.prototype,this)},is:function(b){return Object.isSubClassOf(this,b)}})}(jQuery));(function(b){var a=function(){};creme.component.EventHandler=creme.component.Component.sub({_init_:function(){this._listeners={};this._error=a},on:function(d,e,c){return this.bind(d,e,c)},off:function(c,d){return this.unbind(c,d)},one:function(e,f,d){var c=this;if(Object.isFunc(d)){return this.bind(e,f,function(h,i,g){c.unbind(h,i);return d.apply(this,[h,i,g])})}return this.bind(e,f,function(h,i,g){c.unbind(h,i);return i.apply(this,g)})},bind:function(g,i,e){var d=this;if(Array.isArray(g)){g.forEach(function(j){d.bind(j,i,e)});return this}if(typeof g==="object"){for(var c in g){this.bind(c,g[c],e)}return this}if(typeof g==="string"&&g.indexOf(" ")!==-1){return this.bind(g.split(" "),i,e)}if(Array.isArray(i)){i.forEach(function(j){d.bind(g,j,e)});return this}if(Object.isFunc(i)===false){throw new Error('unable to bind event "'+g+'", listener is not a function')}var h=this.listeners(g);i.__eventuuid__=i.__eventuuid__||b.uidGen();if(Object.isFunc(e)){var f=(function(k,l,j){return function(){return j.apply(this,[k,l,Array.copy(arguments)])}})(g,i,e);f.__eventuuid__=i.__eventuuid__;h.push(f)}else{h.push(i)}this._listeners[g]=h;return this},unbind:function(e,g){var d=this;if(Array.isArray(e)){e.forEach(function(h){d.unbind(h,g)});return this}if(typeof e==="object"){for(var c in e){this.unbind(c,e[c])}return this}if(typeof e==="string"&&e.indexOf(" ")!==-1){return this.unbind(e.split(" "),g)}var f=this.listeners(e);if(g===undefined){f.splice(0,f.length);return this}if(Array.isArray(g)){g.forEach(function(h){d._remove(f,h)})}else{this._remove(f,g)}return this},_remove:function(d,f){var c=0;while(c<d.length){var e=d[c];if(e&&e.__eventuuid__!==undefined&&(e.__eventuuid__===f.__eventuuid__)){d.splice(c,1)}else{++c}}},error:function(c){if(c===undefined){return this._error}if(c===null){this._error=a;return this}if(Object.isFunc(c)===false){throw new Error("event error handler is not a function")}this._error=c;return this},listeners:function(c){return this._listeners[c]||[]},trigger:function(e,g,f){f=f||this;g=Array.isArray(g)?g:(g!==undefined?[g]:[]);var d=[e].concat(g);var c=this._error.bind(f);Array.copy(this.listeners(e)).forEach(function(h){try{h.apply(f,d)}catch(i){console.error(e,g,h,i,f);c(i,e,g,h)}})}})}(jQuery));(function(a){creme.component.ActionStatus={DONE:"done",RUNNING:"run",FAIL:"fail",CANCEL:"cancel"};var b=creme.component.ActionStatus;creme.component.Action=creme.component.Component.sub({_init_:function(d,c){this._events=new creme.component.EventHandler();this._options=c||{};this._status=b.DONE;this._action=Object.isFunc(d)?d:this.done},start:function(){if(this.isRunning()===true){return this}try{this._events.trigger("start",Array.copy(arguments),this);this._status=b.RUNNING;this._action.apply(this,Array.copy(arguments))}catch(c){console.error(c);this.fail(c)}return this},done:function(){if(this.isRunning()===false){return this}this._status=b.DONE;this._events.trigger("done",Array.copy(arguments),this);return this},fail:function(){if(this.isRunning()===false){return this}this._status=b.FAIL;this._events.trigger("fail",Array.copy(arguments),this);return this},cancel:function(){if(this.isRunning()===false){return this}this._status=b.CANCEL;this._events.trigger("cancel",Array.copy(arguments),this);return this},trigger:function(c){this._events.trigger(c,Array.copy(arguments).slice(1),this);return this},action:function(e){var c=this;var d=(e===undefined||Object.isFunc(e))?e:function(){c.done(e)};return Object.property(this,"_action",d)},one:function(d,e,c){this._events.one(d,e,c);return this},on:function(d,e,c){return this.bind(d,e,c)},off:function(c,d){return this.unbind(c,d)},bind:function(d,e,c){this._events.bind(d,e,c);return this},unbind:function(c,d){this._events.unbind(c,d);return this},onStart:function(c){return this.bind("start",c)},onComplete:function(c){return this.bind("done fail cancel",c)},onDone:function(c){return this.bind("done",c)},onCancel:function(c){return this.bind("cancel",c)},onFail:function(c){return this.bind("fail",c)},isRunning:function(){return this._status===b.RUNNING},status:function(){return this._status},options:function(c){return Object.property(this,"_options",c)},listen:function(c){return this.after(c)},after:function(d){var c=this;d.onDone(function(e,f){c.start(f)});d.onFail(function(e,f){c._status=b.FAIL;c._events.trigger("fail",f,c)});d.onCancel(function(e,f){c._status=b.CANCEL;c._events.trigger("cancel",f,c)});return this},before:function(c){c.after(this);return this}});creme.component.TimeoutAction=creme.component.Action.sub({_init_:function(c){this._super_(creme.component.Action,"_init_",this._startTimeout,c)},_startTimeout:function(e){e=a.extend({},this.options(),e);var c=this;var d=e.delay||0;if(d>0){window.setTimeout(function(){if(c.isRunning()){c.done(e)}},d)}else{c.done(e)}}})}(jQuery));(function(a){creme.action=creme.action||{};creme.action.ActionLink=creme.component.Component.sub({_init_:function(b){this._options=a.extend({strict:false},b||{});this._running=false;this._events=new creme.component.EventHandler()},on:function(c,d,b){this._events.on(c,d,b);return this},off:function(b,c){this._events.off(b,c);return this},one:function(b,c){this._events.one(b,c)},onComplete:function(c,b){this.on("action-link-done action-link-cancel action-link-fail",c,b)},builders:function(b){return Object.property(this,"_builders",b)},trigger:function(b){this._events.trigger(b,Array.copy(arguments).slice(1),this);return this},isRunning:function(){return this._running===true},isBound:function(){return Object.isNone(this._button)===false},isDisabled:function(){return this.isBound()&&this._button.is(".is-disabled")},options:function(){return this._options},_getActionBuilder:function(b,d){try{var c=this.builders()||{};return Object.isFunc(c)?c(d):c["_action_"+d].bind(c)}catch(f){console.warn(f)}},_getActionData:function(b){try{return Object.isEmpty(b)?{}:JSON.parse(b)}catch(c){console.warn(c);return{}}},bind:function(f){if(this.isBound()){throw Error("action link is already bound")}var b=f.attr("href")||f.attr("data-action-url");var h=f.is(":not(.is-disabled)");var j=(f.attr("data-action")||"").replace(/\-/g,"_").toLowerCase();var l=this.isRunning.bind(this);var d=this.trigger.bind(this);var e=function(m){this._running=m;f.toggleClass("is-loading",m)}.bind(this);var i=this._getActionData(a("script:first",f).text());var g=this._getActionBuilder(f,j);var c=Object.isFunc(g);if(!c){if(this._options.strict){throw Error('no such action "'+j+'"')}else{console.warn(f,'no such action "'+j+'" with',i)}}if(c&&h){var k=function(n){n.preventDefault();n.stopPropagation();if(!l()){var m=g(b,i.options,i.data,n);if(Object.isNone(m)===false){d("action-link-start",b,i.options||{},i.data||{},n);e(true);m.onComplete(function(){e(false)}).on({error:function(r,o,q,p){d("action-link-error",Array.copy(arguments).slice(1),this)},done:function(){d("action-link-done",Array.copy(arguments).slice(1),this)},cancel:function(){d("action-link-cancel",Array.copy(arguments).slice(1),this)},fail:function(){d("action-link-fail",Array.copy(arguments).slice(1),this)}}).start()}}};f.click(k)}else{f.addClass("is-disabled");f.click(function(m){m.preventDefault();d("action-link-start");e(false);d("action-link-cancel",[]);return false})}this._button=f;return this}})}(jQuery));(function(a){creme.component.Chosen=creme.component.Component.sub({_init_:function(b){this.options=a.extend({multiple:false,sortable:false,allow_single_deselect:true,no_results_text:gettext("No result"),placeholder_text_multiple:gettext("Select some options"),placeholder_text_single:gettext("Select one option")},b||{})},isActive:function(){return this.chosen!==undefined},activate:function(d){if(this.isActive()){throw new Error("Chosen component is already active")}var c=this.options;var b=d.addClass("chzn-select").chosen(c);if(c.multiple&&c.sortable){this._activateSort(d)}this.chosen=b;this.element=d;return b},deactivate:function(){if(this.isActive()===false){return}var b=a("ul.chzn-choices:not(.sortable)",this.element.parent());if(this.options.sortable){b.sortable("destroy")}this.element.unchosen();this.element.removeClass("chzn-select chzn-done");this.chosen=undefined;this.element=undefined},refresh:function(){this.chosen.trigger("liszt:updated")},_querychoices:function(c,b){return a("option"+(b?'[value="'+b+'"]':""),c).filter(function(){return a(this).parents("select:first").is(c)})},_activateSort:function(d){var c=this;var b=a("ul.chzn-choices:not(.sortable)",d.parent());b.sortable({items:"li.search-choice",opacity:0.5,revert:200,delay:200,update:function(f,g){var e=[];var h=c._querychoices(d).map(function(){return a(this).attr("value")});a("li.search-choice a.search-choice-close",b).each(function(){var i=-1;try{i=parseInt(a(this).attr("rel"))}catch(j){}if(i>-1&&i<h.length){e.push(h[i])}});d.attr("sorted",e.join(","))}});b.addClass("sortable").disableSelection()}})}(jQuery));(function(a){creme.utils=creme.utils||{};creme.utils.TemplateRenderer=creme.component.Component.sub({tags:function(b){return[]},render:function(c,b){return c}});creme.utils.TemplateDefaultRenderer=creme.utils.TemplateRenderer.sub({_entrypattern:/\$\{([\w\d\\.^\\s]+)\}/g,_attributeGetter:function(f,c){var d=Array.isArray(c)?c:((typeof c==="string")?c.split("."):[c]);var e=f;for(var b in d){if(!Object.isNone(e)&&typeof e==="object"){e=e[d[b]]}else{e=undefined;break}e=Object.isFunc(e)?e(c):e}return e},tags:function(c){var d=c.match(this._entrypattern);var b={};if(Object.isEmpty(d)===false){d.forEach(function(e){b[e.slice(2,-1).split(".")[0]]=0;return 0})}return Object.keys(b)},render:function(d,c){if(Object.isEmpty(c)){return d}var b=this._attributeGetter.bind(this);return d.replace(this._entrypattern,function(e,f){var g=b(c,f);return g!==undefined?g:e})}});creme.utils.Template=creme.component.Component.sub({_init_:function(d,b,c){this.renderer(c||new creme.utils.TemplateDefaultRenderer());this.pattern(d);this.parameters(b)},_resolve:function(b){b=b||{};var d=this._parameters||{};var c={};if(Object.isFunc(d)){this.tags().forEach(function(e){c[e]=d(e)})}else{c=a.extend(c,d)}if(Object.isFunc(b)){this.tags().forEach(function(e){c[e]=b(e)})}else{c=a.extend(c,b)}return c},render:function(b){var d=this._renderer;var c=this._pattern;if(Object.isNone(d)||Object.isNone(c)){return null}return d.render(c,this._resolve(b))},tags:function(){return this._tags},_updateTags:function(){var c=this._renderer;var b=this._pattern;this._tags=(Object.isNone(c)||Object.isEmpty(b))?[]:c.tags(b)},iscomplete:function(){var b=this._tags;var d=this._resolve();for(var c=0;c<b.length;++c){if(Object.isNone(d[b[c]])){return false}}return true},renderer:function(b){if(b===undefined){return this._renderer}this._renderer=b;this._updateTags();return this},pattern:function(b){if(b===undefined){return this._pattern}this._pattern=b;this._updateTags();return this},parameters:function(b){return Object.property(this,"_parameters",b)},update:function(b){if(Array.isArray(b)){this.pattern(b[0]);this.parameters(b[1])}else{if(typeof b==="object"){this.parameters(a.extend({},this.parameters()||{},b))}else{if(typeof b==="string"){this.pattern(b)}}}return this}});creme.utils.templatize=function(d,b){var c;if(Object.isNone(d)){c=new creme.utils.Template()}if(Object.isType(d,"string")){c=new creme.utils.Template(d)}if(d!==null&&Object.isType(d,"object")&&Object.isFunc(d.is)&&d.is(creme.utils.Template)){c=d}return Object.isNone(b)?c:c.parameters(b)}}(jQuery));(function($){creme.utils=creme.utils||{};creme.utils.Lambda=creme.component.Component.sub({_init_:function(callable,parameters){this.lambda(callable,parameters)},isValid:function(){return !Object.isNone(this._lambda)},apply:function(context,parameters){if(this._lambda){return this._lambda.apply(context,parameters)}},call:function(){if(this._lambda){var args=Array.copy(arguments);return this._lambda.apply(args[0],args.slice(1))}},invoke:function(){return this._lambda?this._lambda.apply(this._context||{},arguments):undefined},constant:function(value){this._lambda=function(){return value};return this},lambda:function(callable,parameters){if(callable===undefined){return this._lambda}if(Object.isFunc(callable)){this._lambda=callable;return this}if(!Object.isType(callable,"string")){return this.constant(callable)}if(Object.isEmpty(callable)){throw Error("empty lambda script")}parameters=Array.isArray(parameters)?parameters.join(","):(parameters||"");var body=callable.indexOf("return")!==-1?callable:"return "+callable+";";if(!Object.isNone(window.Function)){this._lambda=new Function(parameters,body)}else{var uuid=$.uidGen({prefix:"__lambda_",mode:"random"});eval('creme.utils["'+uuid+'"] = function('+parameters+") {"+body+"};");this._lambda=creme.utils[uuid];delete creme.utils[uuid]}return this},callable:function(){if(this._lambda){return this._context?this._lambda.bind(this._context):this._lambda}},bind:function(context){this._context=context;return this}});creme.utils.lambda=function(callable,parameters,defaults){try{return new creme.utils.Lambda(callable,parameters).callable()}catch(e){if(defaults!==undefined){return defaults}else{throw e}}}}(jQuery));(function(a){creme.utils=creme.utils||{};creme.utils.ConverterRegistry=function(){this._init_()};creme.utils.ConverterRegistry.prototype={_init_:function(){this._converters={}},convert:function(h,g,c,f){if(h===g){return c}var b=this.converter(h,g);if(!Object.isFunc(b)){if(f!==undefined){return f}throw new Error('no such converter "'+h+"-"+g+'"')}try{return b.call(this,c)}catch(d){if(f!==undefined){return f}throw new Error('unable to convert data from "'+h+'" to "'+g+'" : '+(d.message||d))}},converter:function(c,b){return this._converters[c+"-"+b]},register:function(d,c,b){if(Object.isFunc(this.converter(d,c))){throw new Error('converter "'+d+"-"+c+'" is already registered')}this._converters[d+"-"+c]=b},unregister:function(c,b){if(this.converter(c,b)===undefined){throw new Error('no such converter "'+c+"-"+b+'"')}delete this._converters[c+"-"+b]}};creme.utils.converters=new creme.utils.ConverterRegistry();creme.utils.converter=a.proxy(creme.utils.converters.converter,creme.utils.converters);creme.utils.convert=a.proxy(creme.utils.converters.convert,creme.utils.converters);creme.utils.converters.register("string","number",function(c){Object.assertIsTypeOf(c,"string");var b=parseFloat(c);if(isNaN(b)){throw Error('"'+c+'" is not a number')}return b});creme.utils.converters.register("string","float",creme.utils.converter("string","number"));creme.utils.converters.register("string","int",function(c){Object.assertIsTypeOf(c,"string");var b=parseInt(c);if(isNaN(b)){throw Error('"'+c+'" is not a number')}return b})}(jQuery));(function(a){creme.utils=creme.utils||{};creme.utils.JSON=function(){};creme.utils.JSON.prototype={encode:function(b){if(window.JSON&&window.JSON.stringify){return window.JSON.stringify(b)}else{if(Object.isFunc(a.toJSON)){return a.toJSON(b)}}throw Error("not implemented !")},isJSON:function(b){return typeof b==="string"&&(/^[\],:{}\s]*$/.test(b.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))},decode:function(d,g){if(g!==undefined){try{return this.decode(d)}catch(f){return g}}if(typeof d!=="string"||!d){throw Error("Invalid data type or empty string")}d=a.trim(d);try{if(window.JSON&&window.JSON.parse){return window.JSON.parse(d)}}catch(c){throw Error("JSON parse error: "+c)}var b=this.isJSON(d);if(!b){throw Error("JSON parse error (fallback)")}try{return a.parseJSON(d)}catch(c){throw Error("JSON parse error (fallback): "+c)}}};creme.utils.JSON.decoder=function(c){var b=new creme.utils.JSON();return function(e,d){return b.decode(e,d||c)}};creme.utils.JSON.encoder=function(){return new creme.utils.JSON().encode};creme.utils.JSON.clean=function(b,c){return Object.isString(b)?new creme.utils.JSON().decode(b,c):b}}(jQuery));(function(a){creme.utils=creme.utils||{};creme.utils.comparator=function(){if(arguments.length===0){return creme.utils.compareTo}var b=Array.copy(arguments);return function(e,c){for(var h=0;h<b.length;++h){var g=b[h];var f=e[g],d=c[g];if(f===d){continue}return f<d?-1:1}return 0}};creme.utils.compareTo=function(d,c){return d<c?-1:(d>c?1:0)}}(jQuery));(function(b){creme.history=creme.history||{};var a=window.onpopstate;window.onpopstate=function(c){if(!c.state){if(Object.isFunc(a)){return a(c)}else{window.location=document.location}}else{window.location.href=c.state.url}};creme.history.push=function(c,d){var d=d||document.title;window.history.pushState({title:d,url:c},d,c)};creme.history.replace=function(c,d){var d=d||document.title;window.history.replaceState({title:d,url:c},d,c)}}(jQuery));(function(b){creme.ajax=creme.ajax||{};creme.ajax.Backend=function(c){this.options=b.extend({dataType:"html",sync:false,debug:false},c||{})};creme.ajax.Backend.prototype={get:function(e,g,h,c,d){var f=b.extend({method:"GET"},this.options,d);if(f.debug){console.log("creme.ajax.Backend > GET",e," > data:",g,", options:",f)}creme.ajax.jqueryAjaxSend(e,g,h,c,f)},post:function(e,g,h,c,d){var f=b.extend({method:"POST"},this.options,d,true);if(f.debug){console.log("creme.ajax.Backend > POST",e," > data:",g,", options:",f)}creme.ajax.jqueryAjaxSend(e,g,h,c,f)},submit:function(f,g,c,d){var e=b.extend({},this.options,d,true);if(e.debug){console.log("creme.ajax.Backend > SUBMIT",f.attr("action"),"> options:",e)}creme.ajax.jqueryFormSubmit(f,g,c,e)},query:function(c){return new creme.ajax.Query(c,this)}};creme.ajax.LOCALIZED_ERROR_MESSAGES={"0":gettext("Connection Refused"),"400":gettext("Bad Request"),"401":gettext("Unauthorized"),"403":gettext("Forbidden Access"),"404":gettext("Not Found"),"406":gettext("Not Acceptable"),"409":gettext("Conflict"),"500":gettext("Internal Error")};creme.ajax.localizedErrorMessage=function(e){var c=Object.isEmpty(e)?"200":(["number","string"].indexOf(typeof e)!==-1?e:(e.status||"200"));var d=creme.ajax.LOCALIZED_ERROR_MESSAGES[c];return d||(gettext("Error")+(c&&c!=="200"?" ("+c+")":""))};creme.ajax.XHR=function(c){return b.extend({aborted:0,responseText:"",responseXML:null,status:200,statusText:"n/a",getAllResponseHeaders:function(){},getResponseHeader:function(){},setRequestHeader:function(){},abort:function(d){}},c||{})};creme.ajax.AjaxResponse=function(c,d,e){return{type:"request",status:c,message:d,request:e||new creme.ajax.XHR({responseText:d,status:c})}};creme.ajax.cookieAttr=function(c){var g=null;if(Object.isEmpty(document.cookie)===false){var f=document.cookie.split(";");for(var e=0;e<f.length;e++){var d=jQuery.trim(f[e]);if(d.substring(0,c.length+1)===(c+"=")){g=decodeURIComponent(d.substring(c.length+1));break}}}return g};creme.ajax.cookieCSRF=function(){return creme.ajax.cookieAttr("csrftoken")};creme.ajax.serializeFormAsDict=function(f,d){d=d||{};var g={};var e=function(j,h,i){if(!Object.isEmpty(h)&&!Object.isNone(i)){if(j[h]===undefined){j[h]=Array.isArray(i)?i:[i]}else{if(Array.isArray(i)){j[h].extend(i)}else{j[h].push(i)}}}};b(f).serializeArray().forEach(function(h){e(g,h.name,h.value)});for(var c in d){e(g,c,d[c])}return g};creme.ajax.jqueryFormSubmit=function(h,c,g,f){f=f||{};var e=h.attr("action");var j=b("input[type=file]",h).length>0;h.attr("action",f.action||e);function d(k){if(/^HTTPError [0-9]+$/.test(k)){return parseInt(k.substr("HTTPError ".length))}else{return 200}}var i={iframe:j,success:function(l,m,n,k){k.attr("action",e);if(j&&n.status===0){n.status=d(l)}if(n.status===200){if(c!==undefined){c(l,m,n,k)}return}if(g!==undefined){g(l,{type:"request",status:n.status,message:"HTTP - "+n.status+" error",request:n})}},error:function(k){if(g!==undefined){g(k.responseText,{type:"request",status:k.status,message:"HTTP - "+k.status+" error",request:k})}}};i=b.extend({},i,f,true);if(b('input[name="csrfmiddlewaretoken"]',h).length===0){i.headers=b.extend(f.headers||{},{"X-CSRFToken":creme.ajax.cookieCSRF()})}b(h).ajaxSubmit(i)};creme.ajax.jqueryAjaxSend=function(f,i,d,h,e){e=e||{};var g=creme.ajax.cookieCSRF();var c=b.extend({async:!e.sync,type:e.method||"GET",url:f,data:i!==undefined?i:"",dataType:"json",success:function(j,l,k){if(Object.isFunc(d)){d(j,l,k)}},error:function(j,l,k){if(Object.isFunc(h)){h(j.responseText,creme.ajax.json._handleSendError(j,l,k))}}},e);if(Object.isEmpty(g)===false){c.headers=b.extend(e.headers||{},{"X-CSRFToken":g})}b.ajax(c)};var a=new creme.ajax.Backend();creme.ajax.defaultBackend=function(c){if(c===undefined){return a}if(creme.ajax.Backend.prototype.isPrototypeOf(c)===false){throw new Error("Default ajax backend must be a creme.ajax.Backend instance")}a=c}}(jQuery));(function(a){creme.ajax=creme.ajax||{};creme.ajax.MockAjaxBackend=function(b){a.extend(this.options,{delay:500},b||{});this.GET={};this.POST={};this.counts={GET:0,POST:0,SUBMIT:0}};creme.ajax.MockAjaxBackend.prototype=new creme.ajax.Backend();creme.ajax.MockAjaxBackend.prototype.constructor=creme.ajax.Backend;a.extend(creme.ajax.MockAjaxBackend.prototype,{send:function(c,g,b,k,h,m){var l=this;var j=this[b]||{};m=a.extend({},this.options,m);if(m.sync!==true){m.sync=true;var f=isNaN(m.delay)?500:m.delay;if(f>0){window.setTimeout(function(){l.send(c,g,b,k,h,m)},f);return}}var d=j[c];if(d===undefined){console.warn("MockAjaxBackend (404) : "+b+" "+c);d=this.response(404,"")}if(Object.isFunc(d)){try{d=creme.object.invoke(d,c,g,m)}catch(i){d=this.response(500,""+i)}}if(m.debug){console.log("mockajax > send > url:",c,"options:",m,"response:",d)}if(d.status!==200){return creme.object.invoke(h,d.responseText,new creme.ajax.AjaxResponse(d.status,d.responseText,d.xhr))}return creme.object.invoke(k,d.responseText,d.statusText,d)},get:function(d,e,f,b,c){this.counts.GET+=1;return this.send(d,e,"GET",f,b,c)},post:function(d,e,f,b,c){this.counts.POST+=1;return this.send(d,e,"POST",f,b,c)},submit:function(d,g,b,c){c=c||{};var f=c.action||d.attr("action");var e=creme.ajax.serializeFormAsDict(d,c.data);this.counts.SUBMIT+=1;return this.send(f,e,"POST",g,b,c)},response:function(b,c,d){d=a.extend({"content-type":"text/html"},d||{});return new creme.ajax.XHR({responseText:c,status:b,statusText:b!==200?creme.ajax.LOCALIZED_ERROR_MESSAGES[b]:"ok",getResponseHeader:function(e){return d[e.toLowerCase()]}})},resetMockCounts:function(){this.counts={GET:0,POST:0,SUBMIT:0}}})}(jQuery));(function(a){creme.ajax=creme.ajax||{};creme.ajax.CacheBackendEntry=function(e,d,f,c,b){this.key=e;this.url=d;this.data=f;this.dataType=c;this.response=b;this.state=undefined;this.waiting=false;this.events=new creme.component.EventHandler();this.registry=undefined};creme.ajax.CacheBackendCondition=function(b){this._expired_cb=Object.isFunc(b)?b:function(){return false}};creme.ajax.CacheBackendCondition.prototype={expired:function(c,b){if(c.state===undefined){return true}return creme.object.invoke(this._expired_cb,c,b)},reset:function(b){b.state={}}};creme.ajax.CacheBackendTimeout=function(b){this.maxdelay=(b||0)};creme.ajax.CacheBackendTimeout.prototype=new creme.ajax.CacheBackendCondition();creme.ajax.CacheBackendTimeout.prototype.constructor=creme.ajax.CacheBackendCondition;a.extend(creme.ajax.CacheBackendTimeout.prototype,{expired:function(c,b){if(c.state===undefined){return true}var d=c.state.time+this.maxdelay;return d-new Date().getTime()<=0},reset:function(b){b.state={time:new Date().getTime()}}});creme.ajax.CacheBackend=function(c,b){a.extend(this.options,b||{});this.delegate=c||new creme.ajax.Backend();this.condition=this.options.condition||new creme.ajax.CacheBackendCondition();this.entries={}};creme.ajax.CacheBackend.prototype=new creme.ajax.Backend();creme.ajax.CacheBackend.prototype.constructor=creme.ajax.Backend;a.extend(creme.ajax.CacheBackend.prototype,{get:function(d,f,g,b,c){c=a.extend({},this.options,c);var e=this._getEntry(d,f,c.dataType);this._fetchEntry(e,g,b,c)},_getEntry:function(c,e,b){var d=a.toJSON([c,b,e]);return this.entries[d]||new creme.ajax.CacheBackendEntry(d,c,e,b)},_updateEntry:function(c,b,d){c.response={data:b,textStatus:d};this.condition.reset(c)},_registerEntry:function(b){this.entries[b.key]=b;this.condition.reset(b);b.registry=this},_removeEntry:function(b){b.registry=undefined;delete this.entries[b.key]},_fetchEntry:function(e,f,c,d){var b=this;if(!d.forcecache&&!e.waiting&&(this.condition.expired(e,d)===false)){return creme.object.invoke(f,e.response.data,e.response.textStatus)}if(e.registry===undefined){this._registerEntry(e)}e.events.one("complete",function(i,h,j,g){creme.object.invoke(h?f:c,j,g)});if(!e.waiting){e.waiting=true;this.delegate.get(e.url,e.data,function(g,h){e.waiting=false;b._updateEntry(e,g,h);e.events.trigger("complete",[true,g,h])},function(h,g){b._removeEntry(e);e.waiting=false;e.events.trigger("complete",[false,h,g])},d)}}})}(jQuery));(function(a){creme.ajax=creme.ajax||{};creme.ajax.Query=creme.component.Action.sub({_init_:function(b,c){this._super_(creme.component.Action,"_init_",this._send,b);this._backend=c||creme.ajax.defaultBackend();this._converter=function(d){return d};this._data={};this._onsuccess_cb=a.proxy(this._onBackendSuccess,this);this._onerror_cb=a.proxy(this._onBackendError,this)},_onBackendSuccess:function(b,d){try{this.done(this._converter(b))}catch(c){this.fail(b,c)}},_onBackendError:function(c,b){this.fail(c,b)},converter:function(b){if(b===undefined){return this._converter}if(!Object.isFunc(b)){throw Error("converter is not a function")}this._converter=b;return this},backend:function(b){return Object.property(this,"_backend",b)},url:function(b){if(b===undefined){return Object.isFunc(this._url)?this._url():this._url}this._url=b;return this},data:function(b){if(b===undefined){return Object.isFunc(this._data)?this._data():this._data}this._data=b;return this},_send:function(c){c=a.extend({},this.options(),c||{});var e=a.extend({},this.data()||{},c.data||{});var d=(c.action||"get").toLowerCase();var f=c.backend||{};var b=this.url()||"";if(Object.isNone(this._backend)||!b){return this.cancel()}if(!Object.isFunc(this._backend[d])){throw new Error('no such backend action "%s"'.format(d))}this._backend[d](b,e,this._onsuccess_cb,this._onerror_cb,f);return this},get:function(c,b){return this.start({action:"get",data:c,backend:b||{}})},post:function(c,b){return this.start({action:"post",data:c,backend:b||{}})}});creme.ajax.query=function(c,b,e,d){b=b||{};return new creme.ajax.Query(b,d).url(c).data(e||{})}}(jQuery));(function(a){creme.layout=creme.layout||{};creme.layout.LayoutResizeSensor=creme.component.Component.sub({_OVERFLOW_EVENT:"OverflowEvent" in window?"overflowchanged":"overflow",_UNDERFLOW_EVENT:"OverflowEvent" in window?"overflowchanged":"underflow",_init_:function(){this._threshold=100;if(a.browserInfo().msie){this._sensor=a('<div class="ui-layout resize-sensor" onresize="$(\'body\').resize();">')}else{this._sensor=a('<div class="ui-layout resize-sensor">    <div class="ui-layout resize-overflow"><div></div></div>    <div class="ui-layout resize-underflow"><div></div></div></div>')}},isBound:function(){return this._target!==undefined},bind:function(e){if(this._target!==undefined){throw new Error("Resize sensor already bound")}this._target=e;var c=0,f=0;var h=this._sensor;var i=a(".resize-overflow",h);var b=a(".resize-underflow",h);var g=function(l){var k=h[0].offsetWidth;var j=h[0].offsetHeight;if(c===k&&f===j){return}e.trigger(jQuery.Event("resize",{width:k,height:j}));if(!h.parent().is(e)){e.append(h)}k=h[0].offsetWidth;j=h[0].offsetHeight;a("> :first",i).css("width",k-1).css("height",j-1);a("> :first",b).css("width",k+1).css("height",j-1);c=k;f=j};var d=a.debounce(g,this._threshold);if(!a.browserInfo().msie){this._onOverflow(h,d);this._onUnderflow(h,d);this._onOverflow(i,d);this._onUnderflow(b,d)}a("body").bind("resize",d);this._targetPosition=this._target.css("position");this._target.css("position","relative");this._target.append(this._sensor);g({})},unbind:function(){if(this._target===undefined){throw new Error("Resize sensor not bound")}a("> div.ui-layout.resize-sensor",this._target).remove();this._target.css("position",this._targetPosition);this._target=undefined;return this},_isOverflowEvent:function(b){return b.type==="overflow"||((b.orient===0&&b.horizontalOverflow)||(b.orient===1&&b.verticalOverflow)||(b.orient===2&&b.horizontalOverflow&&b.verticalOverflow))},_onOverflow:function(c,e){var b=this;var d=this._OVERFLOW_EVENT;c.bind(d,function(f){if(b._isOverflowEvent(f.originalEvent)){f.flow="over";e.apply(b,[f])}})},_onUnderflow:function(d,b){var c=this;var e=this._UNDERFLOW_EVENT;d.bind(e,function(f){if(c._isOverflowEvent(f.originalEvent)===false){f.flow="under";b.apply(c,[f])}})}});creme.layout.Layout=creme.component.Component.sub({_init_:function(c){var b=this;c=a.extend({resizable:false,filter:function(){return true}},c||{});this._resize_cb=function(f,d){b.fireResize(d?d.size.width:f.width||0,d?d.size.height:f.height||0)};this._add_cb=function(d){b.fireAdded(d.target)};this._remove_cb=function(d){b.fireRemoved(d.target)};this._layout_cb=function(){b.layout()};this._locked=false;this._uuid=a.uidGen();this._events=new creme.component.EventHandler();this.filter(c.filter);this.resizable(c.resizable)},preferredSize:function(b){return creme.layout.preferredSize(b)},filter:function(b){if(b===undefined){return this._filter}this._filter=Object.isType(b,"string")?function(c){a(c).is(b)}:b;return this},resizable:function(b){if(b===undefined){return this._resizable}this._resizable=b;this._initResizeSensor();return this},_initResizeSensor:function(){if(this._target===undefined){return}var b=this._resizable;var c=this._resizeSensor;if(!b){this._unbindResizeSensor();return this}if(c===undefined){this._resizeSensor=c=new creme.layout.LayoutResizeSensor()}this._bindResizeSensor()},_bindResizeSensor:function(){var b=this._resizeSensor;if(b!==undefined&&!b.isBound()){b.bind(this._target)}},_unbindResizeSensor:function(){var b=this._resizeSensor;if(b!==undefined&&b.isBound()){b.unbind(this._target)}},container:function(){return this._target},children:function(){return a("> *:not(.ui-layout)",this._target).filter(this._filter)},onResize:function(b){this._events.bind("resize",b);return this},onAdded:function(b){this._events.bind("added",b);return this},onRemoved:function(b){this._events.bind("removed",b);return this},onLayout:function(c){var b=this;this._events.bind("start",function(){try{c.apply(this,arguments)}catch(d){}b.done()});return this},fireResize:function(c,b){this._events.trigger("resize",[this._target,c,b],this);return this},fireAdded:function(b){this._events.trigger("added",[this._target,b],this);return this},fireRemoved:function(b){this._events.trigger("removed",[this._target,b],this);return this},done:function(){this._locked=false;this._events.trigger("done",[this._target],this);return this},layout:function(){if(this._locked===true){return this}this._locked=true;this._events.trigger("start",[this._target],this);return this},_bindEvents:function(){if(Object.isSubClassOf(this._target,creme.layout.Layout)){this._target.onDone(this._layout_cb);return}this._target.bind("resize",this._resize_cb);this._target.bind(a.matchIEVersion(8,9)?"DOMNodeRemoved DOMNodeRemovedFromDocument":"DOMNodeRemoved",this._remove_cb);this._target.bind(a.matchIEVersion(8,9)?"DOMNodeInserted DOMNodeInsertedIntoDocument":"DOMNodeInserted",this._add_cb)},_unbindEvents:function(){if(Object.isSubClassOf(this._target,creme.layout.Layout)){this._target._events.unbind("done",this._layout_cb);return}this._target.unbind("resize",this._resize_cb);this._target.unbind(a.matchIEVersion(8,9)?"DOMNodeRemoved DOMNodeRemovedFromDocument":"DOMNodeRemoved",this._remove_cb);this._target.unbind(a.matchIEVersion(8,9)?"DOMNodeInserted DOMNodeInsertedIntoDocument":"DOMNodeInserted",this._add_cb)},bind:function(b){if(this.isBound()){throw new Error("Layout is already bound.")}this._target=a(b);this._bindEvents();this._initResizeSensor();return this},unbind:function(){if(!this.isBound()){throw new Error("Layout is not bound.")}this._unbindEvents();this._target=undefined;return this},isBound:function(){return this._target!==undefined}});creme.layout.preferredSize=function(c,e){e=e||1;var b=0;var d=0;a("> *",c).filter(":visible").each(function(){var f=a(this).position();if(e>1){var g=creme.layout.preferredSize(a(this),e-1);d=Math.max(d,g[0]);b=Math.max(b,g[1])}d=Math.max(d,f.left+a(this).outerWidth(true));b=Math.max(b,f.top+a(this).outerHeight(true))});return[Math.round(d),Math.round(b)]}}(jQuery));(function(a){creme.layout=creme.layout||{};creme.layout.SortLayout=creme.layout.Layout.sub({_init_:function(b){b=a.extend({comparator:function(d,c){return 0},reverse:false},b||{});this._super_(creme.layout.Layout,"_init_",b);this.comparator(b.comparator);this.reverse(b.reverse);this.onLayout(this._onLayout);this.onAdded(this.layout);this.onRemoved(this.layout)},comparator:function(b){if(b===undefined){return this._comparator}this._comparator=a.proxy(b,this);return this},reverse:function(b){return Object.property(this,"_reverse",b)},_onLayout:function(c,b){var d=Array.copy(this.children().get());try{d=d.sort(this._comparator);d=this.reverse()?d.reverse():d}catch(f){}d.forEach(function(e){b.append(a(e).remove())})}})}(jQuery));(function(a){creme.layout=creme.layout||{};creme.layout.ColumnSortLayout=creme.layout.Layout.sub({_init_:function(b){b=a.extend({columns:1},b||{});this._super_(creme.layout.Layout,"_init_",b);this.columns(b.columns);this.comparator(b.comparator);this.onLayout(this._onLayout);this.onAdded(this.layout);this.onRemoved(this.layout);this.onResize(this.layout)},comparator:function(b){if(b===undefined){return this._comparator}this._comparator=a.proxy(b,this);return this},columns:function(c){if(c===undefined){return this._columns}if(Object.isType(c,"string")&&c.endsWith("px")){var b=parseInt(c.substr(0,c.length-2));if(isNaN(b)){c=1}else{c=function(){return Math.floor(this.container().width()/b)}}}this._columns=Object.isFunc(c)?c:function(){return c};return this},_onLayout:function(b,c){var g=Array.copy(this.children().get());var d=Math.max(this._columns(),1);var j=[];var f=Math.ceil(g.length/d);try{g=g.sort(this._comparator)}catch(i){}for(var h=0;h<d;++h){j.push([])}g.forEach(function(l,e){j[Math.floor(e/f)].push(a(l))});c.attr("ui-layout-columns",d);a("> .ui-layout.column.empty",c).remove();this.children().remove();for(var k=0;k<f;++k){j.forEach(function(e){if(e.length>k){c.append(e[k])}else{c.append(a("<li>").addClass("ui-layout column empty"))}})}}});creme.layout.CSSColumnLayout=creme.layout.Layout.sub({_init_:function(b){b=a.extend({columns:1},b||{});this._super_(creme.layout.Layout,"_init_",b);this.columns(b.columns);this.onLayout(this._onLayout);this.onAdded(this.layout);this.onRemoved(this.layout);this.onResize(this.layout)},columnWidth:function(){return Math.floor(this.container().width()/this.columns())},columns:function(b){if(b===undefined){return this._columns?this._columns():1}this._columns=Object.isFunc(b)?b:function(){return b};return this},_onLayout:function(c,b){var d=""+this.columnWidth()+"px;";b=this.container();b.attr("style","-webkit-column-width:"+d+"-moz-column-width:"+d+"-column-width:"+d)}})}(jQuery));(function(a){creme.layout=creme.layout||{};creme.layout.TextAreaAutoSize=creme.component.Component.sub({_init_:function(b){b=a.extend({min:2},b||{});this._min=b.min;this._max=b.max;this._listeners=a.proxy(this._onResize,this)},_onResize:function(f){var b=this._delegate;var d=this._count!==undefined?this._count:this._initial;var c=this._count=(b.val()!==null)?b.val().split("\n").length:this._min;if(f.keyCode===13){++c}c=Math.max(this._min,c);c=!isNaN(this._max)?Math.min(this._max,c):c;if(d!==c){c=a.browserInfo().mozilla?c-1:c;b.get().scrollTop=0;b.attr("rows",c)}},bind:function(b){if(this._delegate!==undefined){throw new Error("already bound")}this._delegate=b;b.css({"overflow-y":"hidden",resize:"none"});this._initial=parseInt(b.attr("rows"))||1;this._initial=a.browserInfo().mozilla?this._initial-1:this._initial;this._onResize(b);b.bind("propertychange keydown paste input",this._listeners);return this},unbind:function(){if(this._delegate===undefined){throw new Error("not bound")}this._delegate.unbind("propertychange keydown paste input",this._listeners);this._delegate=undefined;return this}})}(jQuery));(function(a){creme.model=creme.model||{};creme.model.Collection=creme.component.Component.sub({_init_:function(){this._events=new creme.component.EventHandler()},bind:function(c,d,b){this._events.bind(c,d,b);return this},unbind:function(b,c){this._events.unbind(b,c);return this},one:function(b,c){this._events.one(b,c)},_fireAdd:function(d,e,b,c){this._events.trigger("add",[d,e,b,c],this)},_fireRemove:function(d,e,b,c){this._events.trigger("remove",[d,e,b,c],this)},_fireUpdate:function(e,f,b,c,d){this._events.trigger("update",[e,f,b,c,d],this)},length:function(){return this.all().length},get:function(b){return this.all()[b]},each:function(b){return this.all().forEach(b)},map:function(b){return this.all().map(b)},where:function(b){return this.all().filter(b)},slice:function(c,b){return this.all().slice(c,b)},first:function(){return this.length()>0?this.get(0):undefined},last:function(){return this.length()>0?this.get(this.length()-1):undefined},all:function(){return[]}});creme.model.Delegate=creme.model.Collection.sub({_init_:function(c,b){this._super_(creme.model.Collection,"_init_");this._delegateListener=a.extend({update:a.proxy(this._onUpdate,this),add:a.proxy(this._onAdd,this),remove:a.proxy(this._onRemove,this)},b||{});this.delegate(c)},delegate:function(b){if(b===undefined){return this._delegate}var c=this._delegate;if(c!==undefined){c.unbind(this._delegateListener)}if(!Object.isNone(b)){b.bind(this._delegateListener)}this._delegate=b;return this},all:function(){return this._delegate?this._delegate.all():[]},_onUpdate:function(d,f,g,b,c,e){this._fireUpdate(f,g,b,c,e)},_onAdd:function(c,e,f,b,d){this._fireAdd(e,f,b,d)},_onRemove:function(c,e,f,b,d){this._fireRemove(e,f,b,d)}});creme.model.Filter=creme.model.Delegate.sub({_init_:function(d,c){var b={reset:a.proxy(this._onReset,this)};this._setFilter(c);this._super_(creme.model.Delegate,"_init_",d,b)},all:function(){return this._data},fetch:function(d,b){var c=this._filterData();this._super_(creme.model.Array,"reset",c);return this},_filterData:function(){var c=this._delegate;var b=this._filter;if(!c){return[]}return Object.isFunc(b)?c.where(b):c.all().slice()},_setFilter:function(b){if(Object.isNone(b)){this._filter=null}else{if(Object.isFunc(b)){this._filter=b}else{if(Object.isFunc(b.callable)){this._filter=b.callable()}else{if(Object.isType(b,"string")){this._filter=creme.utils.lambda(b,"item",null)}}}}},filter:function(b){if(b===undefined){return this._filter}this._setFilter(b);this.fetch();return this},delegate:function(c){var d=this._delegate;var b=this._super_(creme.model.Delegate,"delegate",c);if(d!==this._delegate){this.fetch()}return b},_onUpdate:function(d,f,g,b,c,e){if(e!=="reset"){this.fetch()}},_onAdd:function(d,f,g,b,c,e){if(e!=="reset"){this.fetch()}},_onRemove:function(d,f,g,b,c,e){if(e!=="reset"){this.fetch()}},_onReset:function(b){this.fetch()}})}(jQuery));(function(a){creme.model=creme.model||{};creme.model.Array=creme.model.Collection.sub({_init_:function(c,b){this._super_(creme.model.Collection,"_init_");this._data=!Object.isEmpty(c)?(Array.isArray(c)?c:[c]):[];this.comparator(b)},length:function(){return this._data.length},get:function(b){return this._data[b]},set:function(e,b,d){if(b<0||b>this._data.length){throw new Error("index out of bound")}var c=this._data[b];this._data[b]=e;this._fireUpdate([e],b,b,[c],d||"set");return this},reset:function(f){var j=this._data;var c=j?j.length:0;this._data=!Object.isEmpty(f)?(Array.isArray(f)?f:[f]):[];var h=this._data.length;if(c>0){if(h>0){var g=0;var i=Math.max(0,Math.min(j.length-1,this._data.length-1));this._fireUpdate(this._data.slice(g,i+1),g,i,j.slice(g,i+1),"reset")}if(c>h){var b=h;var e=c-1;this._fireRemove(j.slice(b,e+1),b,e,"reset")}}if(h>0&&h>c){var k=c;var d=h-1;this._fireAdd(this._data.slice(k,d+1),k,d,"reset")}this._events.trigger("reset",[],this);return this},insert:function(d,c){d=Array.isArray(d)?d:[d];c=c||0;var e=c;var b=e+(d.length-1);if(d.length===0){return this}if(c<0||c>this._data.length){throw new Error("index out of bound")}if(c===this._data.length){this._data=this._data.concat(d)}else{if(c===0){this._data=d.concat(this._data)}else{this._data=this._data.slice(0,c).concat(d,this._data.slice(c))}}this._fireAdd(d,e,b,"insert");return this},append:function(b){return this.insert(b,this._data.length)},prepend:function(b){return this.insert(b)},pop:function(){if(this._data.length===0){return}var b=this._data.length-1;var c=this._data.pop();this._fireRemove([c],b,b,"remove");return c},removeAt:function(b){if(b<0||b>this._data.length){throw new Error("index out of bound")}var c=this._data.splice(b,1);this._fireRemove(c,b,b,"remove");return c[0]},remove:function(c){c=Array.isArray(c)?c:[c];var b=this;var d=[];c.forEach(function(f){var e=b.indexOf(f);if(e!==-1){d.push(b.removeAt(e))}});return d},indexOf:function(e,b){b=b||this._comparator;var d=this._data;if(Object.isFunc(b)===false){return d.indexOf(e)}for(var c=0;c<d.length;++c){if(b(d[c],e)===0){return c}}return -1},indicesOf:function(d,c){c=c||this._comparator;d=Array.isArray(d)?d.slice():[d];var e=this._data;var b=[];if(Object.isFunc(c)===false){e.forEach(function(h,f){var g=d.indexOf(h);if(g!==-1){b.push(f);d.slice(g,1)}})}else{e.forEach(function(h,f){for(var g=0;g<d.length;++g){if(c(h,d[g])===0){b.push(f);d.slice(g,1)}}})}return b.length===0?-1:(b.length===1?b[0]:b)},clear:function(){var b=this._data;this._data=[];this._fireRemove(b,0,b.length-1,"clear");return b},first:function(){return this._data?this._data[0]:undefined},last:function(){return this._data?this._data[this._data.length-1]:undefined},each:function(b){this._data.forEach(b);return this},map:function(b){return this._data.map(b)},where:function(b){return this._data.filter(b)},slice:function(c,b){return this._data.slice(c,b)},all:function(){return this._data},comparator:function(b){return Object.property(this,"_comparator",b)},sort:function(b){var d=this._data;var c=Array.copy(d);b=b||this._comparator;d.sort(b);this._fireUpdate(d,0,d.length-1,c,"sort");this._events.trigger("sort",[],this);return this},reverse:function(){var c=this._data;var b=Array.copy(c);c.reverse();this._fireUpdate(c,0,c.length-1,b,"reverse");this._events.trigger("reverse",[],this);return this},patch:function(e){if(Array.isArray(e)){return this.reset(e)}e=e||{};var c=this;var d=e.add||[];var f=e.remove||[];var b=e.update||[];this.append(d);this.remove(f);b.forEach(function(h,g){c.set(h[0],h[1])});return this}})}(jQuery));(function(a){creme.model=creme.model||{};creme.model.Renderer=creme.component.Component.sub({_init_:function(d,b,c){this._modelListener=a.extend({update:a.proxy(this._onUpdate,this),add:a.proxy(this._onAdd,this),remove:a.proxy(this._onRemove,this)},c||{});this.target(d);this.model(b)},target:function(b){return Object.property(this,"_target",b)},model:function(b){if(b===undefined){return this._model}b=Array.isArray(b)?new creme.model.Array(b):b;var c=this._model;if(!Object.isNone(c)){c.unbind(this._modelListener)}if(!Object.isNone(b)){b.bind(this._modelListener)}this._model=b;return this},redraw:function(){return this}});creme.model.ListRenderer=creme.model.Renderer.sub({items:function(b){return b?a("li",b):a([])},createItem:function(f,e,d,b){var c=a("<li>");this.updateItem(f,c,d,undefined,b);return c},insertItem:function(f,e,d,b){var c=this.createItem(f,e,d,b);if(e&&e.length){e.before(c)}else{f.append(c)}},updateItem:function(f,d,e,c,b){d.html(""+e);return d},removeItem:function(e,c,d,b){c.remove()},redraw:function(){var d=this._target;var b=this;var c=this.model();this.items(d).each(function(e){b.removeItem(d,a(this),c!==undefined?c.get(e):undefined,e)});if(c===undefined){return this}c.all().forEach(function(f,e){b.insertItem(d,a([]),f,e)});return this},_onUpdate:function(e,g,i,b,d,f){var c=this;var h=this._target;this.items(h).slice(i,b+1).each(function(j){c.updateItem(h,a(this),g[j],d[j],i+j,f)})},_onAdd:function(d,g,i,b,f){var h=this._target;var c=this;var e=this.items(h).slice(i,i+1);g.forEach(function(k,j){c.insertItem(h,e,k,i+j)})},_onRemove:function(d,f,h,b,e){var g=this._target;var c=this;this.items(g).slice(h,b+1).each(function(i){c.removeItem(g,a(this),f[i],h+i)})}})}(jQuery));(function(a){creme.model=creme.model||{};creme.model.AjaxArray=creme.model.Array.sub({_init_:function(c,b){this.backend(c);this.initial(b||[]);this._super_(creme.model.Array,"_init_",this.initial());this._queryListeners={done:a.proxy(this._onQueryDone,this),fail:a.proxy(this._onQueryError,this),cancel:a.proxy(this._onQueryCancel,this)}},_onQueryDone:function(b,c,d){this._events.trigger("fetch-done",[c],this);this.patch(c)},_onQueryCancel:function(){this._events.trigger("fetch-cancel",[],this)},_onQueryError:function(c,d,b){this._events.trigger("fetch-error",[d,b],this);this.patch(this.initial())},initial:function(b){if(b===undefined){return Object.isFunc(this._initial)?this._initial():this._initial}this._initial=b;return this},converter:function(b){return Object.property(this,"_converter",b)},backend:function(b){return Object.property(this,"_backend",b)},url:function(b){return Object.property(this,"_url",b)},fetch:function(e,b,c){var d=this.backend().query();d.one(this._queryListeners).one(c||{}).url(this._url);if(this._converter){d.converter(this._converter)}if(this._running){if(this._running.isRunning()){this._running.cancel()}delete this._running}this._running=d;d.get(e,b);return this}})}(jQuery));(function(a){creme.model=creme.model||{};creme.model.CollectionController=creme.component.Component.sub({target:function(b){if(b===undefined){return this._target}this._target=b!==null?b:undefined;if(this.renderer()){this.renderer().target(b)}return this},redraw:function(){var b=this.renderer();var c=this.target();if(b&&c){b.redraw()}},_rendererModel:function(){return this._model},renderer:function(b){if(b===undefined){return this._renderer}this._renderer=b;if(this._renderer){this._renderer.model(this._rendererModel());this._renderer.target(this.target())}return this},model:function(b){if(b===undefined){return this._model}this._model=b;if(this._renderer){this._renderer.model(this._rendererModel())}return this},fetch:function(){this.model().fetch();return this}});creme.model.SelectionController=creme.component.Component.sub({_init_:function(){var b=this._events=new creme.component.EventHandler();this.selectionFilter(null);this._modelListeners={"add remove":function(c,d){b.trigger("change",[],this)},update:function(e,g,h,c,d,f){if(f!=="select"){b.trigger("change",[],this)}}}},on:function(c,d,b){this._events.on(c,d,b);return this},off:function(b,c){this._events.off(b,c);return this},one:function(b,c){this._events.one(b,c)},model:function(b){if(b===undefined){return this._model}var c=this._model;if(!Object.isNone(c)){c.unbind(this._modelListeners)}if(!Object.isNone(b)){b.bind(this._modelListeners);this._model=b}else{this._model=undefined}return this},selectionFilter:function(b){if(b===undefined){return this._filter}this._filter=Object.isFunc(b)?b:null;return this},selected:function(){var b=this.model();return b?b.where(function(c){return c.selected}):[]},selectables:function(){var c=this.model();var b=this._filter;if(c!==undefined){return Object.isFunc(b)?c.where(b):c.all()}return[]},_inRange:function(e,c){if(e.length===0){return false}for(var d=0;d<e.length;++d){var b=e[d];if(c>=b[0]&&c<=b[1]){return true}}return false},_cleanRange:function(d,e,b){var g,c,f;if(d.length>1){g=d[0];c=d[1]}else{g=d;c=d}if(g>c){f=g;g=c;c=f}return[Math.min(Math.max(e,g),b),Math.max(e,Math.min(b,c))]},_compareRange:function(d,c){return d[0]<c[0]?-1:(d[0]>c[0]?1:0)},_cleanIndices:function(f,d,c){if(Object.isFunc(f)){return this._cleanIndices(f(this))}f=Array.isArray(f)?f:[f];d=d||0;c=c||this.model().length();var b=this._cleanRange;var e=f.map(function(g){return b(g,d,c)}).sort(this._compareRange);return e},_updateSelection:function(l,k,e){var g=this.model();var c=this.selectionFilter();var b=this._inRange;var j=this.model().all();l=this._cleanIndices(l);var d=false;var f,h,m;for(var i=0;i<j.length;++i){m=j[i];if(c&&!c(m,i)){continue}h=(m.selected===true);if(b(l,i)){f=k(m,i)}else{f=e?e(m,i):h}if(f!==undefined&&f!==h){m.selected=f;d=true}}if(d){l.forEach(function(o){var p=o[0];var n=o[1];g._fireUpdate(j.slice(p,n+1),p,n,j.slice(p,n+1),"select")});this._events.trigger("change",[],this)}return this},toggle:function(c,b){return this._updateSelection(c,function(e,d){return b!==undefined?(b===true):!e.selected})},select:function(c,b){return this._updateSelection(c,function(e,d){return true},b?undefined:function(e,d){return false})},unselect:function(b){return this._updateSelection(b,function(d,c){return false})},toggleAll:function(b){return this.toggle([[0,this.model().length()-1]],b)},selectAll:function(){return this.toggleAll(true)},unselectAll:function(){return this.toggleAll(false)}})}(jQuery));(function(a){creme.model=creme.model||{};creme.model.ChoiceRenderer=creme.model.ListRenderer.sub({createItem:function(f,e,d,b){var c=a("<option>");this.updateItem(f,c,d,undefined,b);return c},updateItem:function(h,d,g,c,b,f){if(f==="select"){return this.selectItem(h,d,g,c,b)}var e=Object.isNone(g.value)?"":g.value;if(typeof g.value==="object"){e=new creme.utils.JSON().encode(g.value)}d.attr("value",e).toggleAttr("disabled",g.disabled===true).prop("selected",g.selected===true).toggleAttr("tags",g.tags,(g.tags||[]).join(" ")).html(g.label)},selectItem:function(f,d,e,c,b){d.prop("selected",e.selected===true)},items:function(b){return a("option",b)}});creme.model.ChoiceRenderer.parse=function(c,d){var b=c.val();b=c.is("[multiple]")?(b||[]):[b];return a("option",c).map(function(){var f=a(this);var e=f.attr("value");return{label:f.html(),value:Object.isFunc(d)?d(e):e,disabled:f.is("[disabled]"),selected:b.indexOf(e)!==-1,visible:true,help:f.attr("help"),tags:f.is("[tags]")&&f.attr("tags")?f.attr("tags").split(" "):[]}}).get()};creme.model.ChoiceRenderer.choicesFromTuples=function(c){c=c||[];var b=c?Array.isArray(c[0]):false;if(b){return c.map(function(d){return{value:d[0],label:d[1],help:undefined,visible:true,disabled:false,selected:false}})}else{return c.map(function(f){var g=null,e="null",d;if(!Object.isNone(f)){g=f.value!==undefined?f.value:f;e=f.label!==undefined?f.label:String(g);d=f.help}return{value:g,label:e,help:d,visible:true,disabled:false,selected:false}})}};creme.model.ChoiceGroupRenderer=creme.model.ChoiceRenderer.sub({insertGroup:function(e,c,b){var d=a('optgroup[label="'+b+'"]',e);if(d&&d.length){return d}d=a('<optgroup label="'+b+'">');if(c&&c.length){c.parent().before(d)}else{e.append(d)}return d},insertItem:function(h,f,e,c){var g=h;var b=f&&f.length?f.parent().attr("label"):undefined;var d=e.group;if(d){g=this.insertGroup(h,f,d)}if(f&&f.length){if(d&&b!==d){f=a("option:first",g)}f.before(this.createItem(h,f,e,c))}else{g.append(this.createItem(h,f,e,c))}},removeItem:function(f,c,d,b){var e=d.group?c.parent():undefined;c.remove();if(e&&a("option",e).length<1){e.remove()}},updateItem:function(h,l,d,e,f,c){if(c==="select"){return this.selectItem(h,l,d,e,f)}var k=h;var b=l.parent();var i=e?e.group:undefined;var g=d.group;if(g){k=this.insertGroup(h,l.next(),g)}if(i!==g){l.remove();k.append(l);if(b&&(a("option",b).length)<1){b.remove()}}var j=Object.isNone(d.value)?"":d.value;if(typeof d.value==="object"){j=new creme.utils.JSON().encode(d.value)}l.attr("value",j).toggleAttr("disabled",d.disabled===true).prop("selected",d.selected===true).toggleAttr("tags",d.tags,(d.tags||[]).join(" ")).html(d.label)}});creme.model.ChoiceGroupRenderer.parse=function(c,d){var b=c.val();b=c.is("[multiple]")?(b||[]):[b];return a("option",c).map(function(){var g=a(this);var e=g.attr("value");var f=g.parent();return{group:(f&&f.is("optgroup"))?f.attr("label"):undefined,label:g.html(),value:Object.isFunc(d)?d(e):e,disabled:g.is("[disabled]"),selected:b.indexOf(e)!==-1,visible:true,help:g.attr("help"),tags:g.is("[tags]")&&g.attr("tags")?g.attr("tags").split(" "):[]}}).get()};creme.model.ChoiceGroupRenderer.choicesFromTuples=function(c){c=c||[];var b=c?Array.isArray(c[0]):false;if(b){return c.map(function(d){if(d.length>2){return{value:d[0],label:d[1],group:d[2],help:undefined,visible:true,disabled:false,selected:false}}else{return{value:d[0],label:d[1],group:undefined,help:undefined,visible:true,disabled:false,selected:false}}})}else{return c.map(function(f){var g=null,e="null",h,d;if(!Object.isNone(f)){g=f.value!==undefined?f.value:f;e=f.label!==undefined?f.label:String(g);d=f.help;h=f.group}return{value:g,label:e,group:h,help:d,visible:true,disabled:false,selected:false}})}};creme.model.CheckListRenderer=creme.model.ListRenderer.sub({_init_:function(b){b=a.extend({itemtag:"li",disabled:false},b||{});this._super_(creme.model.ListRenderer,"_init_");this._itemtag=b.itemtag;this._disabled=b.disabled},disabled:function(b){return Object.property(this,"_disabled",b)},_getItemValue:function(c){var b=Object.isNone(c.value)?"":c.value;if(typeof c.value==="object"){b=new creme.utils.JSON().encode(c.value)}return b},createItem:function(g,h,d,f){var c=d.disabled||this._disabled;var i=this._getItemValue(d);var b={tag:this._itemtag,disabled:c?"disabled":"",value:i,index:f,checked:d.selected?"checked":"",label:d.label||"",help:d.help||"",hidden:!d.visible?"hidden":"",tags:(d.tags||[]).join(" ")};var j=a(('<${tag} class="checkbox-field ${hidden}" tags="${tags}" checklist-index="${index}" ${disabled}><input type="checkbox" value="${value}" checklist-index="${index}" ${disabled} ${checked}/><div class="checkbox-label"><span class="checkbox-label-text" ${disabled}>${label}</span><span class="checkbox-label-help" ${disabled}>${help}</span></div></${tag}>').template(b));var e=a('input[type="checkbox"]',j);e.data("checklist-item",{data:d,index:f});return j},updateItem:function(h,j,d,f,g,b){if(b==="select"){return this.selectItem(h,j,d,f,g)}var i=this._getItemValue(d);var e=a('input[type="checkbox"]',j);var c=d.disabled||this._disabled;e.toggleAttr("disabled",d.disabled||c).attr("value",i).attr("checklist-index",g).data("checklist-item",{data:d,index:g});e.prop("checked",d.selected);a(".checkbox-label-text",j).toggleAttr("disabled",c).html(d.label);a(".checkbox-label-help",j).toggleAttr("disabled",c).html(d.help);j.toggleAttr("tags",d.tags,(d.tags||[]).join(" ")).toggleClass("hidden",!d.visible).toggleClass("disabled",c).attr("checklist-index",g)},selectItem:function(f,d,e,c,b){a('input[type="checkbox"]',d).prop("checked",e.selected)},items:function(b){return a(".checkbox-field",b).sort(function(d,c){return parseInt(a(d).attr("checklist-index"))-parseInt(a(c).attr("checklist-index"))})},converter:function(b){return Object.property(this,"_converter",b)},parseItem:function(i,g,e){var f=this._converter;var b=a('input[type="checkbox"]',g);var d=a(".checkbox-label",g);var c=a(".checkbox-helptext",g);var h=b.attr("value");return{label:d.html(),value:Object.isFunc(f)?f(h):h,disabled:b.is("[disabled]")||i.is("[disabled]"),selected:b.is(":checked"),help:c.html(),tags:b.is("[tags]")?b.attr("tags").split(" "):[],visible:true}},parse:function(c){var b=this;this._itemtag=this.items(c).first().prop("tagName")||this._itemtag;return this.items(c).map(function(d){return b.parseItem(c,a(this),d)}).get()}});creme.model.CheckGroupListRenderer=creme.model.CheckListRenderer.sub({_init_:function(b){b=a.extend({grouptag:"ul"},b||{});this._super_(creme.model.CheckListRenderer,"_init_",b);this._grouptag=b.grouptag},insertGroup:function(e,c,b){var d=a('.checkbox-group[label="'+b+'"]',e);if(d&&d.length){return d}d=a(('<${tag} class="checkbox-group" label="${name}">   <li class="checkbox-group-header">${name}</li></${tag}>').template({tag:this._grouptag,name:b}));if(c&&c.length){c.parent().before(d)}else{e.append(d)}return d},insertItem:function(h,f,e,c){var g=h;var b=f&&f.length?f.parent().attr("label"):undefined;var d=e.group;if(d){g=this.insertGroup(h,f,d)}if(f&&f.length){if(d&&b!==d){f=a(".checkbox-field:first",g)}f.before(this.createItem(h,f,e,c))}else{g.append(this.createItem(h,f,e,c))}},removeItem:function(f,c,d,b){var e=d.group?c.parent():undefined;c.remove();if(e&&this.items(e).length<1){e.remove()}},updateItem:function(h,k,d,e,f,c){if(c==="select"){return this._super_(creme.model.CheckListRenderer,"updateItem",h,k,d,e,f,c)}var j=h;var b=k.parent();var i=e?e.group:undefined;var g=d.group;if(g){j=this.insertGroup(h,k.next(),g)}if(i!==g){k.remove();j.append(k);if(b&&(this.items(b).length)<1){b.remove()}}return this._super_(creme.model.CheckListRenderer,"updateItem",h,k,d,e,f,c)},parseItem:function(f,d,c){var e=this._super_(creme.model.CheckListRenderer,"parseItem",f,d,c);var b=d.parent();e.group=(b&&b.is(".checkbox-group"))?b.attr("label"):undefined;return e}})}(jQuery));(function(c){creme.dialog=creme.dialog||{};var b=["frame","background"];var a=function(d){if(b.indexOf(d)===-1){throw new Error('scroll type "${scroll}" is invalid'.template({scroll:d}))}else{return d}};creme.dialog.Dialog=creme.component.Component.sub({_init_:function(d){this._events=new creme.component.EventHandler();this._isClosing=false;this._deferFrameActivation=false;d=this.options=c.extend({url:undefined,data:undefined,backend:undefined,resizable:true,draggable:true,width:640,height:350,scroll:"frame",within:c(".ui-dialog-within-container"),fitFrame:true,useFrameActions:true,closeOnEscape:false,scrollbackOnClose:false},d||{});this._initFrame(d)},_initFrame:function(e){var d=this;var f=this._frame=new creme.dialog.Frame({backend:e.backend,autoActivate:false});f.onCleanup(c.proxy(this._onFrameCleanup,this)).onUpdate(c.proxy(this._onFrameUpdate,this));if(e.fitFrame){f.on("fetch-fail submit-fail",function(){d.resizeToDefault();d.position(d.position())})}f.bind(c("<div>").data("creme-dialog",this).addClass("ui-creme-dialog-frame"))},_onFrameCleanup:function(){this._events.trigger("frame-cleanup",[this.frame()],this)},_onFrameUpdate:function(){this._events.trigger("frame-update",[this.frame()],this);if(this.isOpened()){this._activateFrameContent()}else{this._deferFrameActivation=true}},_activateFrameContent:function(){if(this._isClosing===true){return}if(this.options.useFrameActions){this.replaceButtons(this._orderedFrameActionButtons(this.options))}this.frame().activateContent();if(this.options.fitFrame){this.fitToFrameSize()}this._events.trigger("frame-activated",[this.frame()],this)},_dialogBackground:function(){return this._dialog?c("body > :not(.ui-dialog)"):c([])},_destroyDialog:function(){if(this._dialog){this._dialogBackground().toggleClass("ui-dialog-scrollbackground",false);this._dialog.dialog("destroy");this._dialog.remove();this._dialog=undefined}},_onClose:function(e,f,d){try{this._isClosing=true;f.clear()}finally{this._isClosing=false}this._destroyDialog();this._events.trigger("close",[d],this);if(d.scrollbackOnClose){c("body").animate({scrollTop:this._openingScrollPosition},"slow")}},_onOpen:function(e,f,d){this._dialog=e;if(d.scroll==="background"){this._dialog.css("overflow-y","hidden");this._dialogBackground().toggleClass("ui-dialog-scrollbackground",true)}if(!Object.isEmpty(d.url)){this.fetch(d.url)}else{if(!Object.isEmpty(d.html)){this.fill(d.html)}}if(this._deferFrameActivation){this._activateFrameContent();this._deferFrameActivation=false}if(d.closeOnEscape&&!d.autoFocus){this.focus()}if(d.scrollbackOnClose){this._openingScrollPosition=c("body").get(0).scrollTop}this._events.trigger("open",[d],this)},_onResize:function(f,h){var e=this._dialogContainer();var d=c("> .ui-dialog-content",e);var g=h.delegate();g.width(d.width()-(g.position().left+(d.outerWidth()-d.width())));this._events.trigger("resize",[g.width(),g.height()],this)},_frameFetchData:function(f){var e=this.options;var d=Object.isFunc(e.data)?e.data.bind(this)(e,f):e.data||{};return c.extend({},d,f)},_frameActionLinkButtons:function(f){var d=this;var g={};var e=1;c("a.ui-creme-dialog-action",this.content()).each(function(){var j=c(this).attr("name");if(Object.isEmpty(j)){j="link-"+e;++e}var i=c(this).text()||gettext("Action");var h=c(this).attr("href");d._appendButton(g,j,i,function(){this.fetch(h)})});return g},_frameActionButtons:function(d){var e=this._defaultButtons({},d);return c.extend(e,this._frameActionLinkButtons(d))},_orderedFrameActionButtons:function(d){var e=this._frameActionButtons(d);return Object.values(e).sort(function(g,f){return(g.order||0)-(f.order||0)})},_appendButton:function(j,g,f,k,e){var d=this;var i=this.options.defaultButtonLabels||{};e=e||{};var h=c.extend({name:g,text:i[g]||f,click:function(l){k.apply(d,[c(this),l,e]);return false}},e);j[g]=h;return h},_defaultButtons:function(e,d){this._appendButton(e,"close",gettext("Close"),function(g,h,f){this.close()});return e},_updateButtonState:function(f,e,d){var g=this.button(f);g.removeClass("ui-state-focus ui-state-hover ui-state-active");g.toggleClass("ui-state-disabled",!e);g.toggleAttr("disabled",!e);if((!this.options.autoFocus&&d==="auto")||d===true){g.focus()}},_updateButtonLabel:function(e,d){c(".ui-button-text",this.button(e)).html(d)},_dialogContainer:function(){return c(this._dialog).parent(".ui-dialog:first")},_resizeDialog:function(g,d){if(!this.isOpened()){return}var i=this._dialog.dialog("option","maxWidth");var h=this._dialog.dialog("option","maxHeight");var f=this._dialog.dialog("option","minWidth");var j=this._dialog.dialog("option","minHeight");g=f>0?Math.max(g,f):g;d=j>0?Math.max(d,j):d;g=i>0?Math.min(g,i):g;d=h>0?Math.min(d,h):d;this._dialog.dialog("option","width",g);this._dialog.dialog("option","height",d);var e=this._frame.preferredSize()[1];if(j>0){e=Math.max(j,e)}this._frame.delegate().css("min-height",e).css("width","auto");this._frame.overlay().resize()},fitToFrameSize:function(){if(!this.isOpened()){return this}var e=this._dialogContainer();var j=c("> .ui-dialog-content",e);var g=this._frame.delegate();var k=e.outerWidth();var h=e.outerHeight();g.css("width",(Math.round(this.options.width-(e.outerWidth()-j.width()))));var i=g.position().left+(g.outerWidth()-g.width());var o=g.position().top+(g.outerHeight()-g.height());var p=this._frame.preferredSize();var l=Math.round(p[0]+i+(j.outerWidth()-j.width()));var d=Math.round(p[1]+o+(j.outerHeight()-j.height()));j.width(l).height(d);var f=e.outerWidth();var n=e.outerHeight();f=Math.abs(f-k)<5?k-2:f;n=Math.abs(n-h)<5?h:n;this._resizeDialog(f,n);this.position(this.position());var m=this._dialog.dialog("option","maxHeight");if(n<m||m===null){j.height("auto")}j.css("width","auto")},center:function(e){if(this.isOpened()){e=e||{};var d=this.cssPosition();if(e.top>0&&d.top<e.top){this.position({my:"center top",at:"center top+"+(e.top)})}else{this.position({my:"center center",at:"center center"})}}return this},cssPosition:function(){if(this.isOpened){return this._dialogContainer().position()}},position:function(d){if(d===undefined){return this._dialog?this._dialog.dialog("option","position"):undefined}if(Object.isEmpty(this.options.within)===false){d=c.extend({},d,{collision:"fit",within:this.options.within})}this._dialog.dialog("option","position",d);return this},frame:function(){return this._frame},content:function(){return this._frame.delegate()},buttons:function(){return c(".ui-dialog-buttonset",this._dialogContainer())},button:function(d){return c('button[name="'+d+'"]',this.buttons())},replaceButtons:function(d){this._dialog.dialog("option","buttons",d)},resize:function(e,d){this._resizeDialog(e,d)},resizeToDefault:function(){return this.resize(this.options.width,this.options.height)},size:function(){if(this.isOpened()){return{width:this._dialog.dialog("option","width"),height:this._dialog.dialog("option","height")}}},minSize:function(d){if(d===undefined){if(this.isOpened()){return{width:this._dialog.dialog("option","minWidth"),height:this._dialog.dialog("option","minHeight")}}}else{if(this.isOpened()){this._dialog.dialog("option","minWidth",d.width);this._dialog.dialog("option","minHeight",d.height)}return this}},maxSize:function(d){if(d===undefined){if(this.isOpened()){return{width:this._dialog.dialog("option","maxWidth"),height:this._dialog.dialog("option","maxHeight")}}}else{if(this.isOpened()){this._dialog.dialog("option","maxWidth",d.width);this._dialog.dialog("option","maxHeight",d.height)}return this}},fetch:function(e,d,g,f){this._frame.fetch(e,d,this._frameFetchData(g),f);return this},fill:function(d){this._frame.fill(d);return this},clear:function(){this._frame.clear();return this},dialog:function(){return this._dialog},focus:function(){this._dialogContainer().focus();return this},onClose:function(d){this._events.bind("close",d);return this},onOpen:function(d){this._events.bind("open",d);return this},on:function(e,f,d){this._events.bind(e,f,d);return this},off:function(d,e){this._events.unbind(d,e);return this},_onDragStop:function(d){this.position(this.position())},_onResizeStop:function(d){this.position(this.position())},open:function(p){if(this._dialog!==undefined){throw Error("dialog already opened !")}p=c.extend(this.options,p||{});var n=this;var g=this._frame;var e=g.delegate();var j=c.extend(this._defaultButtons({},p),p.buttons||{});var i=c("<div/>").append(e);var k=a(p.scroll);var l=(k==="frame");var h={};if(Object.isEmpty(p.within)){h={my:"center center",at:"center center"}}else{h={my:"center center+"+p.within.position().top,at:"center center",collision:"fit",within:p.within}}var d=l?p.resizable:false;var o=l?p.draggable:false;var f=p.minWidth>0?Math.max(p.minWidth,p.width):p.width;var m=p.minHeight>0?Math.max(p.minHeight,p.height):p.height;this._dialog=i.dialog({buttons:Object.values(j),title:p.title,modal:true,resizable:d,draggable:o,width:f,height:m,maxHeight:l?p.maxHeight:false,maxWidth:p.maxWidth,minHeight:p.minHeight,minWidth:p.minWidth,position:h,closeOnEscape:p.closeOnEscape,open:function(){n._onOpen(c(this),g,p)},resize:function(){n._onResize(c(this),g)},close:function(){n._onClose(c(this),g,p)},dragStop:function(){n._onDragStop(c(this))},resizeStop:function(){n._onResizeStop(c(this))}});return this},close:function(){this._onClose(this._dialog,this._frame,this.options);return this},isOpened:function(){return this._dialog!==undefined}});creme.dialog.redirect=function(d,f){if(f===undefined){creme.utils.redirect(d)}var e=c(f).parents(".ui-creme-dialog-frame:first").data("creme-dialog");if(e){e.fetch(d)}};creme.dialog.DialogAction=creme.component.Action.sub({_init_:function(d,e){this._super_(creme.component.Action,"_init_",this._openPopup,d);this._listeners=e||{}},dialog:function(){return this._dialog},_onClose:function(){delete this._dialog;this._dialog=undefined;this.done()},_buildPopup:function(e){var d=this;e=c.extend(this.options(),e||{});this._dialog=new creme.dialog.Dialog(e).onClose(function(){d._onClose()}).on(this._listeners);return this._dialog},_openPopup:function(d){this._buildPopup(d).open()}});creme.dialogs=creme.dialogs||{};creme.dialogs=c.extend(creme.dialogs,{image:function(f,d){if(Object.isType(f,"string")){var e=this.html("",d);var g=document.createElement("img");e.fill(c(g));g.onload=function(){e.fitToFrameSize()};g.src=f;return e}return this.html(f,d)},url:function(e,d,g){d=d||{};var f=new creme.dialog.Dialog(d).fetch(e,{},g);if(d.reloadOnClose){f.onClose(function(){creme.utils.reload()})}return f},form:function(e,d,g){d=c.extend({validator:"innerpopup"},d||{});var f=new creme.dialog.FormDialog(d);f.fetch(e,{},g);if(d.reloadOnSuccess){f.onFormSuccess(function(){creme.utils.reload()})}else{if(d.redirectOnSuccess){f.onFormSuccess(function(i,j,k,h){if(d.redirectOnSuccess===true){if(creme.utils.isHTMLDataType(h)){creme.utils.goTo(c(j).attr("redirect")||j)}else{creme.utils.goTo(j)}}else{creme.utils.goTo(d.redirectOnSuccess)}})}}return f},html:function(f,d){d=d||{};var e=new creme.dialog.Dialog(c.extend({},d,{html:f}));if(d.reloadOnClose){e.onClose(function(){creme.utils.reload()})}return e},confirm:function(e,d){return new creme.dialog.ConfirmDialog(e,d)},choice:function(h,e){e=c.extend({required:false},e||{});var i=e.choices||[];var f=e.selected||(i?i[0]:null);var d=new creme.model.ChoiceGroupRenderer(c("<select style='width:100%;'>"),i).redraw().target();var g=c("<div>");d.toggleAttr("required",e.required);if(Object.isEmpty(f.value)===false){d.val(f.value)}else{if(e.required){d.val(c("option:first",d).attr("value"))}}if(h){g.append(c("<div>").html(h))}g.append(c("<p>").append(d));return new creme.dialog.SelectionDialog(e).fill(g).validator(function(j){return Object.isEmpty(creme.forms.validateHtml5Field(d))}).selector(function(j){return d.val()})},alert:function(f,d){d=c.extend({title:gettext("Alert"),header:""},d||{});var g=d.header||"";var e=c('<p class="ui-creme-dialog-warn">').append(c('<span class="ui-icon ui-icon-alert">'));if(g){e.append(c('<span class="header">').html(g)).append(c('<p class="message">').html(f))}else{e.append(c('<span class="message">').html(f))}return this.html(e,d)},warning:function(e,d){d=c.extend({title:gettext("Warning")},d||{});return this.alert(e,d)},error:function(e,d,f){f=c.extend({status:200},f);var g=creme.ajax.localizedErrorMessage(f);d=c.extend({title:gettext("Error"),header:g},d||{});return this.alert(e||"",d)}});c.widget("ui.dialog",c.ui.dialog,{_allowInteraction:function(d){if(c(d.target).closest(".chzn-drop").length){return true}return this._super(d)}})}(jQuery));(function(a){creme.dialog=creme.dialog||{};creme.dialog.Overlay=creme.component.Component.sub({_init_:function(c){var b=this;c=c||{};this._content=a("<div/>").addClass("overlay-content");this._overlay=a("<div/>").addClass("ui-creme-overlay").append(this._content);this._timeout=new creme.component.TimeoutAction();this._timeout.onDone(function(e,d){b.update(d.visible,d.status)})},update:function(d,b,c){this._timeout.cancel();if(c>0){this._timeout.start({delay:c,visible:d,status:b});return this}this.visible(d||false);if(b===undefined){this._overlay.removeAttr("status")}else{this._overlay.attr("status",b)}return this},addClass:function(){this._overlay.addClass.apply(this._overlay,arguments);return this},removeClass:function(){this._overlay.removeClass.apply(this._overlay,arguments);return this},toggleClass:function(){this._overlay.toggleClass.apply(this._overlay,arguments);return this},content:function(b){if(b===undefined){return this._content}this._content.html(b);return this},visible:function(b){if(b===undefined){return this._overlay.hasClass("overlay-active")}b=b||false;if(!this.isBound()||this.visible()===b){return this}this._overlay.toggleClass("overlay-active",b);if(b){this._targetOverflowX=this._target.css("overflow-x");this._targetOverflowY=this._target.css("overflow-y");this._targetPosition=this._target.css("position");this._target.css({"overflow-x":"hidden","overflow-y":"hidden",position:"relative"});this.resize();this._target.append(this._overlay)}else{this._overlay.remove();this._target.css({"overflow-x":this._targetOverflowX,"overflow-y":this._targetOverflowY,position:this._targetPosition})}return this},resize:function(){if(!this.isBound()||!this.visible()){return this}var b=a.browserInfo().mozilla?1:0;this._overlay.css("width",this._target.outerWidth()+b).css("height",this._target.height());return this},bind:function(c){var b=this;if(this.isBound()){throw new Error("Overlay is already bound.")}this._target=c;this._target.bind("resize",function(){b.resize()});return this},unbind:function(){if(!this.isBound()){throw new Error("Overlay is not bound.")}this.visible(false);this._overlay.detach();this._target=undefined;return this},isBound:function(){return Object.isNone(this._target)===false},state:function(){return this._overlay.attr("status")}})}(jQuery));(function(b){var a=["^[s]*<json>(.*)</json>[s]*$","^[s]*<pre[^>]*>(.*)</pre>[s]*$"];creme.dialog=creme.dialog||{};creme.dialog.Frame=creme.component.Component.sub({_init_:function(c){c=b.extend({autoActivate:true},c||{});this._overlay=new creme.dialog.Overlay();this._overlayDelay=200;this._contentReady=false;this._backend=c.backend||creme.ajax.defaultBackend();this._events=new creme.component.EventHandler();this._json=new creme.utils.JSON();this._autoActivate=c.autoActivate},on:function(c,d){this._events.on(c,d);return this},onUpdate:function(c){return this.on("update",c)},onCleanup:function(c){return this.on("cleanup",c)},onFetchDone:function(c){return this.on("fetch-done",c)},onFetchFail:function(c){return this.on("fetch-fail",c)},onSubmitDone:function(c){return this.on("submit-done",c)},onSubmitFail:function(c){return this.on("submit-fail",c)},_cleanJSONResponse:function(e,d){for(var f in a){var h=new RegExp(a[f],"i");var c=e.match(h);var g=(c!==null&&c.length===2)?c[1]:undefined;if(g&&this._json.isJSON(g)){return{content:g,type:"text/json"}}}if(this._json.isJSON(e)){return{content:e,type:"text/json"}}return{content:e,type:d}},_cleanResponse:function(d,e,c){if(Object.isString(d)&&!Object.isEmpty(d)){return this._cleanJSONResponse(d,c||"text/html")}else{if(Object.isType(d,"object")){if(creme.utils.isHTMLDataType(d.type)){return d}else{return{content:d,type:Object.getPrototypeOf(d).jquery?"object/jquery":"object"}}}}return{content:d,type:"text/html"}},deactivateContent:function(){if(this._contentReady){creme.widget.shutdown(this._delegate);this._contentReady=false}},activateContent:function(){if(!this._contentReady){creme.widget.ready(this._delegate);this._contentReady=true}},isContentReady:function(){return this._contentReady},fill:function(i,h){i=this._cleanResponse(i);var f=this._delegate;var d=this._overlay;var c=i.type;if(!creme.utils.isHTMLDataType(c)&&c!=="object/jquery"){return this}try{d.unbind(f).update(false);this._events.trigger("cleanup",[f,h],this);this.deactivateContent();f.empty();d.bind(f);var g;if(Object.isString(i.content)){g=b(i.content.trim())}else{g=b(i.content)}if(g.length>0){f.append(g);if(this._autoActivate){this.activateContent()}}}catch(j){console.error(j)}this._events.trigger("update",[i.content,i.type,h],this);return this},lastFetchUrl:function(){return this._lastFetchUrl},clear:function(){return this.fill("")},resize:function(c){this._delegate.trigger("resize",c)},_formatOverlayContent:function(e,c,d){var g=d?d.status:404;var f='<h2>%s&nbsp;(%s)<div class="subtitle">%s</div></h2><p class="message">%s</p><a class="redirect" onclick="creme.utils.reload();">'+gettext("Reload the page or click here. If the problem persists, please contact your administrator.")+"</a>";return f.format(creme.ajax.localizedErrorMessage(d),g,e,c)},fetch:function(f,e,j,h){var c=this;h=h||{};f=f||this.lastFetchUrl();var i=this._backend.query();var d=this._overlay;var g=this._events;g.trigger("before-fetch",[f,e],this);d.content("").update(true,"wait",this._overlayDelay);i.onDone(function(l,k){c._lastFetchUrl=f;c.fill(k,"fetch");g.trigger("fetch-done",[k],this)}).on("cancel fail",function(m,k,l){g.trigger("fetch-fail",[k,l],this);d.update(true,l?l.status:404,0).content(c._formatOverlayContent(f,k,l))});i.one(h).url(f||"").get(j,e);return this},submit:function(f,e,i,h){var c=this;f=(i?(f||i.attr("action")):f)||this.lastFetchUrl();e=b.extend({action:f},e||{});h=h||{};var d=this._overlay;var g=this._events;this._events.one(h);this._events.trigger("before-submit",[i,e],this);if(Object.isEmpty(e.action)){d.update(true,404,0);g.trigger("submit-fail",["",new creme.ajax.XHR({responseText:"",status:404})],this);return this}this._overlay.content("").update(true,"wait",this._overlayDelay);this._backend.submit(i,function(k,m,n){var j=n.getResponseHeader("Content-Type").split(";")[0];var l=c._cleanResponse(k,m,j);c.fill(l,"submit");g.trigger("submit-done",[l.content,m,l.type],this)},function(j,k){d.update(true,k?k.status:500,0).content(c._formatOverlayContent(f,j,k));g.trigger("submit-fail",[j,k],this)},e);return this},bind:function(c){if(this._delegate!==undefined){throw new Error("frame component is already bound")}this._delegate=c;this._overlay.bind(c);return this},unbind:function(){if(this._delegate===undefined){throw new Error("frame component is not bound")}this._overlay.unbind(this._delegate);this._delegate=undefined;return this},backend:function(c){Object.property(this,"_backend",c)},delegate:function(){return this._delegate},overlay:function(){return this._overlay},overlayDelay:function(c){return Object.property(this,"_overlayDelay",c)},preferredSize:function(){return this._delegate?creme.layout.preferredSize(this._delegate,2):{width:0,height:0}}})}(jQuery));(function(a){creme.dialog=creme.dialog||{};creme.dialog.ConfirmDialog=creme.dialog.Dialog.sub({_init_:function(c,b){b=a.extend({title:gettext("Confirm"),fitFrame:true,height:200},b||{});this._super_(creme.dialog.Dialog,"_init_",b);this.message(c)},ok:function(){this._destroyDialog();this._events.trigger("ok",[],this);return this},message:function(b){this.options.html="<p>"+b+"</p>";return this.isOpened()?this.fill(this.options.html):this},_defaultButtons:function(c,b){this._appendButton(c,"ok",gettext("Ok"),function(f,g,d){this.ok()});this._appendButton(c,"cancel",gettext("Cancel"),function(f,g,d){this.close()});return c},onOk:function(b){this._events.bind("ok",b);return this}});creme.dialog.ConfirmAction=creme.component.Action.sub({_init_:function(b){this._super_(creme.component.Action,"_init_",this._openPopup,b)},_openPopup:function(c){var b=this;new creme.dialog.ConfirmDialog(c.message||"",c).onOk(function(d){b.done()}).onClose(function(){b.cancel()}).open()}})}(jQuery));(function(a){creme.dialog=creme.dialog||{};creme.dialog.FormDialog=creme.dialog.Dialog.sub({_init_:function(d){var c=this;d=a.extend({autoFocus:true,submitOnKey:13,submitData:{},noValidate:false,validator:"default"},d||{});this._super_(creme.dialog.Dialog,"_init_",d);if(Object.isFunc(d.validator)){this.validator(d.validator)}else{if(d.validator==="innerpopup"){this.validator(this._compatibleValidator)}else{this.validator(this._defaultValidator)}}var b=function(){c._updateButtonState("send",false);c._updateButtonState("cancel",true,false)};this.frame().on("before-submit before-fetch",b);this._submitListeners={"submit-done":this._onSubmitDone.bind(this),"submit-fail":this._onSubmitFail.bind(this)};this._submitKeyCb=this._onSubmitKey.bind(this)},validator:function(b){if(b===undefined){return this._validator}if(!Object.isFunc(b)){throw new Error("validator is not a function")}this._validator=b;return this},_defaultValidator:function(c,d,b){return !creme.utils.isHTMLDataType(b)||c.match(/<form[^>]*>/)===null},_compatibleValidator:function(c,d,b){if(Object.isEmpty(c)||!creme.utils.isHTMLDataType(b)){return true}if(c.match(/^<div[^>]+class="in-popup"[^>]*>/)){if(c.match(/^<div[^>]+closing="true"[^>]*>/)){return true}return(c.match(/<form[^>]*>/)===null)}return false},_validate:function(d,e,b){var c=this.validator();return !Object.isFunc(c)||c(d,e,b)},_frameSubmitData:function(d){var c=this.options;var b=Object.isFunc(c.submitData)?c.submitData.bind(this)(c,d):c.submitData||{};return a.extend({},b,d)},form:function(){return a("form:first",this.content())},submit:function(c,f,d){c=c||{};var e=this.form();var g=creme.forms.validateHtml5Form(e,this.options);if(Object.isEmpty(g)===false){return this}f=Object.isFunc(f)?f.bind(this)(c):f;var b=this._frameSubmitData(f);this.frame().submit("",a.extend({},c,{data:b}),e,this._submitListeners);return this},_onFrameCleanup:function(){this._super_(creme.dialog.Dialog,"_onFrameCleanup");this.frame().delegate().off("keypress",this._submitKeyCb)},_onFrameUpdate:function(d,f,b,e){if(e!=="submit"){this._super_(creme.dialog.Dialog,"_onFrameUpdate",d,f,b,e)}var c=this.frame().delegate();if(this.options.autoFocus){var g=a("[autofocus]:tabbable:first",c);if(g.length>0){g.focus()}else{a(":tabbable:first",c).focus()}}else{a(":tabbable",c).blur()}if(this.options.submitOnKey){c.on("keypress",this._submitKeyCb)}},_onSubmitDone:function(c,d,e,b){if(this._validate(d,e,b)){this._destroyDialog();this._events.trigger("form-success",[d,e,b],this);return}this._super_(creme.dialog.Dialog,"_onFrameUpdate",c,d,b,"submit");this._updateButtonState("send",true,"auto");this._updateButtonState("cancel",true);this._events.trigger("form-error",[d,e,b],this)},_onSubmitFail:function(b,c,d){this._updateButtonState("send",false);this._updateButtonState("cancel",true,true)},_onSubmitKey:function(b){if(b.keyCode===this.options.submitOnKey&&a(b.target).is(":not(textarea)")){b.preventDefault();this.button("send").click()}},_onOpen:function(d,e,c){var b=this;e.onFetchFail(function(g,f){b._updateButtonState("send",false);b._updateButtonState("cancel",true,true)}).onFetchDone(function(g,f){b._updateButtonState("send",true,"auto");b._updateButtonState("cancel",true)});this._super_(creme.dialog.Dialog,"_onOpen",d,e,c)},_frameActionFormSubmitButtons:function(e){var c=this;var f={};var b={};var d=function(i,j,h){h=a.extend({noValidate:i.is("[novalidate]")},h||{});this.submit(h,h.data)};var g=function(i){var h=b[i]||0;b[i]=h+1;return(h>0)?i+"-"+h:i};a('.ui-creme-dialog-action[type="submit"]',this.content()).each(function(){var k=a(this);var m={};var j=k.attr("name");var i=k.text();var h=parseInt(k.attr("data-dialog-action-order")||0);var l=k.val();var n=g(j||"send");if(k.is("input")){i=l||gettext("Save")}else{i=i||gettext("Save");if(!Object.isEmpty(j)&&!Object.isNone(l)){m[j]=l}}c._appendButton(f,n,i,d,{data:m,order:h})}).toggleAttr("disabled",true);if(Object.isEmpty(f)){this._appendButton(f,"send",gettext("Save"),d)}return f},_frameActionButtons:function(b){var c=this._super_(creme.dialog.Dialog,"_frameActionButtons",b);a.extend(c,this._frameActionFormSubmitButtons(b));return c},_defaultButtons:function(c,b){this._appendButton(c,"cancel",gettext("Cancel"),function(f,g,d){this.close()});return c},onFormSuccess:function(b){this._events.bind("form-success",b);return this},onFormError:function(b){this._events.bind("form-error",b);return this}});creme.dialog.FormDialogAction=creme.component.Action.sub({_init_:function(b,c){this._super_(creme.component.Action,"_init_",this._openPopup,b);this._listeners=c||{}},_onSubmit:function(c,d,e,b){if(a.matchIEVersion(7,8,9)){d=d.endsWith("</json>")||d.endsWith("</JSON>")?d.substr(0,d.length-"</json>".length):d;b="text/json"}this.done(d,b)},_buildPopup:function(c){var b=this;c=a.extend(this.options(),c||{});return new creme.dialog.FormDialog(c).onFormSuccess(this._onSubmit.bind(this)).onClose(function(){b.cancel()}).on(this._listeners)},_openPopup:function(b){this._buildPopup(b).open()}})}(jQuery));(function(a){creme.dialog.SelectionDialog=creme.dialog.Dialog.sub({_init_:function(b){b=a.extend({title:gettext("Selection"),fitFrame:false,height:200},b||{});this._super_(creme.dialog.Dialog,"_init_",b)},validator:function(b){return Object.property(this,"_validator",b)},selector:function(b){return Object.property(this,"_selector",b)},selected:function(){var b=this._selector;return Object.isFunc(b)?b.apply(this,[this.content()]):[]},ok:function(){var b=this._validator;var c=this.selected();if(Object.isFunc(b)&&b(c)===false){return this}this._destroyDialog();this._events.trigger("ok",[c],this);return this},_defaultButtons:function(c,b){this._appendButton(c,"ok",gettext("Ok"),function(f,g,d){this.ok()});this._appendButton(c,"cancel",gettext("Cancel"),function(f,g,d){this.close()});return c},onOk:function(b){this._events.bind("ok",b);return this}})}(jQuery));(function(a){creme.dialog=creme.dialog||{};creme.dialog.GlassPane=creme.component.Component.sub({_init_:function(b){b=a.extend({debug:false,modal:false},b||{});this._events=new creme.component.EventHandler();this._options=b;this._opened=false;this._initFrame(b)},_initFrame:function(b){var c=this._pane=a('<div class="glasspane">');if(b.debug){c.attr("data-debug","")}},pane:function(){return this._pane},addClass:function(){this._pane.addClass.apply(this._pane,arguments);return this},removeClass:function(){this._pane.removeClass.apply(this._pane,arguments);return this},toggleClass:function(){this._pane.toggleClass.apply(this._pane,arguments);return this},on:function(c,d,b){this._events.on(c,d,b);return this},off:function(b,c){this._events.off(b,c);return this},open:function(b){if(this.isOpened()){throw Error("glasspane is already opened")}var d=this._pane;if(b){var c=b.css("z-index")-1;if(c>0){d.css("z-index",c)}}a("body").append(d);this._opened=true;this._pane.trigger("glasspane-opened",this);this._events.trigger("opened",[],this);return this},isOpened:function(){return this._opened},close:function(){if(this.isOpened()===false){return}this._pane.detach();this._opened=false;this._pane.trigger("glasspane-closed",this);this._events.trigger("closed",[],this);return this},toggle:function(b){if(this.isOpened()){return this.close()}else{return this.open(b)}}})}(jQuery));(function(b){var c=["top","left","right","bottom","bottom-left","bottom-right"];var a=function(d){if(c.indexOf(d)===-1){throw Error("invalid popover direction "+d)}else{return d}};creme.dialog=creme.dialog||{};creme.dialog.Popover=creme.component.Component.sub({_init_:function(d){d=b.extend({title:false,closeIfOut:true,direction:"bottom",modal:true},d||{});this._events=new creme.component.EventHandler();this._options=d;this._initFrame(d)},_initFrame:function(d){var f=b('<div class="popover-content"/>');var e=this._dialog=b('<div class="popover"><div class="arrow"></div>');e.append(b('<div class="popover-title hidden"/>'));e.append(f);this._glasspane=new creme.dialog.GlassPane().addClass("popover-glasspane");this.title(d.title);this.direction(d.direction)},open:function(e,d){if(this.isOpened()){throw Error("popover is already opened")}if(this._options.modal){b(".popover").trigger("modal-close")}d=this._options=b.extend({},this._options,d||{});e=this._anchor=b(e);var f=this._dialog;var g=this.close.bind(this);f.css("visiblility","hidden");b("body").append(f);this._glasspane.open(f);this._onclose=function(){g()};this.direction(d.direction||"bottom");f.css("visiblility","visible");f.on("modal-close",this._onclose);if(d.closeIfOut){this._glasspane.pane().on("mousedown",this._onclose)}this._events.trigger("opened",[],this);return this},isOpened:function(){return Object.isNone(this._anchor)===false},_updateDialogPosition:function(h,g,j){var e=b.extend({top:0,left:0},g.offset());var f=g.outerWidth()||0;var k=g.outerHeight()||0;var i=h.outerWidth()||0;var d=h.outerHeight()||0;switch(j){case"bottom":e.top+=k;e.left+=(f-i)/2;break;case"bottom-left":e.top+=k;e.left-=(i-f-18);break;case"bottom-right":e.top+=k;e.left-=(f/2);break;case"top":e.top-=d;e.left+=(f-i)/2;break;case"right":e.top+=(k/2)-18;e.left+=f;break;case"left":e.top+=(k/2)-18;e.left-=i;break}h.removeClass(c.join(" "));h.addClass(j);h.css(e)},close:function(){this._dialog.off("modal-close",this._onclose);this._dialog.detach();this._anchor=null;this._glasspane.pane().off("mousedown",this._onclose);this._glasspane.close();this._events.trigger("closed",Array.copy(arguments),this);return this},options:function(){return this._options},direction:function(d){if(d===undefined){return this._options.direction}a(d);this._options.direction=d;if(this.isOpened()){this._updateDialogPosition(this._dialog,this._anchor,d)}return this},title:function(d){if(d===undefined){return b(".popover-title",this._dialog)}b(".popover-title",this._dialog).toggleClass("hidden",d===false);if(Object.isString(d)){b(".popover-title",this._dialog).html(d)}else{b(".popover-title",this._dialog).empty().append(d)}return this},addClass:function(d){this._dialog.addClass(d);return this},removeClass:function(d){this._dialog.removeClass(d);return this},toggleClass:function(e,d){this._dialog.toggleClass(e,d);return this},content:function(){return b(".popover-content",this._dialog)},fill:function(d){var e=Object.isFunc(d)?d.bind(this)(this._options):d;if(Object.isString(e)){b(".popover-content",this._dialog).html(e)}else{b(".popover-content",this._dialog).empty().append(e)}return this},toggle:function(e,d){if(this.isOpened()){return this.close()}else{return this.open(e,d)}},on:function(e,f,d){this._events.on(e,f,d);return this},off:function(d,e){this._events.off(d,e);return this},one:function(d,e){this._events.one(d,e);return this}})}(jQuery));(function(a){creme.list=creme.list||{};creme.list.Pager=creme.component.Component.sub({_init_:function(b){this._options=a.extend({debounceDelay:50},b||{});this._events=new creme.component.EventHandler();this._element=null},on:function(c,d,b){this._events.on(c,d,b);return this},off:function(b,c){this._events.off(b,c);return this},one:function(b,c){this._events.one(b,c);return this},canvas2d:function(){if(Object.isNone(this._canvas2d)){this._canvas2d=document.createElement("canvas").getContext("2d")}return this._canvas2d},_cleanPageInput:function(c){var d=parseInt(c.val());var b=parseInt(c.attr("max"));if(isNaN(d)||d<1||(!isNaN(b)&&d>b)){d=null}c.toggleClass("invalid-page",Object.isNone(d));return d},_goToChosenPage:function(b){this.refresh(this._cleanPageInput(b))},_resizeChooseInput:function(b){var e=this.canvas2d();var d=Object.isNone(b.val())?"":b.val();e.font=b.css("font-size")+" "+b.css("font-family");var c=e.measureText(d).width;b.css("width",c+25);return b},_initializeChooseLink:function(e){var d=this;var c=a("input:first",e);var b=function(f){if(d._options.debounceDelay>0){return a.debounce(f,d._options.debounceDelay)}else{return f}};e.click(function(f){f.stopPropagation();e.addClass("active");c.val(c.attr("data-initial-value"));d._cleanPageInput(c);d._resizeChooseInput(c);c.select().focus()});c.on("propertychange input change paste",b(function(){d._cleanPageInput(c)})).on("propertychange input change paste keydown",b(function(){d._resizeChooseInput(c)})).on("keyup",function(f){if(f.keyCode===13){f.preventDefault();d._goToChosenPage(c)}else{if(f.keyCode===27){f.preventDefault();c.focusout()}}}).on("blur focusout",function(){e.removeClass("active")})},refresh:function(b){if(!Object.isEmpty(b)){this._events.trigger("refresh",b)}},bind:function(c){if(this.isBound()){throw new Error("Pager is already bound")}var b=this;a("a.pager-link",c).click(function(d){d.preventDefault();if(a(this).is(".is-disabled")===false){b.refresh(a(this).attr("data-page"))}});a(".pager-link-choose",c).each(function(){b._initializeChooseLink(a(this))});this._element=c;return this},isBound:function(){return Object.isNone(this._element)===false}})}(jQuery));(function(a){creme.widget.Frame=creme.widget.declare("ui-creme-frame",{options:{backend:creme.ajax.defaultBackend(),url:undefined,overlay_delay:100},_create:function(d,c,b,e){this._overlay=new creme.dialog.Overlay();this._overlay.bind(d).addClass("frame-loading");var f=this._frame=new creme.dialog.Frame({backend:c.backend});f.onUpdate(function(h,i,g){d.trigger("update",[i,g])}).onFetchFail(function(h,i,g){d.trigger("reloadError",[i,g])}).onSubmitFail(function(h,i,g){d.trigger("submitError",[i,g])}).bind(d).overlayDelay(c.overlay_delay).overlay().addClass("frame-loading");d.addClass("widget-ready");this.reload(d,undefined,b)},url:function(b){return this._lasturl||this.options.url},preferredSize:function(b){return creme.layout.preferredSize(b)},resize:function(c,b){c.trigger("resize",b)},fill:function(c,d,b){this._frame.fill(d);creme.object.invoke(b,d)},reset:function(c,b){this._frame.clear();this._lasturl=undefined;creme.object.invoke(b)},reload:function(c,b,e,d){d=d||{};b=b||this.url();this._lasturl=b;if(Object.isEmpty(b)===false){this._frame.fetch(b,{},e,d)}},submit:function(b,d,c){c=c||{};this._frame.submit(this.url(),{},d,c)}})}(jQuery));(function(a){creme.widget.Toggle=creme.widget.declare("ui-creme-toggle",{options:{ontoggle:undefined},_create:function(f,e,b,g,d){var c=this;this.trigger(f).each(function(){var h=creme.widget.parseopt(a(this),{"open-event":null,"close-event":null,"toggle-event":"click",recursive:false},{});c._bind_trigger(f,a(this),h)});this._on_toggle=creme.object.build_callback(e.ontoggle,["collapsed","options"]);this.toggle(f,this.is_opened(f));f.addClass("widget-ready")},_bind_trigger:function(g,f,e){var d=this;var h=e["toggle-event"];var c=e["open-event"];var b=e["close-event"];if(h!=null){f.bind(h,function(){d.toggle(g,undefined,e)})}if(c!=null){f.bind(c,function(){d.expand(g,e)})}if(b!=null){f.bind(b,function(){d.collapse(g,e)})}},trigger:function(b){var c=a(".toggle-trigger",b).filter(function(){return a(this).parents(".ui-creme-toggle:first").is(b)});return b.is(".toggle-trigger")?c.add(b):c},targets:function(c){var b=a(".toggle-target",c).filter(function(){return a(this).parents(".ui-creme-toggle:first").is(c)});return c.is(".toggle-target")?b.add(c):b},toggles:function(b){return a(".ui-creme-toggle.widget-ready",b)},toggle:function(f,d,c){var b=this;var c=c||{};var h=(d===undefined)?!this.is_closed(f):!d;f.toggleClass("toggle-collapsed",h);this.trigger(f).each(function(){b._toggle_trigger(a(this),h,c)});this.targets(f).each(function(){b._toggle_target(a(this),h,c)});if(c.recursive){this.toggles(f).each(function(){a(this).creme().widget().toggle(!h,c)})}if(Object.isFunc(this._on_toggle)){try{if(f.is(".widget-ready")){this._on_toggle.apply(this,[h,c])}}catch(g){console.error(g)}}return this},expand:function(c,b){return this.toggle(c,true,b)},collapse:function(c,b){return this.toggle(c,false,b)},is_opened:function(b){return !b.hasClass("toggle-collapsed")},is_closed:function(b){return b.hasClass("toggle-collapsed")},_toggle_trigger:function(c,d,b){c.toggleClass("toggle-collapsed",d);this._toggle_attributes(c,d)},_toggle_target:function(c,d,b){c.toggleClass("toggle-collapsed",d);this._toggle_attributes(c,d);a(".ui-creme-resizable",c).trigger("resize").trigger("resizestop")},_toggle_attributes:function(f,h){for(var d=0;d<f[0].attributes.length;++d){var b=f[0].attributes[d];if(/^toggle\-(close|open)\-[\w\d]+$/.test(b.name)){var e=b.name.split("-");var g=e[1];var c=e[2];if(!h&&g==="open"){f.attr(c,b.value)}else{if(h&&g==="close"){f.attr(c,b.value)}}}}}})}(jQuery));(function(a){creme.widget.PluginLauncher=creme.widget.declare("ui-creme-jqueryplugin",{options:{plugin:"",plugin_options:{}},_create:function(g,e,b,i,c){var f=e.plugin||"";var d=this._pluginOptions=creme.utils.JSON.clean(e.plugin_options,{});var h=this._plugin=f!==""?g[f]:undefined;if(Object.isFunc(h)){h.apply(g,[d])}g.addClass("widget-ready")},_destroy:function(b){this._plugin.apply(b,"destroy")},plugin:function(b){return this._plugin}})}(jQuery));(function(a){creme.widget.DynamicInput=creme.widget.declare("ui-creme-dinput",{options:{datatype:"string"},_create:function(d,c,b,e){this._enabled=creme.object.isFalse(c.disabled)&&d.is(":not([disabled])");if(!this._enabled){a(d).attr("disabled","")}this.reload(d,{},b,b);d.addClass("widget-ready")},_updateDisabledState:function(b){b.toggleAttr("disabled",!this._enabled)},dependencies:function(b){return[]},reload:function(c,f,b,e,d){creme.object.invoke(b,c)},reset:function(b){this.val(b,null)},val:function(b,c){if(c===undefined){return b.val()}if(!Object.isNone(c)&&typeof c!=="string"){c=a.toJSON(c)}b.val(c);b.removeAttr("disabled");b.change();this._updateDisabledState(b)},cleanedval:function(b){var c=this.val(b);if(this.options.datatype==="string"){return c}return creme.widget.cleanval(c,c)}})}(jQuery));(function(a){creme.widget=creme.widget||{};creme.widget.DYNAMIC_SELECT_BACKEND=new creme.ajax.CacheBackend(new creme.ajax.Backend(),{condition:new creme.ajax.CacheBackendTimeout(120*1000)});creme.widget.DynamicSelect=creme.widget.declare("ui-creme-dselect",{options:{backend:creme.widget.DYNAMIC_SELECT_BACKEND,datatype:"string",url:"",filter:"",dependencies:"",multiple:undefined,sortable:undefined,autocomplete:undefined,"autocomplete-options":""},_create:function(d,c,b,e){this._context={};this._backend=c.backend;this._enabled=creme.object.isFalse(c.disabled)&&d.is(":not([disabled])");this._readonly=creme.object.isTrue(c.readonly)&&d.is("[readonly]");this._multiple=creme.object.isTrue(c.multiple)&&d.is("[multiple]");this._url=new creme.utils.Template(c.url);this._filter=new creme.utils.Template(c.filter);this._dependencies=Array.isArray(c.dependencies)?c.dependencies:(c.dependencies?c.dependencies.split(" "):[]);this._init_model(d,c);this._init_autocomplete(d,c);this.reload(d,{},b,b,e);d.addClass("widget-ready")},_destroy:function(b){if(this._autocomplete){this._autocomplete.deactivate()}},_init_model:function(e,d){var b=this;var f=this._converter=d.datatype==="json"?function(g){return creme.widget.cleanval(g,null)}:undefined;var c=creme.model.ChoiceGroupRenderer.parse(e,f);this._model_onchange_cb=function(){b._onModelChange(e)};this._model=new creme.model.AjaxArray(this._backend,c);this._model.url(function(){return b.url()}).converter(this._modelConverter).comparator(this._modelComparator);this._filtered=new creme.model.Filter(this._model);this._filtered.bind(["remove","clear","reset","add"],this._model_onchange_cb);this._renderer=new creme.model.ChoiceGroupRenderer(e,this._filtered)},_init_autocomplete:function(d,b){if(Object.isNone(b.autocomplete)){return}var c={};try{c=b["autocomplete-options"]||"";c=c.length?creme.object.build_callback(c)():{}}catch(f){c={}}c=a.extend({multiple:b.multiple!==undefined,sortable:b.sortable!==undefined,search_contains:true},c);this._autocomplete=new creme.component.Chosen(c);this._autocomplete.activate(d)},_updateDisabledState:function(e){var d=a("option:not(:disabled)",e).length;var c=d<1;var g=d<2;var f=!this._enabled||c;var b=(g&&!this._multiple)||this._readonly;e.prop("disabled",f);e.toggleAttr("readonly",b)},_updateAutocomplete:function(){if(this._autocomplete){this._autocomplete.refresh()}},_onModelChange:function(c,b){this._updateDisabledState(c);this._updateAutocomplete()},_modelConverter:function(b){var c=creme.model.ChoiceGroupRenderer.choicesFromTuples(b);return c.map(function(e){var d=e.label;if(e.help||e.group){d="<span>${label}</span>".template(e);if(e.help){d+='<span class="group-help">${help}</span>'.template(e)}if(e.group){d+='<span class="hidden">${group}</span>'.template(e)}}e.label=d;return e})},_modelComparator:function(d,c){return d.value<c.value?-1:(d.value>c.value?1:0)},_updateModel:function(e,b,h,g){var c=this;var d=this.url();if(d===null){this._model.reset([]);return}if(!d){this._onModelChange(e);creme.object.invoke(h,e,new creme.ajax.AjaxResponse("404",""));return}var f=this.val(e);this._model.fetch({fields:["id","unicode"],sort:"unicode"},{dataType:"json",sync:g},{done:function(i,j){c.val(e,f);creme.object.invoke(b,e,j)},fail:function(j,k,i){c.val(e,f);creme.object.invoke(h,e,i)},cancel:function(i,j){c.val(e,f)}})},_updateFilter:function(d){var c=this;var f=this.filter(d);var e=this.val(d);if(this._previousFilter===f){this._filtered.fetch();this.val(d,e);return}this._previousFilter=f;var b=creme.utils.lambda(f,"item, context",null);this._filtered.filter(b!==null?function(g){return b(g,c._context)}:null);this.val(d,e)},filter:function(b,c){if(c===undefined){return this._filter&&this._filter.iscomplete()?this._filter.render():""}this._filter=new creme.utils.Template(c);this._filter.update(this._context||{});this._updateFilter(b);return this},url:function(c,b){if(b===undefined){return this._url&&this._url.iscomplete()?this._url.render():null}this._url=new creme.utils.Template(b);this._url.update(this._context||{});this._updateModel(c);return this},dependencies:function(b){return this._dependencies.concat(this._url.tags()||[]).concat(this._filter.tags()||[])},reload:function(c,f,b,e,d){f=f||{};this._context=a.extend({},this._context||{},f);this._url.update(f);this._filter.update(f);this._updateFilter(c);this._updateModel(c,b,e,d);return this},update:function(c,d){d=creme.widget.cleanval(d,{});var b=this._model;var e=function(f){return b.indexOf(f)===-1};this._model.patch({add:this._modelConverter(d.added).filter(e),remove:this._modelConverter(d.removed)});this.val(c,d.value);return this},model:function(b){return this._model},_onSelectionChange:function(b,c){b.prop("disabled",false);b.change();this._updateDisabledState(b);this._updateAutocomplete()},_valMultiple:function(b,d){if(d===undefined){return b.val()}if(d!==null){var c=[];if(Object.isString(d)){c=creme.utils.JSON.clean(d,d.split(","))}else{c=d}c=Array.isArray(c)?c:[c];c=c.map(function(e){return Object.isString(e)===false?a.toJSON(e):e});b.val(c);this._onSelectionChange(b)}},val:function(c,d){if(this.options.multiple){return this._valMultiple(c,d)}if(d===undefined){return c.val()}d=d!==null?d:"";if(typeof d!=="string"){d=a.toJSON(d)}var b=this.choice(c,d);if(b===undefined){this.selectfirst(c)}else{c.val(d);this._onSelectionChange(c)}},cleanedval:function(b){var c=this.val(b);if(this.options.datatype==="string"){return c}if(this.options.multiple){return this._converter?c.map(this._converter):c}return this._converter?this._converter(c):c},reset:function(b){this.selectfirst(b)},selectfirst:function(b){b.val(a("option:not(:disabled):first",b).attr("value"));this._onSelectionChange(b)},firstchoice:function(b){var c=a("option:not(:disabled):first",b);return c.length?[c.attr("value"),c.text()]:null},_querychoices:function(d,c,b){if(typeof c!=="string"){c=a.toJSON(c)}var e=a("option"+(c?":not(:disabled)":""),d).filter(function(){return a(this).parents("select:first").is(d)});if(Object.isEmpty(c)&&!b){return e}return e.filter(function(){return a(this).attr("value")===c})},_querygroups:function(e,d,c){if(typeof d!=="string"){d=a.toJSON(d)}var b=a("optgroup"+(d?":not(:disabled)":""),e).filter(function(){return a(this).parents("select:first").is(e)});if(Object.isEmpty(d)&&!c){return b}return b.filter(function(){return a(this).attr("label")===d})},choice:function(c,b){if(Object.isNone(b)===true){return}var d=this._querychoices(c,b,true);return d.length>0?[b,d.first().text()]:undefined},choices:function(b){var c=[];this._querychoices(b).each(function(){c.push([a(this).attr("value"),a(this).text()])});return c},groups:function(c){var b=[];this._querygroups(c).each(function(){return b.push(a(this).attr("label"))});return b},selected:function(b){return this.choice(b,this.val(b))}})}(jQuery));(function(a){creme.widget=creme.widget||{};creme.widget.CheckListSelect=creme.widget.declare("ui-creme-checklistselect",{options:{datatype:"string",less:0},_create:function(e,d,b,f){var c=this;this._converter=d.datatype==="json"?creme.utils.JSON.decoder({}):null;this._lessCount=d.less||10;this._less=d.less>0||e.is("[less]");this.disabled(e,creme.object.isTrue(d.disabled)||e.is("[disabled]"));this._initializeController(e,d);a(".checklist-create",e).click(function(g){g.preventDefault();if(!c._disabled){c.createItem(e,a(this))}});a(e).delegate(".checklist-check-all:not([disabled])","click",function(){if(!c._disabled){c.selectAll(e)}});a(e).delegate(".checklist-check-none:not([disabled])","click",function(){if(!c._disabled){c.unselectAll(e)}});a(".checklist-filter",e).bind("propertychange keyup input paste",function(){c._updateViewFilter(e,a(this).val().toLowerCase())});a(".checklist-toggle-less",e).click(function(){c.less(e,!c.less(e))});a(e).delegate('.checkbox-field:not(.hidden):not(.disabled) input[type="checkbox"]',"change",function(h){var g=a(this);c._selections.toggle(parseInt(g.attr("checklist-index")),g.prop("checked"))});a(e).delegate(".checkbox-field:not(.hidden):not(.disabled) .checkbox-label","click",function(h){h.stopPropagation();var g=a(this).parent().find('input[type="checkbox"]');c._selections.toggle(parseInt(g.attr("checklist-index")),!g.prop("checked"))});e.addClass("widget-ready")},_getItemFilter:function(b){return function(c){return(!Object.isEmpty(c.label)&&c.label.toLowerCase().indexOf(b)!==-1)||(!Object.isEmpty(c.help)&&c.help.toLowerCase().indexOf(b)!==-1)}},_updateViewFilter:function(e,f){var b=!Object.isEmpty(f);var g=this.content(e);var d=g.is(".filter");var c=this._getItemFilter(f);g.toggleClass("filtered",b);if(d){this._model.each(function(h){h.visible=c(h)})}else{this._model.each(function(h){h.disabled=!c(h)})}this._controller.redraw();this._updateViewCounter(e);this._updateViewLess(e)},_updateViewSelection:function(c){var b=function(f,e){return creme.utils.compareTo(f.value,e)};var d=this._model.indicesOf(this.val(c)||[],b);this._selections.select(d)},_updateViewCounter:function(d){var b=a(".checklist-counter",d);var f=this._selections.selected().length;var g=a(".checkbox-field:not(.hidden)",this.content(d)).length;var c=this._model.length();var e=[];if(f>0){e.push(ngettext("%d selection","%d selections",f).format(f))}if(g!==c){e.push(ngettext("%d result of %d","%d results of %d",g).format(g,c))}b.toggleClass("visible",e.length>0).html(e.join("&nbsp;&nbsp;")+"&nbsp;");a(".checklist-check-all, .checklist-check-none",d).toggleClass("hidden",c<3);this._updateViewLessCounter(d);this._updateViewErrorState(d)},_updateDelegate:function(b){this._delegate(b).val(this.selected(b));b.change()},_updateViewLessCounter:function(e){var c=this._less;var g=this.content(e);var b=a('.checkbox-field:not(.hidden).more input[type="checkbox"]',g);var d=b.length;if(c){var f=[];var h=b.filter(":checked").length;f.push(ngettext("%d hidden item","%d hidden items",d).format(d));if(h>0){f.push(ngettext("(with %d selection)","(with %d selections)",h).format(h))}a(".checklist-toggle-less",e).html(f.join(" "))}else{a(".checklist-toggle-less",e).html(ngettext("Collapse %d item","Collapse %d items",d).format(d))}},_updateViewLess:function(f){var c=this._lessCount;var e=this._less;var g=this.content(f);var b=g.is(".filtered:not(.search)");var d=b?a(".checkbox-field.hilighted",g):a(".checkbox-field",g);var h=d.length>c;g.toggleClass("less",e);a(".checklist-toggle-less",f).toggleClass("is-active",h);if(h){d.each(function(i){a(this).toggleClass("more",i>c)})}else{d.removeClass("more")}this._updateViewLessCounter(f)},_updateViewErrorState:function(c){var d=this._delegate(c);var b=d.length>0&&d.is(".is-field-invalid:invalid");c.toggleClass("is-field-invalid",b)},_delegate:function(b){return a("select.ui-creme-input",b)},_initializeController:function(d,m){var k=this;var c=this.disabled(d);var j=this._delegate(d);var h=this.content(d);var i=new creme.model.CheckGroupListRenderer();var g=this._controller=new creme.model.CollectionController();var b=this._selections=new creme.model.SelectionController();var f=new creme.model.ChoiceGroupRenderer();var l=creme.model.ChoiceGroupRenderer.parse(j);var e=this._model=new creme.model.Array(l);b.model(e).selectionFilter(function(o,n){return !o.disabled&&o.visible}).on("change",function(){k._updateDelegate(d);k._updateViewCounter(d)});i.converter(this._converter).disabled(c);g.renderer(i).target(h).model(e).redraw();f.target(j).model(e);j.bind("change",function(){k._updateViewSelection(d)}).bind("invalid html5-invalid",function(){k._updateViewErrorState(d)});e.bind("add remove",function(){k._updateViewCounter(d);k._updateViewLess(d);f.redraw()});this._updateViewCounter(d);this._updateViewLess(d)},less:function(c,b){if(b===undefined){return this._less}this._less=b;this._updateViewLess(c);return this},disabled:function(b,c){if(c===undefined){return this._disabled}b.toggleAttr("disabled",c);this._disabled=c;a(".checklist-check-all, .checklist-check-none, .checklist-filter",b).toggleAttr("disabled",c);if(this._controller){this._controller.renderer().disabled(c);this._controller.redraw()}return this},content:function(b){var c=a(".checklist-content",b);return c.length===0?b:c},dependencies:function(b){return[]},reload:function(c,f,b,e,d){return this},update:function(b,c){},model:function(b){return this._controller.model()},val:function(c,f){var b=this._delegate(c);if(f===undefined){return b.val()}var e=this.val(c);var d=creme.utils.JSON.clean(f,[]);f=d.map(function(g){return typeof g!=="string"?a.toJSON(g):g});if(e===f){return this}if(b){b.val(f).change()}c.change();return this},cleanedval:function(b){return this.val(b).map(function(c){creme.utils.convert("string",this.options.datatype.toLowerCase(),c,c)})},createItem:function(c,d){if(this._disabled||d.is("[disabled]")){return this}var e=new creme.dialog.FormDialogAction();var b=this._model;e.onDone(function(f,g){g=creme.utils.JSON.clean(g);var h=creme.model.ChoiceGroupRenderer.choicesFromTuples(g.added||[]);b.patch({add:h})}).start({url:d.attr("href"),title:d.attr("title")})},reset:function(b){return this.unselectAll(b)},selected:function(b){return this._selections.selected().map(function(c){return c.value})},selectAll:function(b){this._selections.selectAll();return this},unselectAll:function(b){this._selections.unselectAll();return this}})}(jQuery));(function(a){creme.widget.DatePicker=creme.widget.declare("ui-creme-datepicker",{options:{format:"dd-mm-yy",readonly:false,disabled:false},_create:function(e,d,b,g){this._disabled=creme.object.isTrue(d.disabled)&&e.is("[disabled]");this._readonly=creme.object.isTrue(d.readonly)&&e.is("[readonly]");var c=this;var f=e.parent();var h=a("<ul/>").addClass("ui-layout hbox").append(a("<li/>").append(e));f.append(h);this._datepicker=e.datepicker({dateFormat:d.format,showOn:"button",buttonText:gettext("Calendar"),buttonImage:creme_media_url("images/icon_calendar.gif"),buttonImageOnly:true});h.append(a("<li/>").append(a("<span/>").addClass("ui-creme-datepicker-trigger").append(a("img.ui-datepicker-trigger",f))));this._buttons=this._initHelperButtons();this._buttons.forEach(function(i){h.append(a("<li/>").append(i))});this._updateDisabledState(this._disabled);e.addClass("widget-ready")},_updateDisabledState:function(b,c){var d=c||this._readonly;this._datepicker.datepicker("option","disabled",d);this._buttons.forEach(function(e){e.prop("disabled",d)})},_appendHelperButton:function(f,d,c,b){var g=this._datepicker;var e=a("<button>").attr("name",d).attr("type","button").html(gettext(c));e.click(function(h){h.preventDefault();g.datepicker("setDate",b(g.datepicker("getDate")))});f.push(e);return e},_initHelperButtons:function(){var b=[];this._appendHelperButton(b,"today","Today",function(c){return new Date()});return b},val:function(b,c){return b.val(c)}});creme.widget.DateTimePicker=creme.widget.declare("ui-creme-datetimepicker",{options:{format:"dd-mm-yy",readonly:false,disabled:false},_create:function(d,c,b,e){this._disabled=creme.object.isTrue(c.disabled)&&d.is("[disabled]");this._readonly=creme.object.isTrue(c.readonly)&&d.is("[readonly]");creme.forms.DateTimePicker.init(d,c.format);a('input[type="hidden"]',d).on("change",function(){var f=creme.forms.DateTimePicker.parseDateTime(a(this).val());a('li.date input[type="text"]',d).val(f.date);a('li.hour input[type="text"]',d).val(f.hour);a('li.minute input[type="text"]',d).val(f.minute)});this._datepicker=a('li.date input[type="text"]',d).datepicker();this._buttons=a('button[type="button"]',d);this._updateDisabledState(d,this._disabled);d.addClass("widget-ready")},_updateDisabledState:function(b,c){var d=c||this._readonly;this._datepicker.datepicker("option","disabled",d);this._buttons.prop("disabled",d);a('li input[type="text"]',b).toggleAttr("disabled",d)},val:function(b,c){if(c===undefined){return creme.forms.DateTimePicker.val(b)}a('input[type="hidden"]',b).val(c).change()}})}(jQuery));(function(a){creme.widget.DateRange=creme.widget.declare("ui-creme-daterange",{options:{},_create:function(e,d,b,f){var c=this;var g=this.dateType(e);g.on("change",function(){c._onTypeChange(e,a(this).val())});c._onTypeChange(e,g.val());e.addClass("widget-ready")},_onTypeChange:function(c,d){var b=Object.isEmpty(d);c.find("[data-daterange-field]").each(function(){a(this).parents(".daterange-field:first").toggleClass("hidden",!b)});if(!b){c.find("[data-daterange-field]").val("")}},reset:function(b){this.endDate().val("");this.startDate().val("");this.dateType().val("").change()},endDate:function(b){return a('[data-daterange-field="end"]',b)},startDate:function(b){return a('[data-daterange-field="start"]',b)},dateType:function(b){return a("[data-daterange-type]",b)}})}(jQuery));(function(a){creme.widget.DateRangeSelector=creme.widget.declare("ui-creme-daterange-selector",{options:{date_format:"dd-mm-yy"},_get_end:function(b){return a(".date-end",b)},_get_start:function(b){return a(".date-start",b)},_get_type:function(b){return a(".range-type",b)},_create:function(f,e,b,h){var d=this;var i=d.val(f);var g=a("span.daterange-inputs",f);var c={dateFormat:e.date_format,showOn:"button",buttonText:gettext("Calendar"),buttonImage:creme_media_url("images/icon_calendar.gif"),buttonImageOnly:true};d._get_type(f).bind("change",function(){if(a(this).val()){g.hide()}else{g.show()}d._update(f)});d._clean_daterpickers(g);a(".daterange-input",g).bind("change",function(){d._update(f)}).datepicker(c);if(!i){d._update(f);i=d.val(f)}d._update_inputs(f,i);f.addClass("widget-ready")},_clean_daterpickers:function(b){a(".daterange-input",b).removeAttr("id").removeClass("hasDatepicker");a("img.ui-datepicker-trigger",b).remove()},dependencies:function(b){return[]},reload:function(d,c,b,f,e){if(b!=undefined){b(d)}},_update:function(b){var c=a.toJSON({type:this._get_type(b).val(),start:this._get_start(b).val(),end:this._get_end(b).val()});creme.widget.input(b).val(c).change()},_update_inputs:function(c,d){var b=creme.widget.cleanval(d,{type:"",start:null,end:null});if(Object.isEmpty(b)){b={type:"",start:null,end:null}}if(b.type!==undefined){this._get_type(c).val(b.type).change();this._get_start(c).val(b.start).change();this._get_end(c).val(b.end).change()}},val:function(b,c){if(c===undefined){return creme.widget.input(b).val()}creme.widget.input(b).val(c);this._update_inputs(b,c)}})}(jQuery));(function(a){creme.widget.CHAINED_SELECT_BACKEND=new creme.ajax.CacheBackend(new creme.ajax.Backend(),{condition:new creme.ajax.CacheBackendTimeout(120*1000)});creme.widget.ChainedSelect=creme.widget.declare("ui-creme-chainedselect",{options:{backend:creme.widget.CHAINED_SELECT_BACKEND,json:true},_create:function(f,e,b,g){var d=this;this._enabled=creme.object.isFalse(e.disabled)&&f.is(":not([disabled])");this._context={};this.selectors(f).each(function(){a(this).creme().create({backend:d.options.backend,disabled:!d._enabled},undefined,true)});this._dependency_change=function(l){var k=a(this).parent().attr("chained-name");var j=d._context[k];var i=a(this).creme().widget().cleanedval();if(j!==i){d._reloadDependencies(f,k,i);d._update(f)}};this._dependency_change_multiple=function(m,l){m.stopPropagation();var j=a(this).parent().attr("chained-name");var k=d._selectorValues(f);var i=l.map(function(n){k[j]=n;return a.extend({},k)});f.trigger("change-multiple",[i])};a("img.reset",f).click(function(){if(d._enabled){d.reset(f)}});var h=this.cleanedval(f);var c=this._selectorValues(f);this._reloadSelectors(f,c);this.selectors(f).bind("change",d._dependency_change);this.selectors(f).bind("change-multiple",d._dependency_change_multiple);if(Object.isEmpty(h)){this.val(f,c)}else{this._updateSelectors(f,h);this._update(f)}f.addClass("widget-ready");creme.object.invoke(b,f)},_destroy:function(b){this.selectors(b).each(function(){a(this).creme().destroy()})},_selectorValues:function(b){var c={};this.selectors(b).each(function(){var d=a(this);var f=d.creme().widget().cleanedval();var e=d.parent().attr("chained-name");c[e]=f});return c},_update:function(b){this._context=this._selectorValues(b);creme.widget.input(b).val(a.toJSON(this._context))},_updateSelector:function(b,e){var c=b.element.parent().attr("chained-name");var d=typeof e==="object"?e[c]:undefined;b.val(d)},_updateSelectors:function(c,d){var b=this;this.selectors(c).each(function(){b._updateSelector(a(this).creme().widget(),d)})},_reloadSelector:function(f,b,e){var c=f.is(".widget-ready");var d=f.creme().widget();if(c&&a.inArray(b,d.dependencies())!==-1){d.reload(e,undefined,undefined,true)}},_reloadSelectors:function(c,d){for(var b in d){this._reloadDependencies(c,b,d[b])}},_reloadDependencies:function(d,c,f){var b=this;var e=this._context;e[c]=f;this.selectors(d).each(function(){b._reloadSelector(a(this),c,e)})},selector:function(c,b){return a('[chained-name="'+b+'"].ui-creme-chainedselect-item:last > .ui-creme-widget',c).filter(function(){return a(this).parents(".ui-creme-chainedselect:first").is(c)})},selectors:function(b){return a(".ui-creme-chainedselect-item > .ui-creme-widget",b).filter(function(){return a(this).parents(".ui-creme-chainedselect:first").is(b)})},reset:function(b){this.selectors(b).each(function(){a(this).creme().widget().reset()})},update:function(c,e){var e=creme.widget.cleanval(e,{});var d=e.added||[];var f=e.removed||[];var b=function(g){return Object.isEmpty(g)===false};this.selectors(c).each(function(){var h=a(this);var i=h.parent().attr("chained-name");var l=h.creme().widget();if(Object.isFunc(l.update)){var g=function(m){return m[i]};var j=d.map(g).filter(b);var k=f.map(g).filter(b);l.update({added:j,removed:k})}});return this.val(c,e.value)},context:function(b){return a.extend({},this._context)},val:function(b,c){if(c===undefined){return creme.widget.input(b).val()}this._updateSelectors(b,creme.widget.cleanval(c,{}));this._update(b);b.trigger("change")},clone:function(b){var d=creme.widget.clone(b);var c=this.val(d);if(!c){this._update(d)}return d}})}(jQuery));(function(a){creme.widget.SelectorList=creme.widget.declare("ui-creme-selectorlist",{options:{cloneLast:undefined},_create:function(e,d,b,f){var c=this;this._isCloneLast=creme.object.isTrue(d.cloneLast);this._enabled=creme.object.isFalse(d.disabled)&&e.is(":not([disabled])");if(!this._enabled){e.attr("disabled","")}a(".selectorlist-add",e).click(function(){if(c._enabled){c.appendLastSelector(e)}});a(".selectorlist-create",e).click(function(){if(c._enabled){c.createSelector(e)}});var g=this.val(e);if(Object.isEmpty(g)){this._update(e);g=this.val(e)}else{this._updateSelectors(e,g);this._update(e)}e.addClass("widget-ready");creme.object.invoke(b,e)},lastSelector:function(b){return a("ul.selectors > li.selector:last > ul > li > .ui-creme-widget",b)},selectorModel:function(b){return a(".inner-selector-model > .ui-creme-widget",b)},selectors:function(b){return a("ul.selectors > li.selector > ul > li > .ui-creme-widget",b)},selector:function(c,b){return a("ul.selectors > li.selector:nth("+(b||0)+") > ul > li > .ui-creme-widget",c)},removeSelectorAt:function(c,b){return this.removeSelector(c,this.selector(c,b))},removeSelector:function(c,b){if(Object.isEmpty(b)){return}b.creme().destroy();b.parents("li.selector:first").remove();this._update(c);return b},appendLastSelector:function(b){var c=this.lastSelector(b);var d=this._isCloneLast&&c.creme().isActive()?c.creme().widget().val():undefined;return this.appendSelector(b,d)},appendSelector:function(c,e,d){var b=this;var d=d||"select";return this._buildSelector(c,e,{done:function(g,f,h){if(h===undefined){f.triggerHandler("action",[d,{cancel:function(){b.removeSelector(c,f)}}])}else{f.creme().widget().val(h)}}})},appendSelectors:function(d,c,e){var b=this;return c.map(function(f){return b.appendSelector(d,f,e)})},createSelector:function(b,c){return this.appendSelector(b,c,"create")},_buildSelector:function(f,i,h){var k=this;var b=this.selectorModel(f).clone();if(Object.isEmpty(b)){creme.object.invoke(h.fail,"fail");return}var d=a("<li>").addClass("selector");var e=a("<ul>").addClass("ui-layout hbox").css("display","block").appendTo(d);var g=gettext("Delete");var j=a("<img/>").attr("src",creme_media_url("images/delete_22.png")).attr("alt",g).attr("title",g).attr("style","vertical-align:middle;").addClass("delete").click(function(){if(k._enabled){k.removeSelector(f,a("> ul > li > .ui-creme-widget",d))}});e.append(a("<li>").append(b));e.append(a("<li>").append(j));a("ul.selectors",f).append(d);b.bind("change",function(){k._update(f)});var c=creme.widget.create(b,{disabled:!this._enabled},function(){b.bind("change-multiple",function(m,l){k.appendSelectors(f,l.slice(1))});creme.object.invoke(h.done,"done",b,i)},true);if(c===undefined){d.remove();creme.object.invoke(h.fail,"fail")}return c},_update:function(c){var b=creme.widget.values_list(this.selectors(c));creme.widget.input(c).val("["+b.join(",")+"]")},_updateSelectors:function(d,e){var c=this;var b=creme.widget.cleanval(e,[]);if(typeof b!=="object"){return}a("ul.selectors",d).empty();b.forEach(function(f){c.appendSelector(d,f)})},val:function(b,c){if(c===undefined){return creme.widget.input(b).val()}this._updateSelectors(b,c);this._update(b)}})}(jQuery));(function(a){creme.widget.ENTITY_SELECT_BACKEND=new creme.ajax.CacheBackend(new creme.ajax.Backend(),{condition:new creme.ajax.CacheBackendTimeout(120*1000)});creme.widget.EntitySelectorMode={MULTIPLE:"multiple",SINGLE:"single"};creme.widget.EntitySelector=creme.widget.declare("ui-creme-entityselector",{options:{popupURL:"",popupSelection:creme.widget.EntitySelectorMode.SINGLE,labelURL:"",label:gettext("Select"),qfilter:"",backend:creme.widget.ENTITY_SELECT_BACKEND},_create:function(e,d,b,g){var c=this;this._enabled=creme.object.isFalse(d.disabled)&&e.is(":not([disabled])");if(!this._enabled){a(e).attr("disabled","");a("button",e).attr("disabled","")}a(e).bind("click",function(){if(c._enabled){c._select(e)}});a(e).bind("action",function(j,i,h){if(i==="select"){c._select(e,h)}});var f=this._popupSelectMode=d.popupSelection===creme.widget.EntitySelectorMode.MULTIPLE?creme.widget.EntitySelectorMode.MULTIPLE:creme.widget.EntitySelectorMode.SINGLE;this._popupURL=new creme.utils.Template(d.popupURL,{qfilter:d.qfilter,selection:f});this._reloadLabel(e,b,undefined,g);e.addClass("widget-ready")},dependencies:function(b){return this._popupURL.tags()},reload:function(c,f,b,e,d){this._popupURL.update(f);this.val(c,null);creme.object.invoke(b,c)},update:function(b,c){var c=creme.utils.JSON.clean(c,null);if(c!=null){this.val(b,c.value)}},_select:function(e,f){var c=this;var b=this.isMultiple();var d=this.popupURL(e);var f=f||{};creme.lv_widget.listViewAction(d,{multiple:b,closeOnEscape:true}).onDone(function(g,h){c.val(e,h[0]);if(h.length>1){a(e).trigger("change-multiple",[h])}creme.object.invoke(f.done,"done",e,h)}).onCancel(function(){creme.object.invoke(f.cancel,"cancel")}).onFail(function(){creme.object.invoke(f.fail,"fail")}).start()},_reloadLabel:function(c,i,e,f){var j=this.options;var d=a("button",c);var g=creme.widget.input(c).val();if(Object.isEmpty(g)===true){d.text(j.label);creme.object.invoke(i,c);return}var b=creme.widget.template(j.labelURL,{id:g});var h=gettext("Entity #%s (not viewable)").format(g);j.backend.get(b,{fields:["summary"]},function(l,k){try{d.html(l[0][0]||h)}catch(m){d.html(h)}creme.object.invoke(i,c,l)},function(l,k){d.html(h);creme.object.invoke(e,c,k)},{dataType:"json",sync:f})},isMultiple:function(b){return this._popupURL.parameters().selection===creme.widget.EntitySelectorMode.MULTIPLE},multiple:function(b,c){var c=c?creme.widget.EntitySelectorMode.MULTIPLE:creme.widget.EntitySelectorMode.SINGLE;this._popupURL.update({selection:c})},parentSelectorList:function(b){return b.parents(".ui-creme-selectorlist:first")},qfilter:function(b,c){this._popupURL.update({qfilter:c})},popupURL:function(b){return this._popupURL.render()||""},reset:function(b){this.val(b,null)},val:function(b,c){if(c===undefined){return creme.widget.input(b).val()}creme.widget.input(b).val(c);this._reloadLabel(b);b.trigger("change")},cleanedval:function(b){var c=this.val(b);return Object.isEmpty(c)?null:c}})}(jQuery));(function(a){creme.widget.PolymorphicSelect=creme.widget.declare("ui-creme-polymorphicselect",{options:{key:null,dependencies:""},_create:function(e,d,b,f){var c=this;this._context={};this._dependencies=Array.isArray(d.dependencies)?d.dependencies:(d.dependencies?d.dependencies.split(" "):[]);this._selectorKey=creme.utils.templatize(d.key,function(g){return c._context[g]});this._enabled=creme.object.isFalse(d.disabled)&&e.is(":not([disabled])");this._selector_onchange_cb=function(){e.change()};this._init_models(e);this.reload(e,{},b,b);e.addClass("widget-ready")},_destroy:function(b){this._removeSelector(b)},_init_models:function(b){var c=this._models=[];a("> script[selector-key]",b).each(function(){var e=new RegExp(a(this).attr("selector-key").replace(".",".").replace("*",".*"));var d=new creme.utils.Template(a(this).html());c.push({pattern:e,content:d})})},_updateSelector:function(e,c,g,b,f){var d=this;if(Object.isNone(c)){creme.object.invoke(b,e);return this}c.val(g)},_removeSelector:function(c){if(this._selector!==undefined){var b=this._selector;var c=b.element;c.unbind("change paste",this._selector_onchange_cb);b.destroy();c.remove();this._selector=undefined;this._selectorModel=undefined}if(this._target){this._target.remove();this._target=undefined}},_createSelector:function(f,e,i,c,h,g){var d=this;this._target=a("<span>").addClass("delegate").html(e).appendTo(f);var b=a("> .delegate > .ui-creme-widget:first",f);if(b.length!==1){return}creme.widget.create(b,{},function(j){creme.object.invoke(c,f);j.bind("change paste",d._selector_onchange_cb);f.change()},g);this._selector=b.creme().widget();this._selectorModel=e},toggleSelector:function(e,c,d,b,h){var i=this.val(e);var g=this._selector;var k=this._selectorModel;var j=this.selectorKey(e);var f=this.selectorModel(e,j);if(Object.isNone(f)){this._removeSelector(e);return}if(k!==undefined&&k===f){return this._updateSelector(e,g,i,d,h)}this._removeSelector(e);this._createSelector(e,f,null,d,b,h)},selectorKey:function(b){return(this._selectorKey&&this._selectorKey.iscomplete())?this._selectorKey.render()||"":""},selectorValue:function(c){var b=this.selector(c);return b!==undefined?b.val():null},selector:function(b){return this._selector},selectorModel:function(e,d){var f=this.selectorModels(e);for(var c in f){var b=f[c];if(typeof d==="string"&&d.match(b.pattern)!==null){return b.content.render(this._context)}}},selectorModels:function(b){return this._models||[]},dependencies:function(b){return(this._selectorKey?this._selectorKey.tags():[]).concat(this._dependencies)},reload:function(d,g,b,f,e){var c=this.selectorKey(d);this._context=a.extend({},this._context||{},g||{});this._selectorKey.parameters(this._context);this.toggleSelector(d,c,b,f,e)},reset:function(b){if(this._selector){this._selector.reset()}},val:function(b,c){if(c===undefined){return this._selector?this._selector.val():null}if(this._selector){this._selector.val(c)}}})}(jQuery));(function(a){creme.widget.ActionButton=creme.component.Action.sub({_init_:function(d,c,b){this._super_(creme.component.Action,"_init_",this._run,b);this._delegate=d;this._button=c;this.onDone(a.proxy(this._updateDelegate,this))},_updateDelegate:function(c,d){var b=this._delegate;if(Object.isEmpty(b)){return}var d=creme.utils.JSON.clean(d,null);if(d!==null){b.update(d)}else{b.reload()}},context:function(b){return Object.property(this,"_context",b)},dependencies:function(){return[]}});creme.widget.ResetActionButton=creme.widget.ActionButton.sub({_init_:function(d,c,b){this._super_(creme.widget.ActionButton,"_init_",d,c,b)},_run:function(b){var b=creme.widget.parseopt(this._button,{value:""});this.done({value:b.value},"success")}});creme.widget.CreateActionButton=creme.widget.ActionButton.sub({_init_:function(d,c,b){this._super_(creme.widget.ActionButton,"_init_",d,c,b)},_dialogOptions:function(){var b=creme.widget.parseopt(this._button,{popupResizable:true,popupDraggable:true,popupWidth:window.screen.width/2,popupHeight:356,popupUrl:"",popupTitle:""});var d=this._delegate;var c=Object.isFunc(d.context)?{_delegate_:d.context()}:{};c=a.extend(c,this._context);b.url=new creme.utils.Template(b.popupUrl).render(c);b.title=new creme.utils.Template(b.popupTitle).render(c);return b},updateButtonState:function(){var c=this._dialogOptions();var b=c.title||gettext("Add");this._button.toggleAttr("disabled",Object.isEmpty(c.url)).text(b)},_run:function(c){var b=this;var e=this._dialogOptions();if(Object.isEmpty(e.url)){b.cancel();return}var d=new creme.dialog.FormDialogAction();d.onDone(function(f,g){b.done(g)}).onCancel(function(f){b.cancel()}).start(e)}});creme.widget.ActionButtonList=creme.widget.declare("ui-creme-actionbuttonlist",{options:{debug:true},_create:function(e,d,b,f){var c=this;this._enabled=creme.object.isFalse(d.disabled)&&e.is(":not([disabled])");this._selector=creme.widget.create(c.selector(e),{disabled:!c._enabled});this._dependencies=Array.isArray(d.dependencies)?d.dependencies:(d.dependencies?d.dependencies.split(" "):[]);this._context={};if(!this._enabled){e.attr("disabled","");c.actions(e).attr("disabled","")}c.actions(e).click(function(){c._handleAction(e,a(this));return false});a(e).bind("action",function(i,g,h){c.doAction(e,g,h)});creme.object.invoke(b,e);e.addClass("widget-ready")},actions:function(b){return a("> li > button.ui-creme-actionbutton",b)},action:function(c,b){return a('> li > button.ui-creme-actionbutton[name="'+b+'"]',c)},doAction:function(d,b,e){var c=this.action(d,b);if(c.length===1){this._handleAction(d,c,e)}else{this._selector.element.triggerHandler("action",[b,e])}},selector:function(b){return a("> li.delegate > .ui-creme-widget",b)},dependencies:function(b){return creme.object.delegate(this._selector,"dependencies")||[]},url:function(c,b){if(b===undefined){return creme.object.delegate(this._selector,"url")}creme.object.delegate(this._selector,"url",b);return this},filter:function(b,c){if(c===undefined){return creme.object.delegate(this._selector,"filter")}creme.object.delegate(this._selector,"filter",c);return this},reload:function(c,f,b,e,d){creme.object.delegate(this._selector,"reload",f,b,e,d);this._context=a.extend({},this._context||{},f);this._updateActionButtons(c);return this},val:function(b,c){if(c===undefined){return creme.object.delegate(this._selector,"val")||""}creme.object.delegate(this._selector,"val",c);return this},reset:function(b,c){creme.object.delegate(this._selector,"reset");return this},cleanedval:function(b){return creme.object.delegate(this._selector,"cleanedval")||null},update:function(b,c){creme.object.delegate(this._selector,"update");return this},_updateActionButtons:function(d){var b=this;var c=this._context;this.actions(d).each(function(){var e=b._buildAction(d,a(this)).context(c);if(Object.isFunc(e.updateButtonState)){e.updateButtonState()}})},_buildAction:function(d,c){var f=new creme.component.Action();var e=creme.widget.parseopt(c,{action:"popup"}).action;var b=this["_action_"+e];if(Object.isFunc(b)){return b(this._selector,c)}return new creme.component.Action(function(){this.cancel()})},_handleAction:function(c,b,d){var e=this._buildAction(c,b);var d=d||{};if(!this._enabled){return e.on(d).cancel()}e.context(this._context).onDone(function(f,g){c.triggerHandler("actionSuccess",[g])}).onCancel(function(f){c.triggerHandler("actionCanceled")}).on(d).start();return e},_action_reset:function(b,c){return new creme.widget.ResetActionButton(b,c)},_action_popup:function(b,c){return new creme.widget.CreateActionButton(b,c)}})}(jQuery));(function(a){creme.widget.PlotProcessorRegistry=function(){this._processors={}};creme.widget.PlotProcessorRegistry.prototype={register:function(b,c){if(a.isFunction(this.processor(b))){throw new Error('processor "'+b+'" is already registered')}this._processors[b]=c},unregister:function(b){if(this.processor(b)===undefined){throw new Error('no such processor "'+b+'"')}delete this._processors[b]},processor:function(b){return this._processors[b]}};creme.widget.PlotProcessors=new creme.widget.PlotProcessorRegistry();a.extend(creme.widget.PlotProcessors,{preprocessOptions:function(b,h){for(var f in b){var g=b[f];if(typeof g=="object"){this.preprocessOptions(g,h)}else{if(typeof g==="string"&&/^preprocess\.[\w\d]+$/.test(g)){var d=g.substr("preprocess.".length);var j=b[d+"Options"];var c=this.processor(d);if(j!==undefined){delete b[d+"Options"]}try{b[f]=c(h,j)}catch(i){console.error(i)}}}}},preprocessData:function(f,d){var b=d;for(var c=0;c<f.length;++c){var e=f[c];e=(typeof e==="string")?{preprocessor:e}:e;e=a.extend({preprocessor:"",options:{}},e);b=this.processor(e.preprocessor)(b,e.options)}return b},preprocess:function(b){var e=b.options||{};var f=Object.isEmpty(b.data)?(e.dataDefaults||[]):b.data;var d=a.extend(true,{},e);var c=this.preprocessData(e.dataPreprocessors||[],f);this.preprocessOptions(d,c);return{options:d||{},data:c||[]}}});creme.widget.PlotProcessors.register("formatSerieLabel",function(e,c){var c=a.extend({format:"%s",seriesIndex:0},c);var b=c.seriesIndex;var f=b<e.length?e[b]:[];var d=function(g){return function(j,h,i){return g.format(j)}}(c.format);return f.map(new Generator().each(d).iterator())});creme.widget.PlotProcessors.register("formatEntryLabel",function(e,c){var c=a.extend({format:"%s",entryIndex:0},c);var b=c.entryIndex;var f=[];var d=function(h,g){return function(j,i,k){return h.format(j[g])}}(c.format,b);return e.map(d)});creme.widget.PlotProcessors.register("ticksLabel",function(d,c){var c=a.extend({labelIndex:2,seriesIndex:0},c);var f=c.labelIndex;var b=c.seriesIndex;var e=b<d.length?d[b]:[];return e.map(new Generator().get(f).iterator())});creme.widget.PlotProcessors.register("numberTicks",function(h,r){var r=a.extend({serieIndex:0,entryIndex:0,maxTicksCount:1,minTickInterval:0},r);var m=r.serieIndex;var n=r.entryIndex;var k=r.maxTicksCount;var c=r.minTickInterval;var l=m<h.length?h[m]:[];var j=l.map(function(t,s){return t[n]});j=j.filter(function(t,s,u){return u.indexOf(t)>=s});j.sort(function(t,s){return t-s});var p=Object.isNone(r.max)?j[j.length-1]:r.max;var g=Object.isNone(r.min)?j[0]:r.min;var i=p>g?Math.abs(p-g):Math.abs(p);var q=Math.min(j.length,k);var d=Math.max(i/q,c);var b=d;var o=Math.floor(Math.log(d)/Math.LN10);var f=Math.pow(10,o);var e=Math.round(d/f+0.5);if(e>5){b=10*f}else{if(e>2){b=5*f}else{if(e>1){b=2*f}else{b=f}}}return Math.min(Math.ceil(p/b)+1,k)});creme.widget.PlotProcessors.register("seriesLabel",function(d,c){var c=a.extend({defaults:{},labelIndex:3,entryIndex:0},c);var f=c.labelIndex;var b=c.entryIndex;var e=c.defaults;return d.map(new Generator().get(b).each(function(i,g,h){return a.extend({},e,{label:ArrayTools.get(i,f,"")})}).iterator())});creme.widget.PlotProcessors.register("seriesColor",function(d,c){var c=a.extend({colorIndex:2,entryIndex:0,defaultColor:"#cccccc"},c);var f=c.colorIndex;var b=c.entryIndex;var e=c.defaultColor;return d.map(new Generator().get(b).each(function(i,g,h){return ArrayTools.get(i,f,e)}).iterator())});creme.widget.PlotProcessors.register("swap",function(c,b){var b=a.extend({index:0,next:1},b);return c.map(function(e,d,f){return e.map(GeneratorTools.array.swap(b.index,b.next))})});creme.widget.PlotProcessors.register("fill",function(c,b){var b=a.extend({index:0,value:0},b);return c.map(function(e,d,f){return e.map(function(j,g,i){var h=j.slice();h.splice(b.index,0,b.value);return h})})});creme.widget.PlotProcessors.register("index",function(c,b){var b=a.extend({index:0},b);return c.map(function(e,d,f){return e.map(function(j,g,i){var h=j.slice();h.splice(b.index,0,g);return h})})});creme.widget.PlotProcessors.register("tee",function(d,c){var b=[];d.map(function(e){e.map(function(f){b.push([f])})});return b});creme.widget.PlotProcessors.register("percentSerie",function(e,d){var d=a.extend({seriesIndex:0,valueIndex:0},d);var b=d.entryIndex;var c=d.seriesIndex;var g=c<e.length?e[c]:[];var f=0;g.map(new Generator().get(b).each(function(h){f+=h}).iterator());return g.map(new Generator().each(GeneratorTools.array.ratio(b,f,100)).iterator())});creme.widget.PlotProcessors.register("percentEntry",function(d,c){var c=a.extend({valueIndex:0,targetIndex:undefined},c);var h=c.valueIndex;var b=c.targetIndex;var g=0;var f=new Generator().get(h).each(function(i){g+=i}).iterator();d.map(function(j,i,k){j.map(f)});var e=new Generator().each(GeneratorTools.array.ratio(h,g,100,b)).iterator();return d.map(function(j,i,k){return j.map(e)})});creme.widget.PlotProcessors.register("format",function(c,b){var b=a.extend({format:"%s",targetIndex:undefined},b);var d=new Generator().each(GeneratorTools.array.format(b.format,b.targetIndex)).iterator();return c.map(function(f,e,g){return f.map(d)})})}(jQuery));(function(a){creme.widget.PlotEventHandlerRegistry=function(){this._handlers={}};creme.widget.PlotEventHandlerRegistry.prototype={register:function(b,c){if(a.isFunction(this.get(b,null))){throw new Error('handler "'+b+'" is already registered')}this._handlers[b]=c},unregister:function(b){if(this.get(b)===undefined){throw new Error('no such handler "'+b+'"')}delete this._handlers[b]},get:function(b,d){var c=this._handlers[b];if(a.isFunction(c)===false){if(d===undefined){throw new Error('no such plot event handler "'+b+'"')}return d}return this._handlers[b]}};creme.widget.PlotEventHandlers=new creme.widget.PlotEventHandlerRegistry();creme.widget.PlotEventHandlers.register("redirect",function(f,b,e,g,d){var c=d.url.format(g);if(d.url!==c&&!Object.isEmpty(c)){window.location=c}});creme.widget.PlotEventHandlers.register("popup",function(f,b,e,g,d){var c=d.url.format(g);if(d.url!==c&&!Object.isEmpty(c)){creme.dialogs.url(d.url.format(g),{title:d.url.format(g)}).open()}});creme.widget.Plot=creme.widget.declare("ui-creme-jqueryplot",{options:{plotmode:"svg",savable:false,resizable:false,"resize-delay":200},_create:function(g,f,b,h,e){var d=this;var c=!a.matchIEVersion(7,8);this._israster=f.plotmode=="raster"&&c;this._issavable=f.savable=="true"&&c;this._plot_info={options:{},data:[]};this._plot_handlers=[];g.bind("resizestop",function(){d._onResize(g)});this.draw(g,this.plotScript(g),b,b)},_rasterImage:function(e,d,b){var c=document.createElement("img");var f=e.jqplotToImageStr(b);c.onload=function(){d(c)};c.src=f;return c},_popupRasterImage:function(b){this._rasterImage(this._plot,function(c){creme.dialogs.image(c,{title:gettext("Canvas image")}).open()})},_draw:function(e,d,c){var f=e.attr("width")||e.width();var b=e.attr("height")||e.height();var h=a("<div>").width(f).height(b).css("margin","0").css("border","0").css("padding","0").attr("id",creme.object.uuid());try{if(this._israster){this._drawRaster(e,h,d.data,d.options,c)}else{this._drawSVG(e,h,d.data,d.options,c)}}catch(g){console.error(g);h.remove();throw g}},_drawRaster:function(d,f,e,c,b){f.css("visibility","hidden");d.append(f);if(Object.isEmpty(e)){creme.object.invoke(b,d);return}return this._rasterImage(f.jqplot(e,c),function(g){f.remove();d.append(a("<div>").addClass("jqplot-target").append(a(g)).css("margin","0").css("border","0").css("padding","0").css("overflow","hidden"));creme.object.invoke(b,d)})},_populateSVGActions:function(d,e,c){var b=this;var f=a('<div class="jqplot-actions">');if(this._issavable){f.append(a("<button>").attr("title",gettext("View as image")).attr("alt",gettext("View as image")).attr("name","capture").bind("click",function(){b._popupRasterImage()}))}e.append(f)},_drawSVG:function(e,g,f,d,b){var c=this;if(Object.isEmpty(f)){creme.object.invoke(b,e);return}e.append(g);c._plot=g.jqplot(f,d);c._plot_id=g.attr("id");c._populateSVGActions(e,g,d);c._bindPlotHandlers(c._plot,d);creme.object.invoke(b,e)},_bindPlotHandlers:function(d,c){var b=this;c.handlers.forEach(function(e){d.bind(e.event,function(h,f,g,i){e.action.apply(b,[h,f,g,i,e])})})},_jqplotRenderer:function(b){var c=b?a.jqplot[b]:undefined;if(typeof c!=="function"){throw'no such renderer "'+b+'"'}return c},_parseJQPlotOptions:function(d){for(var b in d){var c=d[b];if(typeof c==="object"){this._parseJQPlotOptions(c)}else{if(typeof c==="string"&&/^jqplot\.[\w\d]+$/.test(c)){d[b]=this._jqplotRenderer(c.substr("jqplot.".length))}}}return d},_preprocessPlotHandlers:function(b){var b=b||[];var c=[];b.forEach(function(e){var e=e||{};var d=e.action||"redirect";var f=e.event||"click";var f=f.length>1?f.substr(0,1).toUpperCase()+f.substr(1).toLowerCase():f;c.push(a.extend({},e,{event:"jqplotData"+f,action:creme.widget.PlotEventHandlers.get(d)}))});return c},_convertData:function(c,b){return creme.utils.converters.convert(b.dataFormat||"jqplotData","jqplotData",c)},_preprocess:function(){var b=this._plot_info;if(b.built!==undefined){return b.built}b.built=creme.widget.PlotProcessors.preprocess(b);b.built.options.handlers=this._preprocessPlotHandlers(b.built.options.handlers);if(this._issavable){b.built.options.title=b.built.options.title||"&nbsp;"}return b.built},_onDrawSuccess:function(c,d,b){c.addClass("widget-ready").attr("status","valid");c.trigger("plotSuccess",[this._plot,d]);creme.object.invoke(b,c)},_onDrawError:function(c,d,e,b){c.addClass("widget-ready").attr("status","error");c.trigger("plotError",[d,e]);creme.object.invoke(b,c)},_onBeforeDraw:function(b){b.removeClass("widget-ready");this.clear(b);b.attr("status","wait")},_onResize:function(d){var b=this;var c=this.options["resize-delay"]||0;if(this.options.resize===false||d.is('[status="wait"]')){return}creme.object.deferred_start(d,"jqplot-resize",function(){b.redraw(d)},c)},clear:function(c,b){a("> .jqplot-target",c).remove();c.attr("status",b||"valid")},draw:function(d,g,b,f){var c=this;try{c._onBeforeDraw(d);c.plotInfo(d,g);c._draw(d,c._preprocess(),function(){c._onDrawSuccess(d,g,b)})}catch(e){c._onDrawError(d,e,g,f)}},redraw:function(d,b,f){var c=this;var g=null;try{c._onBeforeDraw(d);g=c._preprocess();c._draw(d,g,function(){c._onDrawSuccess(d,g,b)})}catch(e){c._onDrawError(d,e,g,f)}},plotOptions:function(c,b){if(b===undefined){return this._plot_info.options}var b=creme.utils.JSON.clean(b);this._plot_info.options=this._parseJQPlotOptions(b||{});this._plot_info.built=undefined},plotData:function(b,c){if(c===undefined){return this._plot_info.data}var c=creme.utils.JSON.clean(c);this._plot_info.data=this._convertData(c,this._plot_info.options);this._plot_info.built=undefined},plotInfo:function(e,g){if(g===undefined){return this._plot_info}var d=this;var b=this._plot_info;if(Object.isEmpty(g)){b={options:{},data:[]};return}var c=creme.utils.JSON.clean(g);var f=a.isArray(c)?{data:c}:c;b.options=this._parseJQPlotOptions(f.options||b.options);b.data=this._convertData(f.data,b.options);b.built=undefined},plotScript:function(b){return a('> script[type="text/json"]',b).html()},plot:function(b){return this._plot},preprocess:function(b){return this._preprocess()}})}(jQuery));(function(a){creme.widget.PLOT_SELECTOR_BACKEND=new creme.ajax.CacheBackend(new creme.ajax.Backend(),{condition:new creme.ajax.CacheBackendTimeout(120*1000)});creme.widget.PlotSelector=creme.widget.declare("ui-creme-plotselector",{options:{"plot-data-url":"","plot-name":undefined,backend:creme.widget.PLOT_SELECTOR_BACKEND,initial:{}},_create:function(e,d,b,f){var c=this;this._plot_data_url=new creme.utils.Template(d["plot-data-url"]);this._plot_name=(d["plot-name"])?new creme.utils.Template(d["plot-name"]):undefined;d.initial=creme.widget.cleanval(d.initial,{});this._initPlot(e,function(){c.reload(e,d.initial,b,b,f)},f)},_initPlot:function(c,b,d){a(".ui-creme-jqueryplot:first",c).creme().create({},b,d)},_delegate:function(b){return a(".ui-creme-jqueryplot:first",b).creme().widget()},_updatePlotOptions:function(c,g,e){try{if(Object.isNone(this._plot_name)){g.plotInfo(g.plotScript());return}this._plot_name.update(e);var d=this._plot_name.render();var f=this.plotOption(c,d);if(f===null){g.plotInfo(g.plotScript());return}g.plotOptions(f)}catch(b){throw new Error("unable to update plot options : "+b)}},_updatePlotData:function(i,h,b,e){var c=this;var f=this.options.backend;var g=this._plot_data_url;g.update(h);if(g.iscomplete()===false){c._plot_last_url=undefined;i.plotData([]);throw new Error("incomplete data url")}var d=g.render();if(Object.isEmpty(d)){throw new Error("empty data url")}f.get(d,{},function(j){i.plotData(creme.widget.cleanval(j,[]));creme.object.invoke(b,i.plotData())},function(k,j){c._plot_last_url=undefined;i.plotData([]);creme.object.invoke(b,i.plotData())},a.extend({dataType:"json"},e))},plotOptions:function(c){var b=[];a('> script[type="text/json"]',c).each(function(){b.push([a(this).attr("name"),a(this).html()||null])});return b},plotOption:function(c,b){return a('> script[type="text/json"][name="'+b+'"]',c).html()||null},dependencies:function(b){var c=this._plot_data_url.tags();if(this._plot_name){c=c.concat(this._plot_name.tags())}return c},_onRedrawOk:function(c,e,d,b){c.addClass("widget-ready");creme.object.invoke(b,c,d)},_onRedrawError:function(d,e,c,b){e.clear("error");d.addClass("widget-ready");creme.object.invoke(b,d,c)},reload:function(e,d,c,b,h,j){var i=this;var f=this._delegate(e);if(Object.isNone(f)){creme.object.invoke(b,e,new Error("Plot not initialized"));return}try{e.removeClass("widget-ready");this._updatePlotOptions(e,f,d);this._updatePlotData(f,d,function(k){f.redraw(function(){i._onRedrawOk(e,f,k,c)},function(){i._onRedrawError(e,f,null,b)})},j)}catch(g){i._onRedrawError(e,f,g,b)}},resetBackend:function(b){if(this.options.backend&&this.options.backend.entries){this.options.backend.entries={}}},reset:function(b){this._plot_data_url.parameters({});if(this._plot_name!==undefined){this._plot_name.parameters({})}this.reload(b,this.options.initial)},val:function(b,c){return null},cleanedval:function(b){return null}})}(jQuery));(function(a){creme.widget.ScrollActivator=creme.widget.declare("ui-creme-scrollactivator",{options:{scroll:"absolute",delay:50},_scrollBox:function(b){var c=this;var d={top:b.scrollTop(),left:b.scrollLeft(),width:c._isrelative?b.width():a(window).width(),height:c._isrelative?b.height():a(window).height()};d.bottom=(d.top+d.height);d.right=(d.left+d.width);return d},_collide:function(f,e){var h=this._isrelative?f.top+e.position().top:e.offset().top;var g=this._isrelative?f.left+e.position().left:e.offset().left;var c=h+e.height();var d=g+e.width();var b=!(f.bottom<h||f.top>c)&&!(f.left>d||f.right<g);return b},_activables:function(d,b){var c=this;if((d.is(":visible")&&c._collide(c._scrollBox(a(document)),d))==false){return}var e=c._scrollBox(b);return a(".ui-creme-widget:not(.widget-active)",d).filter(function(){return c._collide(e,a(this))})},_activateItem:function(c,b){creme.object.deferred_start(c,"creme.widget.scrollactivator.activate_item",function(){c.creme().create()},b)},_activate:function(c){var b=this;creme.object.deferred_start(c,"creme.widget.scrollactivator.activate",function(){var d=b._activables(c,b._container);if(d){d.each(function(e){b._activateItem(a(this))})}},b._delay)},_create:function(f,e,b,g,d){var c=this;c._delay=e.delay;c._isrelative=e.scroll=="relative";c._container=c._isrelative?a(f):a(document);c._container.scroll(function(){c._activate(f)});c._activate(f);f.addClass("widget-ready")}})}(jQuery));(function(a){creme.widget.CONTAINER_LAYOUTS={column:function(c){var c=c||{};var e=c["column-count"]||1;var d=c["column-size"];var f=Object.isEmpty(c["sort-by"])?undefined:c["sort-by"];var b=f?function(h,g){return a(h).attr(f).localeCompare(a(g).attr(f))}:undefined;return new creme.layout.ColumnSortLayout({columns:Object.isEmpty(d)?e:d,resizable:c.resizable,comparator:b})},sort:function(c){var c=c||{};var d=Object.isEmpty(c["sort-by"])?undefined:c["sort-by"];if(d===undefined){return null}var b=function(f,e){return a(f).attr(d).localeCompare(a(e).attr(d))};return new creme.layout.SortLayout({comparator:b,reverse:c["sort-reverse"]})}};creme.widget.Container=creme.widget.declare("ui-creme-container",{options:{layout:"none","sort-by":"","sort-reverse":false,"column-count":1,"column-size":undefined,resizable:false},_create:function(d,c,b,f){c["sort-reverse"]=creme.object.isTrue(c["sort-reverse"])||d.is("[sort-reverse]");c.resizable=creme.object.isTrue(c.resizable)||d.is("[resizable]");var g=creme.widget.CONTAINER_LAYOUTS[c.layout];var e=Object.isFunc(g)?g(c):undefined;this.layout(d,e);d.addClass("widget-ready")},_destroy:function(b){if(this._layout!==undefined){this._layout.unbind(b)}},layout:function(b,c){if(c===undefined){return this._layout}if(this._layout!==undefined){this._layout.unbind(b)}this._layout=c;this._layout.bind(b).layout()}})}(jQuery));(function(a){creme.menu={};creme.menu.actions={};creme.menu.NavIt=function(c,b,d){console.warn("creme.menu.NavIt() is deprecated.");var b=b||{};var d=d||{};a(c).NavIt(b);a(c).find("a").click(function(l){l.preventDefault();var k=a(this);var h=k.hasClass("confirm");var j=k.hasClass("post")?"post":"get";var i=k.hasClass("ajax");var g=k.prop("href");if(i){var f=a.extend({action:j,link:k},b.queryOptions||{});if(h){creme.utils.confirmAjaxQuery(g,f).on(d).start()}else{creme.utils.ajaxQuery(g,f).on(d).start()}}else{if(h){creme.utils.confirmBeforeGo(g,i,opts)}else{creme.utils.goTo(g)}}})};creme.menu.HNavIt=function(c,b,d){console.warn("creme.menu.HNavIt() is deprecated.");creme.menu.NavIt(c,a.extend({ArrowSideOnRight:false},b||{}),d)};creme.menu.sideMenu=function(l){console.warn("creme.menu.sideMenu() is deprecated.");var e=a(document).width();var b=a(document).height();function c(){a("#menu_collapse").mouseenter(function(m){a("#menu_expanded").show("fast");a("#menu_collapse").hide("fast")});a("#menu_expanded").mouseleave(function(m){a("#menu_expanded").hide("fast");a("#menu_collapse").show("fast")})}function k(){a("#menu_collapse").unbind("mouseenter");a("#menu_expanded").unbind("mouseleave")}function h(m,o){var r=a("#top");var q=a("#content");var s=a("#footer");var p=(o)?m+5+"px":m;r.css("margin-left",p);q.css("margin-left",p);s.css("margin-left",p);var n=e-m;if(o){n-=10}r.width(n);q.width(n);s.width(n)}var g=a("#logo_container").outerHeight();var i=a("#menu_expanded").outerHeight();a("#menu").menu({content:a("#tree_menu2").html(),flyOut:false,backLink:false,alwaysOpen:true,maxHeight:i,crumbDefaultText:l.title,topLinkText:l.back});a("#menu").hide();a(".fg-menu-container").appendTo("#menu_expanded").css({top:g,bottom:"auto"});a("#menu_expanded").width(a(".fg-menu-container").outerWidth());var f=function(){k();h(a("#menu_expanded").outerWidth(),true);a.cookie("menu_creme","expanded",{expires:7,path:"/",domain:"",secure:false})};var j=function(){c();h(a("#menu_collapse").outerWidth(),false);a.cookie("menu_creme","collapse",{expires:7,path:"/",domain:"",secure:false})};if(a.cookie("menu_creme")=="expanded"){a(".pinmenu").addClass("expanded");k();h(a("#menu_expanded").outerWidth(),true);a("#menu_expanded").show();a("#menu_collapse").hide()}else{c();h(a("#menu_collapse").outerWidth(),false);a("#menu_expanded").hide();a("#menu_collapse").show()}a(".pinmenu").on("click",function(){a(this).toggleClass("expanded");if(a(this).is(".expanded")){f()}else{j()}});a("#menu_collapse").css("height",a(document).height());a("#menu_expanded").css("height",a(document).height());a("#menu_expanded").on("menu-item-selected","#active-menuitem a",function(n,o){n.stopImmediatePropagation();var m=a(this).prop("href");creme.utils.goTo(m)});(function d(){a(window).scroll(function(){var m=a(".fg-menu-container");if(a(this).scrollTop()>a("#logo_container").outerHeight()){m.addClass("top_fixed");m.css("left",-a(window).scrollLeft()+"px")}else{m.removeClass("top_fixed")}})})();a("#logo_container").one("load",function(){var w=a("#logo_container").outerHeight();a(".fg-menu-container").css({top:w});var r=window.location.pathname;if(r!=null){var n=a("#menu_expanded div.fg-menu-container").find('[href="'+r+'"]');var p=null;var q=[];var u=true;var v=n.parent("li");q.push(v);var s=30;var x=0;while(u&&x<=s){var t=v.parent("ul");v=t.parent("li");if(v.size()==0){u=false}else{q.push(v)}x++}var m=+new Date;for(var o=q.length-1;o>0;o--){q[o].find("a:first").click()}}})};creme.menu.bindEvents=function(){var c=a(".ui-creme-navigation");var b=c.children("li");b.hover(function(d){a(this).addClass("ui-creme-navigation-activated")},function(d){a(this).removeClass("ui-creme-navigation-activated")});b.click(function(g){if(g.target!=this){return}var f=c.children("li.ui-creme-navigation-activated");var d=a(g.currentTarget);if(f.length>0&&f.index()!=d.index()){f.removeClass("ui-creme-navigation-activated")}if(f.length==0||f.index()!=d.index()){d.addClass("ui-creme-navigation-activated")}})};creme.menu.openQuickForm=function(b){a(".ui-creme-navigation-activated").removeClass("ui-creme-navigation-activated");if(creme.menu.currentPopup){creme.menu.currentPopup.close()}creme.menu.currentPopup=creme.dialogs.form(b.attr("data-href"),{reloadOnSuccess:true}).open()};creme.menu.openCreateAnyDialog=function(k){a(".ui-creme-navigation-activated").removeClass("ui-creme-navigation-activated");if(creme.menu.currentPopup){creme.menu.currentPopup.close()}var c=JSON.parse(k.getAttribute("data-grouped-links"));var b=a("<div>").addClass("create-all-form");var n=1;for(var d in c){var g=c[d];var o=a("<div>").addClass("create-group-container").addClass("create-group-container-%s-columned".format(g.length)).appendTo(b);n=Math.max(n,g.length);for(var e in g){var h=g[e];var m=a("<div>").addClass("create-group").appendTo(o);a("<div>").addClass("create-group-title").text(h.label).appendTo(m);var f=h.links;for(var e=0;e<f.length;++e){var l=f[e];if(l.url!==undefined){a("<a>").addClass("create-group-entry").attr("href",l.url).text(l.label).appendTo(m)}else{a("<span>").addClass("create-group-entry forbidden").text(l.label).appendTo(m)}}}}creme.menu.currentPopup=creme.dialogs.html(b[0].outerHTML,{title:gettext("Chose the type of entity to create"),width:Math.max(550,n*200)}).open()}}(jQuery));(function(a){creme.search=creme.search||{};creme.search.SearchBox=function(b,d,c){this.$element=a(b);this.$input=this.$element.find("input");this.$input.bind("focus",this._onShow.bind(this));this.$input.bind("input",creme.utils.debounce(this._onInput.bind(this),200));this.$input.bind("keydown",this._onKeyDown.bind(this));this.$resultsRoot=this.$element.find(".inline-search-results");this.$icon=this.$element.find(".search-box-icon");this.$allResultsGroup=this.$element.find(".all-search-results");this.$allResultsLink=this.$allResultsGroup.find("a");this.glasspane=new creme.dialog.GlassPane();this.glasspane.on("click",this._onHide.bind(this));this.state="default";this.searchUrl=d;this.advancedSearchUrl=c};creme.search.SearchBox.prototype={_onShow:function(b){this.glasspane.open(a(".header-menu"));this.$resultsRoot.addClass("showing")},_onHide:function(b){this.$input.blur();this.$resultsRoot.removeClass("showing");this.glasspane.close()},_onKeyDown:function(c){if(c.keyCode==27){this._onHide()}if(this.state!="loaded"){return}if(c.keyCode!=38&&c.keyCode!=40&&c.keyCode!=13){return}c.preventDefault();if(c.keyCode==38){var b=(this.selected-1)%this.linksCount;if(b>=0){this._setSelectedResult(b)}}else{if(c.keyCode==40){var b=(this.selected+1)%this.linksCount;if(b>=0){this._setSelectedResult(b)}}else{if(c.keyCode==13){this._goToSelection()}}}},_onInput:function(c){var b=this.$input.val().trim();var d=b=="";if(this.state=="default"){if(d==false){this._switchToLoading(b)}}else{if(this.state=="loading"){if(d){this._switchToDefault()}else{this._switchToLoading(b)}}else{if(this.state=="loaded"){if(d){this._switchToDefault()}else{if(this.query!=b){this._switchToLoading(b)}}}}}},_switchToLoading:function(b){if(b.length<3){return}this.$icon.removeClass("default").addClass("loading");this.$allResultsLink.text(gettext("Loading"));this._resetSelection();this.$allResultsGroup.siblings().remove();this._asynchronousRequest(b,new Date().getTime());this.state="loading"},_asynchronousRequest:function(c,b){this.timestamp=b;var d=this.searchUrl+"?value="+encodeURIComponent(c);a.getJSON(d,function(i){var j=[];var n=0;for(var m in i.results){n+=i.results[m].count}if(n>0){if(n>1){var g=i.best;var h=("<div class='search-results-group best-results-group'><span class='search-results-group-title'>%s</span><ul class='search-results'><li class='search-result'><a href='%s'>%s</a></li></ul></div>").format(gettext("Best result"),g.url,a("<div>").text(g.label).html());j.push(h)}for(var m in i.results){var k=i.results[m];var l=this.advancedSearchUrl+"?ct_id="+k.id+"&research="+encodeURIComponent(c);var e=k.results.map(function(p){return"<li class='search-result'><a href='%s'>%s</a></li>".format(p.url,a("<div>").text(p.label).html())});var f=k.label;var o=("<div class='search-results-group'><span class='search-results-group-title'><a href='%s'>%s</a></span><ul class='search-results'>%s</ul></div>").format(l,f,e.join("\n"));j.push(o)}}this._onResultsReceived(c,b,j,n)}.bind(this))},_switchToDefault:function(){this.$icon.removeClass("loading").addClass("default");this.$allResultsLink.text(gettext("Advanced search"));this.$allResultsLink.attr("href",this.advancedSearchUrl);this._resetSelection();this.$allResultsGroup.siblings().remove();this.state="default";this.timestamp=null},_switchToLoaded:function(){this.$icon.removeClass("loading").addClass("default");this.state="loaded"},_onResultsReceived:function(e,d,c,b){if(this.timestamp==null||d<this.timestamp){return}this.resultCount=b;if(c){this.$allResultsGroup.after(c);this.$results=this.$resultsRoot.find(".search-result");this.linksCount=this.$results.size()}if(this.resultCount>0){this.$allResultsLink.attr("href",this.advancedSearchUrl+"?research="+encodeURIComponent(e));this.$allResultsLink.text(gettext("All results (%s)").format(this.resultCount));this._setSelectedResult(1)}else{this.$allResultsLink.attr("href","");this.$allResultsLink.text(gettext("No result"))}this._switchToLoaded()},_resetSelection:function(){this.$resultsRoot.find(".search-result-selected").removeClass("search-result-selected")},_setSelectedResult:function(b){this._resetSelection();this.selected=b;this.$selected=this.$results.eq(b).addClass("search-result-selected");if(this.$selected.length>0){this.$selected[0].scrollIntoView()}},_goToSelection:function(){if(this.resultCount>0){var b=this.$selected.find("a");window.location.href=b.attr("href")}}}}(jQuery));(function(b){creme.bricks=creme.bricks||{};creme.bricks.dialogCenterPosition=function(c){var d=b(".header-menu").outerHeight();if(c.dialog().parents(".ui-dialog:first").position().top<d){c.position({my:"center top",at:"center top+"+(2*d),of:window})}};creme.bricks.dialogActionButtons=function(c){var d=b("a.brick-dialog-action",c.content()).map(function(f){var g=b(this);var e=g.contents().map(function(){return this.nodeType===3?this.data:""}).get().join("");return{text:e,click:function(h){h.preventDefault();creme.utils.goTo(g.attr("href"))}}}).get();if(Object.isEmpty(d)===false){d=d.concat(c.dialog().dialog("option","buttons"));c.replaceButtons(d);if(c.options.fitFrame){c.fitToFrameSize()}}};creme.bricks.DialogAction=creme.dialog.DialogAction.sub({_init_:function(c,d){this._super_(creme.dialog.DialogAction,"_init_",c,d)},_buildPopup:function(d){var c=this._super_(creme.dialog.DialogAction,"_buildPopup",d);return c.on("frame-activated",function(){creme.bricks.dialogActionButtons(this);creme.bricks.dialogCenterPosition(this)})}});creme.bricks.FormDialogAction=creme.dialog.FormDialogAction.sub({_init_:function(c,d){this._super_(creme.dialog.FormDialogAction,"_init_",c,d)},_buildPopup:function(d){var c=this._super_(creme.dialog.FormDialogAction,"_buildPopup",d);return c.on("frame-update",function(){creme.bricks.dialogCenterPosition(this)})}});creme.bricks.BrickMenu=creme.component.Component.sub({_init_:function(d,c){this._options=b.extend({direction:"right"},c||{});this._brick=d;this._disabled=true},bind:function(d){if(this.isBound()){throw new Error("BrickMenu is already bound")}var c=this.toggle.bind(this);var e=this._menuContent(d);var f=this._disabled=b("a",e).length<1;this._element=d;this._dialog=new creme.dialog.Popover(this._options).fill(e);b(".brick-header-menu",d).toggleClass("is-disabled",f).click(function(g){c(g.target)})},unbind:function(){if(!this.isBound()){throw new Error("BrickMenu is not bound")}this.close();this._dialog=null;this._element=null;this._disabled=true},_menuContent:function(c){return b(".brick-menu-buttons",c)},isBound:function(){return Object.isNone(this._element)===false},isDisabled:function(){return !this.isBound()||this._disabled},isOpened:function(){return this.isBound()&&this._dialog.isOpened()},toggle:function(c){if(!this.isDisabled()&&!this._brick.isLoading()){this._dialog.toggle(c)}},close:function(){if(this.isBound()){this._dialog.close()}},open:function(c){if(!this.isDisabled()&&!this._brick.isLoading()){this._dialog.open(c)}}});creme.bricks.BrickActionLink=creme.action.ActionLink.sub({_init_:function(d,c){this._super_(creme.action.ActionLink,"_init_",c);this._brick=d;this.builders(this._brickActionBuilder.bind(this))},_brickActionBuilder:function(e){var d=this._brick;var c=d._getActionBuilder(e);if(Object.isFunc(c)){return function(g,f,h,i){if(!d.isLoading()){d.closeMenu();return c(g,f||{},h||{},i)}}}}});creme.bricks.BrickSelectionController=creme.component.Component.sub({_init_:function(d){this._options=b.extend({rows:"tr",renderer:this._defaultItemStateRenderer,parser:this._defaultItemStateParser},d||{});var c=this._model=new creme.model.Array();c.bind("update",this._onItemUpdate.bind(this));this._selections=new creme.model.SelectionController().model(c)},_defaultItemStateRenderer:function(c){c.ui.toggleClass("is-selected",c.selected)},_defaultItemStateParser:function(d,c){return d.is(".is-selected")},_onItemUpdate:function(f,d,h,c,e,g){d.forEach(this._options.renderer)},bind:function(d){var c=this._options;var e=c.parser;this._model.reset(b(c.rows,d).map(function(f){var g=b(this);g.attr("data-row-index",f);return{selected:e(g,f),ui:g}}).get());return this},state:function(){return this._selections}});if(b.ui.sortable.prototype._nativeMouseStart===undefined){var a=b.ui.sortable.prototype._mouseStart;b.ui.sortable.prototype._nativeMouseStart=a;b.ui.sortable.prototype._mouseStart=function(d,e,c){this._trigger("beforeStart",d,this._uiHash());a.apply(this,[d,e,c])}}creme.bricks.BrickTable=creme.component.Component.sub({_init_:function(d,c){this._options=c||{};this._brick=d;this._selections=new creme.bricks.BrickSelectionController({rows:"tr",renderer:function(e){e.ui.toggleClass("is-selected",e.selected);b('input[type="checkbox"]',e.ui).prop("checked",e.selected)}});this._events=new creme.component.EventHandler()},on:function(d,e,c){this._events.on(d,e,c);return this},off:function(c,d){this._events.off(c,d);return this},one:function(c,d){this._events.one(c,d);return this},selections:function(){return this._selections.state()},isBound:function(){return Object.isNone(this._element)===false},_updateSelectionState:function(){var e=this._selections.state();var d=e.selected().length;var c=e.selectables().length;b('th[data-selectable-selector-column] input[type="checkbox"]',this._element).prop("checked",d===c);this._brick.setSelectionState(d,c)},toggleSelection:function(c,d){if(!this._brick.isLoading()){this._selections.state().toggle(c,d)}},toggleSelectionAll:function(c){if(!this._brick.isLoading()){this._selections.state().toggleAll(c)}},toggleSort:function(e,d){if(!this._brick.isLoading()){var f={};var c=d?"":"-";f[this._brick.id()+"_order"]=c+e;this._brick.refresh(f)}},bind:function(f){if(this.isBound()){throw new Error("BrickTable is already bound")}var c=this;var e=this._brick;var d=this._events;var g=this._selections.bind(b("tbody",f));this._element=f;f.delegate(".row-selector-all","change",function(h){c.toggleSelectionAll(b(this).prop("checked"))});f.delegate("td[data-selectable-selector-column]","click",function(h){var i=b(this).parents("tr:first");c.toggleSelection(i.attr("data-row-index"),!i.is(".is-selected"))});g.state().on("change",function(){c._updateSelectionState()});f.delegate(".brick-table-sortable","click",function(i){var h=b(this);c.toggleSort(h.attr("data-sort-field"),h.attr("data-sort-order")==="desc")});b("table[-table-floating-header]",f).each(function(){var h=b(this);h.floatThead({scrollContainer:function(i){return i.closest(".brick-scrollable-container")}})});b(".brick-reorderable-items",f).sortable({placeholder:"brick-reorderable-placeholder",handle:"[data-reorderable-handle-column]",beforeStart:function(k,j){var i=j.item.find("td").map(function(){return this.offsetWidth}).get();var h=j.item.height();j.item.data("creme-layout-state",{height:h,widths:i})},start:function(j,i){i.item.appendTo(this).addClass("is-dragging");var h=i.item.data("creme-layout-state");i.item.find("td").each(function(k){b(this).css("width",h.widths[k])});i.placeholder.find("td").each(function(k,l){b(this).css("width",h.widths[k])});i.placeholder.height(h.height);d.trigger("row-drag-start",[j,i.item])},stop:function(i,h){h.item.removeClass("is-dragging");h.item.find("td").removeAttr("style");d.trigger("row-drag-stop",[h.item],this)}});d.on("row-drag-stop",function(l,k){var h=k.attr("data-reorderable-item-url");var i=k.index()+1;var j=parseInt(k.attr("data-reorderable-item-order"));if(i!==j){e.action("update",h,{},{target:i}).on({done:function(){k.attr("data-reorderable-item-order",i)},fail:function(){e.refresh()}}).start()}});return this},unbind:function(){if(this.isBound()===false){throw new Error("BrickTable is not bound")}b("table[-table-floating-header]",this._element).each(function(){b(this).floatThead("destroy")});b(".brick-reorderable-items",this._element).sortable("destroy");this._element=null;return this}});creme.bricks.Dependencies=function(c){this._wildcard=false;this._deps={};this.add(c)};creme.bricks.Dependencies.prototype={intersect:function(c){if(this._wildcard||c._wildcard){return true}var e=this._deps;var f=c.keys();for(var d=0;d<f.length;d++){if(e[f[d]]){return true}}return false},add:function(e){e=e||[];if(this._wildcard){return this}if(creme.bricks.Dependencies.prototype.isPrototypeOf(e)){this._wildcard=e._wildcard;if(e._wildcard){this._deps={}}else{this._deps=b.extend(this._deps,e._deps)}}else{if(Array.isArray(e)){for(var d=0;d<e.length;d++){var c=e[d];if(c==="*"){this._wildcard=true;this._deps={};break}this._deps[c]=true}}else{if(Object.isString(e)){return this.add([e])}else{throw new Error("Unable to add invalid dependency data",e)}}}return this},keys:function(){return Object.keys(this._deps)},isWildcard:function(){return this._wildcard},isEmpty:function(){return !this._wildcard&&(Object.keys(this._deps).length===0)}};creme.bricks.Brick=creme.component.Component.sub({_init_:function(d){var c=this;d=b.extend({overlayDelay:200,deferredStateSaveDelay:1000},d||{});this._options=d;this._events=new creme.component.EventHandler();this._state={};this._dependencies=new creme.bricks.Dependencies();this._actionLinks=[];if(d.deferredStateSaveDelay>0){this._deferredStateSave=creme.utils.debounce(this.saveState.bind(this),d.deferredStateSaveDelay)}else{this._deferredStateSave=this.saveState.bind(this)}this._overlay=new creme.dialog.Overlay();this._pager=new creme.list.Pager().on("refresh",function(e,g){var f={};f[c._id+"_page"]=g;c.refresh(f)});this._table=new creme.bricks.BrickTable(this);this._menu=new creme.bricks.BrickMenu(this)},on:function(d,e,c){this._events.on(d,e,c);return this},off:function(c,d){this._events.off(c,d);return this},one:function(c,d){this._events.one(c,d);return this},trigger:function(c,d){if(this.isBound()){this._element.trigger("brick-"+c,[this].concat(d||[]))}this._events.trigger(c,d,this)},isBound:function(){return Object.isNone(this._element)===false},element:function(){return this._element},_bindStateSaveURL:function(){var c=this._stateSaveURL=b("body").attr("data-brick-state-url")||"";if(!c){console.warn('It seems there is no brick state URL in this page (see <body data-brick-state-url="..." > attribute)')}return c},_bindDependencies:function(c){var d=creme.utils.JSON.clean(c.attr("data-brick-deps"),[]);var e=this._dependencies=new creme.bricks.Dependencies(d);return e},_bindActionLinks:function(e){var d=this;var c=this._actionLinks=b("[data-action]",e).map(function(){return d._initializeActionButton(b(this))});return c},bind:function(c){if(this.isBound()){throw Error("brick component is already bound")}this.trigger("before-bind",[c]);c.trigger("brick-before-bind",[this,c]);this._id=c.attr("id");this._element=c;this._defaultLoadingMessage=c.find(".brick-loading-indicator-title").html();this._state={collapsed:c.is(".is-collapsed"),reduced:c.is(".is-content-reduced")};this._bindStateSaveURL();this._bindDependencies(c);this._bindActionLinks(c);this._table.bind(c);this._pager.bind(c);this._overlay.bind(b(".brick-content",c));this._menu.bind(c);this.trigger("bind",[c]);return this},unbind:function(){if(this.isBound()===false){throw Error("brick component is not bound")}var c=this._element;this.trigger("before-unbind",[c]);this._table.unbind();this._overlay.unbind().update(false);this._menu.unbind();this.closeMenu();this._element=undefined;this._state={};this._actionLinks=[];this._defaultLoadingMessage="";this._stateSaveURL="";this.trigger("unbind",[c]);c.trigger("brick-unbind",[this,c]);return this},id:function(){return this._id},title:function(){return b(".brick-header .brick-title",this._element).attr("title")},toggleMenu:function(){this._menu.toggle();return this},closeMenu:function(){this._menu.close();return this},menu:function(){return this._menu},table:function(){return this._table},setSelectionState:function(h,g){h=Math.max(0,h||0);g=Math.max(0,g||0);if(this.isBound()){var d=b(".brick-selection-indicator",this._element);var i=d.find(".brick-selection-title");var f=i.attr("data-title-format")||"";var e=i.attr("data-plural-format");var c=h>0;if(pluralidx(h)){f=e||f}d.toggleClass("has-selection",c);i.text(c&&Object.isString(f)?f.format(h,g):"")}return this},state:function(){return b.extend({},this._state)},setState:function(c){this._state=b.extend(this._state,c||{});this._renderState();this.trigger("state-update",[this._state]);this._deferredStateSave();return this},toggleState:function(c){var d=this.state();d[c]=!d[c];return this.setState(d)},saveState:function(){if(this.isBound()){var c=this._state;if(!Object.isEmpty(this._stateSaveURL)){creme.ajax.query(this._stateSaveURL,{action:"post"},{id:this._id,is_open:c.collapsed?0:1,show_empty_fields:c.reduced?0:1}).start()}}return this},_renderState:function(){var c=this._element;var d=this._state;c.toggleClass("is-collapsed",d.collapsed).toggleClass("is-content-reduced",d.reduced)},_initializeActionButton:function(c){var d=new creme.bricks.BrickActionLink(this).bind(c);if(c.is(".is-async-action")){var e=this.setLoadingState.bind(this);d.on("action-link-start",function(h,g,f,i){e(true,f.loading)}).onComplete(function(){e(false)})}return d},_getActionBuilder:function(d){d=d.replace(/\-/g,"_").toLowerCase();var c=this["_action_"+d];if(Object.isFunc(c)){return c.bind(this)}},_buildAction:function(g,e,d,h,f){d=d||{};h=h||{};var c=this._getActionBuilder(g);if(Object.isFunc(c)){return c(e,d,h,f)}},action:function(f,e,d,h){var c=this;if(!this.isBound()){return new creme.component.Action(function(){this.cancel("brick is not bound",c)})}if(this.isLoading()){return new creme.component.Action(function(){this.cancel("brick is in loading state",c)})}var g=this._buildAction(f,e,d,h);if(Object.isNone(g)){g=new creme.component.Action(function(){this.fail('no such action "'+f+'"',c)})}return g},_toggleStateAction:function(e,f,d,g){var c=this.toggleState.bind(this,e);return new creme.component.Action(function(){var i=c().state()[e];if(!Object.isNone(f)){var h=b(f.target).parents("[data-action]:first");h.find(".brick-action-title").text(i?g:d)}this.done()})},_action_collapse:function(d,c,f,e){return this._toggleStateAction("collapsed",e,f.inlabel,f.outlabel)},_action_reduce_content:function(d,c,f,e){return this._toggleStateAction("reduced",e,f.inlabel,f.outlabel)},_action_form:function(d,c,e){c=b.extend(this._defaultDialogOptions(d),c||{});return new creme.bricks.FormDialogAction(c)},_action_form_refresh:function(e,d,f){var c=this;return this._action_form(e,d,f).onDone(function(){c.refresh()})},_action_add:function(d,c,e){return this._action_form_refresh(d,c,e)},_action_edit:function(d,c,e){return this._action_form_refresh(d,c,e)},_action_link:function(d,c,e){return this._action_form_refresh(d,c,e)},_action_delete:function(e,d,g){var c=this;d=b.extend({action:"post"},d||{});var f=creme.utils.confirmAjaxQuery(e,d,g).onDone(function(){c.refresh()});return f},_action_update:function(e,d,g){var c=this;var f;d=b.extend({action:"post",reloadBrick:true},d||{});if(d.confirm){f=creme.utils.confirmAjaxQuery(e,d,g)}else{f=creme.utils.ajaxQuery(e,d,g)}return f.onDone(function(){c.refresh()})},_action_update_redirect:function(d,c,f){c=b.extend({action:"post"},c||{});var e;if(c.confirm){e=creme.utils.confirmAjaxQuery(d,c,f)}else{e=creme.utils.ajaxQuery(d,c,f)}return e.onDone(function(g,h,i){creme.utils.goTo(h)})},_action_add_relationships:function(d,c,e){return creme.relations.addRelationTo(e.subject_id,e.rtype_id,e.ctype_id,{multiple:e.multiple})},_defaultDialogOptions:function(c,e){var d=b(window).innerWidth();return{resizable:true,draggable:true,width:d*0.8,maxWidth:d,url:c,title:e,validator:"innerpopup"}},_action_view:function(d,c,e){c=b.extend(this._defaultDialogOptions(d,e.title),c||{});return new creme.bricks.DialogAction(c)},_action_refresh:function(c){return new creme.bricks.BricksReloader(c).sourceBrick(this).action()},_action_redirect:function(d,c,f){var e={location:window.location.href.replace(/.*?:\/\/[^\/]*/g,"")};return new creme.component.Action(function(){creme.utils.goTo(creme.utils.templatize(d,e).render())})},dependencies:function(){return this._dependencies},isLoading:function(){return this.isBound()&&this._element.is(".is-loading")},readOnly:function(){return this.isBound()&&(this._element.attr("data-brick-readonly")==="true")},reloadingInfo:function(){if(!this.isBound()){return{}}var c=this._element.attr("data-brick-reloading-info")||"";if(c){try{return JSON.parse(c)}catch(d){console.warn('Invalid "data-brick-reloading-info" attribute:',d)}}return{}},setLoadingState:function(e,d){if(this.isBound()&&e!==this.isLoading()){d=d||this._defaultLoadingMessage;var c=this._element;c.toggleClass("is-loading",e).find(".brick-loading-indicator-title").html(d);c.trigger(e?"brick-loading-start":"brick-loading-complete")}return this},setDownloadStatus:function(d){if(this.isBound()){var c=this._element;b(".brick-header",c).attr("data-loading-progress",d);this.trigger("brick-loading-progress",[d])}return this},refresh:function(c,d){if(this.isBound()){return this._action_refresh(c).on(d||{}).start()}return this},redirect:function(c,d,e){this._action_redirect(c,d,e).start();return this}});creme.bricks.replaceContent=function(d,c){creme.widget.destroy(d);d.replaceWith(c);creme.widget.create(c)};creme.bricks.BricksReloader=function(c){this._bricksContainer=null;this._url=null;this._brickFilter=null;this.uri_extra_params=c};creme.bricks.BricksReloader.prototype={containerFromNode:function(e){var c;if(e===undefined){c=b("[data-bricks-reload-url]").first()}else{c=e.parents("[data-bricks-reload-url]").first()}if(c.length===1){var d=c.attr("data-bricks-reload-url");if(d){this._bricksContainer=c;this._url=d}else{console.warn('It seems that the brick reload URL is empty (see <body data-bricks-reload-url="..." > attribute)!')}}else{console.warn('It seems there is no brick reload URL in this page (see <body data-bricks-reload-url="..." > attribute)!')}return this},dependencies:function(d){var c=new creme.bricks.Dependencies(d);this._brickFilter=function(e){return c.intersect(e.dependencies())};return this},sourceBrick:function(d){this.containerFromNode(d._element);var c=d.dependencies();var e=d.id();if(Object.isEmpty(e)){this._brickFilter=null;return this}if(d.readOnly()||c.isEmpty()){this._brickFilter=function(f){return f.id()===e}}else{this._brickFilter=function(f){return f.id()===e||c.intersect(f.dependencies())}}return this},action:function(){var e=function(j){return new creme.component.Action(function(){this.fail(j)})};var d=function(j){return new creme.component.Action(function(){this.cancel(j)})};if(!this._bricksContainer){this.containerFromNode()}if(this._brickFilter===null){return e("Missing or invalid source brick")}var h=[];var f={};var i=this._brickFilter;b(".brick.widget-ready",this._bricksContainer).each(function(){var j=b(this).creme().widget().brick();var l=j.id();if(i(j)&&!Object.isEmpty(l)){h.push(j);var k=j.reloadingInfo();if(!Object.isEmpty(k)){f[l]=k}}});if(h.length===0){console.debug("No brick collected ; so we avoid the reloading query");return d("No active brick collected. Avoid the reloading query.")}var g=b.extend({brick_id:h.map(function(j){return j.id()}),extra_data:b.toJSON(f)},this.uri_extra_params||false);var c={backend:{sync:false,dataType:"json"},onDownloadProgress:function(j){var k=100;if(j.lengthComputable&&j.total>0){k=Math.trunc(Math.max((j.loaded/j.total)*100,0)/20)*20}h.forEach(function(l){l.setDownloadStatus(k)})}};h.forEach(function(j){j._overlay.content("").update(true,"wait",j._options.overlayDelay)});return creme.ajax.query(this._url,c,g).onStart(function(){h.forEach(function(j){j.setLoadingState(true);j.setDownloadStatus(20)})}).onComplete(function(){h.forEach(function(j){j.setLoadingState(false);j._overlay.update(false)})}).onDone(function(j,k){k.forEach(function(l){creme.bricks.replaceContent(b('[id="'+l[0]+'"]'),b(b.trim(l[1])))})})}};creme.bricks.BrickLauncher=creme.widget.declare("brick",{_create:function(g,e,c,h,d){var f=this._brick=new creme.bricks.Brick();f.bind(g);g.addClass("widget-ready");f.trigger("ready",[e])},_destroy:function(c){this._brick.unbind(c);creme.widget.shutdown(c)},brick:function(c){return this._brick}})}(jQuery));(function(b){var a=creme.component.Component.sub({_init_:function(f,d){d=this._options=b.extend({direction:"bottom-right"},d||{});var e=f.find(".listview-actions-container");this._dialog=new creme.dialog.Popover(d).fill(e);this._dialog.addClass(d.classes||"");var c=this.toggle.bind(this);f.on("click",function(g){g.stopPropagation();c(d.anchor||g.target)})},isOpened:function(){return this._dialog.isOpened()},toggle:function(c){this._dialog.toggle(c);return this},close:function(){this._dialog.close();return this},open:function(c){this._dialog.open(c);return this}});b.fn.list_view=function(g){var e=Object.isString(g);var f=Array.prototype.slice.call(arguments,1);b.fn.list_view.defaults={user_page:"#user_page",selected_rows:"#selected_rows",selectable_class:"selectable",selected_class:"selected",id_container:'[name="entity_id"]',checkbox_selector:'[name="select_one"]',all_boxes_selector:'[name="select_all"]',beforeSubmit:null,afterSubmit:null,o2m:false,entity_separator:",",serializer:'input[name][type!="submit"], select[name]',submitHandler:null,kd_submitHandler:null,reload_url:null,historyHandler:null,actionBuilders:null};var h=function(){};var d=["countEntities","getSelectedEntities","getSelectedEntitiesAsArray","option","serializeMe","ensureSelection","getSubmit","getKdSubmit","setSubmit","setKdSubmit","setReloadUrl","getReloadUrl","isLoading","getActionBuilders"];if(e&&b.inArray(g,d)>-1){var c=b.data(this.get(0),"list_view");return(c?c[g].apply(c,f):undefined)}return this.each(function(){if(!e){var k=b.extend(b.fn.list_view.defaults,g);var l=[];var i=b(this);var j=this;b.data(this,"list_view",this);j.beforeSubmit=(Object.isFunc(k.beforeSubmit))?k.beforeSubmit:false;j.afterSubmit=(Object.isFunc(k.afterSubmit))?k.afterSubmit:false;j.submitHandler=(Object.isFunc(k.submitHandler))?k.submitHandler:false;j.kd_submitHandler=(Object.isFunc(k.kd_submitHandler))?k.kd_submitHandler:false;j.historyHandler=(Object.isFunc(k.historyHandler))?k.historyHandler:false;j.is_loading=false;this._actionBuilders=new creme.lv_widget.ListViewActionBuilders(this);this.getActionBuilders=function(){return i._actionBuilders};this.getSelectedEntities=function(){return b(k.selected_rows,i).val()};this.getSelectedEntitiesAsArray=function(){var m=this.getSelectedEntities();return(m!=="")?m.split(k.entity_separator):[]};this.countEntities=function(){return this.getSelectedEntitiesAsArray().length};this.option=function(m,n){if(Object.isString(m)){if(n===undefined){return k[m]}k[m]=n}};this.setSubmit=function(m){if(Object.isFunc(m)){j.submitHandler=m}};this.setKdSubmit=function(m){if(Object.isFunc(m)){j.kd_submitHandler=m}};this.getSubmit=function(){if(j.submitHandler){return j.submitHandler}else{return h}};this.getKdSubmit=function(){if(j.kd_submitHandler){return j.kd_submitHandler}else{return h}};this.setReloadUrl=function(m){j.reload_url=m};this.getReloadUrl=function(){return j.reload_url};this.isLoading=function(){return j.is_loading};this.reload=function(){j.getSubmit()(null)};this.hasSelection=function(){return(this.countEntities()!==0)};this.ensureSelection=function(){if(!this.hasSelection()){creme.dialogs.warning(gettext("Please select at least one entity."));return false}return true};this.enableFilters=function(){i.find('.columns_bottom .column input[type="text"]').bind("keydown",function(n){n.stopPropagation();j.getKdSubmit()(n,this)});i.find(".columns_bottom .column select").bind("change",function(n){n.stopPropagation();j.getSubmit()(this)});var m=i.find(".columns_bottom .column.datefield input");m.bind("keydown",function(n){n.preventDefault();n.stopPropagation();j.getKdSubmit()(n,this)});m.each(function(){b(this).datepicker({showOn:"both",dateFormat:b(this).attr("data-format"),buttonImage:creme_media_url("images/icon_calendar.gif"),buttonImageOnly:true})})};this.enableActions=function(){i.find("a[data-action]").each(function(){var m=new creme.action.ActionLink();m.on("action-link-start",function(p,o,n,q,r){b(r.target).parents(".popover:first").trigger("modal-close")}).builders(j._actionBuilders).bind(b(this))});i.find(".row-actions-trigger").map(function(){return new a(b(this),{classes:"row-actions-popover listview-actions-popover"})});i.find(".header-actions-trigger").map(function(){return new a(b(this),{classes:"header-actions-popover listview-actions-popover",anchor:b(this).find("span")})})};this.enableRowSelection=function(){i.on("click","."+k.selectable_class,function(q){var n=b(q.target);var o=n.is("a")||n.parents("a").first().length===1;if(o){return}var m=b(this).find(k.id_container).val();var p=b.inArray(m,l);if(!b(this).hasClass(k.selected_class)){if(p===-1){if(k.o2m){l=[];i.find("."+k.selected_class).removeClass(k.selected_class)}l.push(m);b(k.selected_rows,i).val(l.join(k.entity_separator))}if(!b(this).hasClass(k.selected_class)){b(this).addClass(k.selected_class)}if(!k.o2m){b(this).find(k.checkbox_selector).check()}b(this).trigger("row-selection-changed",{selected:true})}else{i.find(k.all_boxes_selector).uncheck();if(p!==-1){l.splice(p,1)}b(k.selected_rows,i).val(l.join(k.entity_separator));if(b(this).hasClass(k.selected_class)){b(this).removeClass(k.selected_class)}if(!k.o2m){b(this).find(k.checkbox_selector).uncheck()}b(this).trigger("row-selection-changed",{selected:false})}})};this.clearRowSelection=function(){b(k.selected_rows,i).val("");b(k.selected_rows,i).trigger("row-selection-changed",{selected:false});i.find("."+k.selectable_class+' .choices input[type="checkbox"],'+k.all_boxes_selector).prop("checked",false)};this.enableCheckAllBoxes=function(){i.find(k.all_boxes_selector).bind("click",function(m){var n=i.find("."+k.selectable_class);if(b(this).is(":checked")){n.each(function(){var o=b(this).find(k.id_container).val();var p=b.inArray(o,l);if(p===-1){l.push(o)}if(!b(this).hasClass(k.selected_class)){b(this).addClass(k.selected_class)}if(!k.o2m){b(this).find(k.checkbox_selector).check()}b(this).trigger("row-selection-changed",{selected:true})});b(k.selected_rows,i).val(l.join(k.entity_separator))}else{n.each(function(){if(b(this).hasClass(k.selected_class)){b(this).removeClass(k.selected_class)}if(!k.o2m){b(this).find(k.checkbox_selector).uncheck()}b(this).trigger("row-selection-changed",{selected:false})});l=[];b(k.selected_rows,i).val("")}})};this.flushSelected=function(){b(k.selected_rows,i).val("");l=[]};this.disableEvents=function(){i.off("click","."+k.selectable_class);if(!k.o2m){i.find(k.all_boxes_selector).unbind("click")}};this.enableEvents=function(){this.enableRowSelection();this.enableFilters();this.enableActions();if(!k.o2m){this.enableCheckAllBoxes()}};this.addParameter=function(o,m,n,p){if(!Object.isEmpty(m)&&!Object.isNone(n)){if(o[m]===undefined){o[m]=[n]}else{o[m].push(n)}}};this.setParameter=function(o,m,n){if(!Object.isEmpty(m)&&!Object.isNone(n)){o[m]=[n]}};this.serializeMe=function(){var m={};i.find(k.serializer).serializeArray().forEach(function(n){j.addParameter(m,n.name,n.value)});m.page=m.page||b(k.user_page,i).val();m.selection=k.o2m?"single":"multiple";delete m.entity_id;delete m.inner_header_from_url;return m};this.handleSubmit=function(q,t,o){if(j.is_loading){return}q=b.extend({success:h,error:h,complete:h},q||{});var n=j.reload_url||window.location.pathname;var r=b.extend(this.serializeMe(),o||{});j.setParameter(r,b(t).attr("name"),b(t).val());var s=q.beforeComplete;var p=function(v,u){j.is_loading=false;j.enableEvents();if(Object.isFunc(s)){s(v,u)}};var m=function(v,u){if(Object.isFunc(j.historyHandler)){return j.historyHandler(n+"?"+b.param(r))}};j.disableEvents();j.is_loading=true;creme.utils.ajaxQuery(n,{action:"POST",warnOnFail:false,waitingOverlay:true},r).onDone(q.success).onFail(q.error).onComplete(function(v,w,u){p(w,u);m(w,u)}).onComplete(q.complete).start();this.flushSelected()};this.init=function(){this.clearRowSelection();this.enableEvents()};this.init()}else{if(Object.isFunc(this[g])){this[g].apply(this,f)}}})}})(jQuery);(function(a){creme.lv_widget={};creme.lv_widget.findList=function(c){var b=a(c).parents(".ui-dialog:first");if(b.length===0){b=a("body")}return b.find("form.ui-creme-listview:first")};creme.lv_widget.deleteFilter=function(c,d,b){return creme.utils.confirmPOSTQuery(b,{},{id:d}).onDone(function(e,f){c.list_view("reload")}).start()};creme.lv_widget.selectedLines=function(b){b=a(b);if(b.list_view("countEntities")===0){return[]}return b.list_view("getSelectedEntitiesAsArray")};creme.lv_widget.DeleteSelectedAction=creme.component.Action.sub({_init_:function(c,b){this._super_(creme.component.Action,"_init_",this._run,b);this._list=c},_onDeleteFail:function(c,h,e){var j=this;var g=this._list;var k=Object.isType(h,"string")?h:(h.message||gettext("Error"));var f=creme.ajax.localizedErrorMessage(e);var b=new creme.utils.JSON();if(!Object.isEmpty(k)&&b.isJSON(k)){var d=b.decode(k);var i=d.count-d.errors.length;f="";if(i>0){f=ngettext("%d entity have been deleted.","%d entities have been deleted.",i).format(i)}if(d.errors){f+=ngettext(" %d entity cannot be deleted."," %d entities cannot be deleted.",d.errors.length).format(d.errors.length)}k="<ul>"+d.errors.map(function(l){return"<li>"+l+"</li>"}).join("")+"</ul>"}creme.dialogs.warning(k,{header:f}).onClose(function(){g.reload();j.fail()}).open()},_run:function(c){c=a.extend({},this.options(),c||{});var b=this;var f=this._list;var d=creme.lv_widget.selectedLines(f);if(d.length<1){creme.dialogs.warning(gettext("Please select at least one entity.")).onClose(function(){b.cancel()}).open()}else{var e=creme.utils.confirmPOSTQuery(c.url,{warnOnFail:false,dataType:"json"},{ids:d.join(",")});e.onFail(this._onDeleteFail.bind(this)).onCancel(function(g,h){b.cancel()}).onDone(function(g,h){f.reload();b.done()}).start()}}});creme.lv_widget.AddToSelectedAction=creme.component.Action.sub({_init_:function(c,b){this._super_(creme.component.Action,"_init_",this._run,b);this._list=c},_run:function(c){c=a.extend({},this.options(),c||{});var b=this;var f=this._list;var e=creme.lv_widget.selectedLines(f);if(e.length<1){creme.dialogs.warning(gettext("Please select at least one entity.")).onClose(function(){b.cancel()}).open()}else{var d=creme.dialogs.form(c.url,{},{ids:e,persist:"ids"});d.onFormSuccess(function(g,h){f.reload();b.done()}).onClose(function(){b.cancel()}).open({width:800})}}});creme.lv_widget.EditSelectedAction=creme.component.Action.sub({_init_:function(c,b){this._super_(creme.component.Action,"_init_",this._run,b);this._list=c},_run:function(c){c=a.extend({},this.options(),c||{});var b=this;var f=this._list;var e=creme.lv_widget.selectedLines(f);if(e.length<1){creme.dialogs.warning(gettext("Please select at least one entity.")).onClose(function(){b.cancel()}).open()}else{var d=creme.dialogs.form(c.url,{submitData:{entities:e}});d.onFormSuccess(function(g,h){f.reload();b.done()}).onFormError(function(g,h){if(a("form",this.content()).length===0){this._updateButtonState("send",false);this._updateButtonLabel("cancel",gettext("Close"));this._bulk_edit_done=true}}).onClose(function(){if(this._bulk_edit_done){f.reload();b.done()}else{b.cancel()}}).on("frame-update",function(k,l){var h=a(".bulk-selection-summary",l.delegate());if(h.length){var j=e.length;var i=h.attr("data-msg")||"";var g=h.attr("data-msg-plural");if(pluralidx(j)){i=g||i}h.text(i.format(e.length))}}).open({width:800})}}});creme.lv_widget.MergeSelectedAction=creme.component.Action.sub({_init_:function(c,b){this._super_(creme.component.Action,"_init_",this._run,b);this._list=c},_run:function(c){c=a.extend({},this.options(),c||{});var b=this;var f=this._list;var d=creme.lv_widget.selectedLines(f);if(d.length!==2){creme.dialogs.warning(gettext("Please select 2 entities.")).onClose(function(){b.cancel()}).open()}else{try{creme.utils.goTo(c.url+"?"+a.param({id1:d[0],id2:d[1]}))}catch(g){this.fail(g)}}}});creme.lv_widget.handleSort=function(f,b,c,d,h){var e=a(f);var g=a(b);if(e.val()===c){if(g.val()===""){g.val("-")}else{g.val("")}}else{g.val("")}e.val(c);if(Object.isFunc(h)){h(d)}};creme.lv_widget.initialize=function(d,f){var b,h;var e=f.parents(".ui-dialog-content:first");var c=d.reloadurl||window.location.pathname;var g=e.length>0?e.attr("id"):undefined;if(g){b=function(j,i){i=g?a.extend({whoami:g},i):i;var k={action:c,success:function(m,n,l){n=g?n+'<input type="hidden" name="whoami" value="'+g+'"/>':n;creme.widget.destroy(f);f.html(n);creme.widget.create(f)}};f.list_view("setReloadUrl",c);f.list_view("handleSubmit",k,j,i)}}else{h=function(i){creme.history.push(i)};b=function(j,i){var k={action:c,success:function(m,n,l){creme.widget.destroy(f);f.html(n);creme.widget.create(f)}};f.list_view("handleSubmit",k,j,i)}}f.list_view({o2m:d.multiple?0:1,historyHandler:h,submitHandler:b,kd_submitHandler:function(l,j,i){l=(window.event)?window.event:l;var k=(window.event)?l.keyCode:l.which;if(k===13){f.list_view("getSubmit")(j,i)}return true}});f.list_view("setReloadUrl",c);a(".magnify",f).imageMagnifier()};creme.lv_widget.listViewAction=function(d,c,f){c=c||{};var b=function(h){var g=a('.ui-creme-listview tr.selected input[name="entity_id"]',h).map(function(i,j){return a(j).val()});return g.get()||[]};var e=function(g){if(Object.isEmpty(g)){creme.dialogs.warning(gettext("Please select at least one entity."),{title:gettext("Error")}).open();return false}if(!c.multiple&&g.length>1){creme.dialogs.warning(gettext("Please select only one entity."),{title:gettext("Error")}).open();return false}return true};return creme.utils.innerPopupFormAction(d,{submit_label:gettext("Validate the selection"),submit:function(g){var h=b(g);return e(h)?h:null},validator:function(g){return g!==null},closeOnEscape:c.closeOnEscape},f)};creme.lv_widget.ListViewActionBuilders=creme.component.Component.sub({_init_:function(b){this._list=b},_defaultDialogOptions:function(b,d){var c=a(window).innerWidth();return{resizable:true,draggable:true,width:c*0.8,maxWidth:c,url:b,title:d,validator:"innerpopup"}},_action_update:function(c,b,g,h){var f=this._list;var d;b=a.extend({action:"post"},b||{});if(b.confirm){d=creme.utils.confirmAjaxQuery(c,b,g)}else{d=creme.utils.ajaxQuery(c,b,g)}return d.onDone(function(){f.reload()})},_action_delete:function(c,b,d,f){return this._action_update(c,a.extend({},b,{confirm:gettext("Are you sure ?")}),d,f)},_action_form:function(c,b,f,g){var d=this._list;b=a.extend(this._defaultDialogOptions(c),b||{});return new creme.dialog.FormDialogAction(b,{"form-success":function(){d.reload()}})},_action_edit_selection:function(c,b,d,f){return new creme.lv_widget.EditSelectedAction(this._list,{url:c})},_action_delete_selection:function(c,b,d,f){return new creme.lv_widget.DeleteSelectedAction(this._list,{url:c})},_action_addto_selection:function(c,b,d,f){return new creme.lv_widget.AddToSelectedAction(this._list,{url:c})},_action_merge_selection:function(c,b,d,f){return new creme.lv_widget.MergeSelectedAction(this._list,{url:c})}});creme.lv_widget.ListViewHeader=creme.component.Component.sub({_init_:function(b){b=a.extend({standalone:false,headTop:0},b||{});this._isStandalone=b.standalone;this._headTop=b.headTop;this._rowListeners={mouseenter:this._onEnterSelectableRow.bind(this),mouseleave:this._onLeaveSelectableRow.bind(this),selection:this._onRowSelectionChange.bind(this)};this._floatListeners={floatHead:this._onHeadFloatEnabled.bind(this)};this._documentListeners={scroll:this._onDocumentScroll.bind(this)}},isBound:function(){return this._list!==undefined},_onEnterSelectableRow:function(b){this._list.addClass("first-row-hovered");if(this._isStandalone){a(".listview.floatThead-table").addClass("first-row-hovered")}},_onLeaveSelectableRow:function(b){this._list.removeClass("first-row-hovered");if(this._isStandalone){a(".listview.floatThead-table").removeClass("first-row-hovered")}},_onRowSelectionChange:function(c,b){this._list.toggleClass("first-row-selected",b.selected);if(this._isStandalone){a(".listview.floatThead-table").toggleClass("first-row-selected",b.selected)}},_onHeadFloatEnabled:function(d,b,c){if(b){c.addClass("floated");this._list.addClass("floated");a(".header-actions-popover").trigger("modal-close")}else{c.removeClass("floated");this._list.removeClass("floated")}},_onDocumentScroll:function(b){this.updateAnchorPosition()},bind:function(d){if(this.isBound()){throw new Error("ListViewHeader is already bound")}var g=this._isStandalone;var f=this._headTop;this._list=d;this._list.on("mouseenter","tr.selectable:first-child",this._rowListeners.mouseenter);this._list.on("mouseleave","tr.selectable:first-child",this._rowListeners.mouseleave);this._list.on("row-selection-changed","tbody tr:first-child",this._rowListeners.selection);if(g){d.floatThead({top:f,zIndex:97,scrollContainer:function(h){return h.closest(".sub_content")}});var c=a(".floatThead-container");var e=a(document).scrollTop()>d.offset().top;if(e){c.addClass("floated");d.addClass("floated")}d.on("floatThead",this._floatListeners.floatHead);var b=this._floatAnchor=a('<div class="floated-header-anchor">');b.insertAfter(c).css({position:"fixed"});this.updateAnchorPosition();a(document).on("scroll",this._documentListeners.scroll)}return this},unbind:function(){if(this.isBound()===false){throw new Error("ListViewHeader is not bound")}this._list.off("mouseenter","tr.selectable:first-child",this._rowListeners.mouseenter);this._list.off("mouseleave","tr.selectable:first-child",this._rowListeners.mouseleave);this._list.off("row-selection-changed","tbody tr:first-child",this._rowListeners.selection);if(this._isStandalone){this._floatAnchor.detach();this._list.off("floatThead",this._floatListeners.floatHead);a(document).on("scroll",this._documentListeners.scroll)}this._floatAnchor=undefined;this._list=undefined;return this},updateAnchorPosition:function(){if(this._isStandalone){var c=a(document).scrollLeft();var f=a(window).width();var d=this._list.offset().left;var j=d+this._list.width();var h=c+f>=j;var i=Math.abs(Math.ceil(j-f-c));var b=a(".floatThead-container");var e=a(b.children().get(0)).height();var g=this._floatAnchor.height();this._floatAnchor.css({left:Math.max(0,d-c),right:h?i:0,top:this._headTop+e-g})}}});creme.lv_widget.ListViewLauncher=creme.widget.declare("ui-creme-listview",{options:{multiple:false,whoami:"","reload-url":""},_destroy:function(b){a(document).off("scroll",this._scrollListener);b.removeClass("widget-ready")},_create:function(g,f,c,h,e){var b=g.is("[multiple]")||f.multiple;var i=this._list=g.find(".listview");this._isStandalone=i.hasClass("listview-standalone");this._pager=new creme.list.Pager();this._header=new creme.lv_widget.ListViewHeader({standalone:this._isStandalone,headTop:a(".header-menu").height()});this._rowCount=parseInt(i.attr("data-total-count"));this._rowCount=isNaN(this._rowCount)?0:this._rowCount;this._scrollListener=this._onDocumentScroll.bind(this);if(this._isStandalone){g.addClass("ui-creme-listview-standalone");a(document).on("scroll",this._scrollListener);this._handleHorizontalStickiness()}else{g.addClass("ui-creme-listview-popup")}if(!g.data("list_view")){creme.lv_widget.initialize({multiple:b,reloadurl:f["reload-url"]},g)}if(this._rowCount>0){if(!this._isStandalone){var d=g.parents(".ui-dialog").first();i.find(".list-footer-container").css("max-width",d.width())}else{this._handleHorizontalStickiness()}this._header.bind(i);this._pager.on("refresh",function(j,k){g.data("list_view").getSubmit()(null,{page:k})}).bind(i.find(".listview-pagination"))}},_onDocumentScroll:function(b){this._handleHorizontalStickiness();this._handleActionPopoverConstraints()},_handleHorizontalStickiness:function(){var b=a(document).scrollLeft();a(".sticky-container-standalone .sticks-horizontally, .listview-standalone .sticks-horizontally, .footer, .page-decoration").css("transform","translateX("+b+"px)")},_handleActionPopoverConstraints:function(){a(".listview-actions-popover").each(function(){var g=a(this);var i=g.offset();var c=a(".floatThead-container");var b=c.offset();if(i.top<b.top+c.innerHeight()+5){var h=g.hasClass("row-actions-popover");var f=g.hasClass("header-actions-popover");var e=c.hasClass("floated");var d=h||(f&&e);if(d){g.trigger("modal-close")}}})},isStandalone:function(b){return this._isStandalone},count:function(b){return this._rowCount},header:function(b){return this._header},pager:function(b){return this._pager},controller:function(b){return b.data("list_view")}})}(jQuery));(function(b){var a={_action_detailview_merge:function(d,c,f){var e=creme.lv_widget.listViewAction(f.selection_url+"?"+b.param({id1:f.id}),{multiple:false});e.onDone(function(h,g){creme.utils.goTo(d+"?"+b.param({id1:f.id,id2:g[0]}))});return e},_action_detailview_clone:function(d,c,e){return this._action_update_redirect(d,c,e)},_action_detailview_delete:function(d,c,e){return this._action_update_redirect(d,c,e)},_action_detailview_restore:function(d,c,e){return this._action_update_redirect(d,c,e)}};b(document).on("brick-before-bind",".brick.brick-hat",function(d,c){b.extend(c,a)})}(jQuery));(function(a){creme.entity_cell=creme.entity_cell||{};creme.entity_cell.EntityCellsWidget=function(c,b){var d=this.div=a("#"+c);this.store=d.find("input.inner_value");this.samples=a(b);this.column_titles={};this.columns=[];this.header_labels;this.underlays={};this.init()};creme.entity_cell.EntityCellsWidget.prototype={init:function(){this._initSelectorCheck();this._initSelectorFilters();this._initSelectorUnderlays();this._initPreviewTable()},updateStore:function(){this.store.attr("value",this.columns)},updatePreview:function(){var d=this.div;var c=this.columns.length;var b;if(c==0){b=gettext("Preview")}else{if(c==1){b=gettext("Preview of the column")}else{b=gettext("Preview and order of the %s columns").format(c)}}d.find(".preview_title").text(b);d.find(".help_instructions").text(c==0?gettext("The preview is empty. Select some fields and relationships to add some columns."):gettext("Drag and drop the columns to order them."))},findUnderlayInfo:function(d){var c;var g=d.indexOf("__");if(g!=-1){var b;var f=d.slice(0,g);var e=this.underlays[f];if(!e){b=this.div.find(".selector_list .selector[data-column="+f+"]");e=b.find(".underlay-container")}else{b=e.data("underlay_selector")}if(e.length!==0){c={selector:b,content:e.find(".underlay-content")}}}return c},onColumnChanged:function(j){var p=this;var b=this.div;var e=this.columns;var d=j.parentNode.getAttribute("data-column");if(j.checked){var f=this.column_titles;e.push(d);this.header_labels.append(a("<th>").attr("data-column",d).append(a('<input type="checkbox" checked class="preview_column_toggle" />').bind("change",function(r){var q=p.findUnderlayInfo(d);var i=q?q.content.find(".underlay_selector_list"):b.find(".selector_list");i.find(".selector[data-column="+d+"] input[type=checkbox]:checked").prop("checked",false).change()}).attr("title",gettext("Remove the column '%s'").format(f[d]))).append(a("<span>").addClass("dragtable-drag-handle").text(f[d])));var n=b.find(".preview_table .preview_row");var m=this.samples;for(var g=0;g<m.length;++g){var o=m[g][d];if(o===""){o=""}else{if(o===undefined){o="[]"}}a("<td>").attr("data-column",d).html(o).appendTo(n[g])}}else{b.find(".preview_table [data-column="+d+"]").remove();var k=e.indexOf(d);e.splice(k,1)}this.updatePreview();var c=this.findUnderlayInfo(d);if(c){var h=c.content.find("input[type=checkbox]");var l=h.filter(":checked");c.selector.find(".selected_count").remove();if(l.length){a("<span>").addClass("selected_count").text(" ("+l.length+" / "+h.length+")").appendTo(c.selector)}}this.updateStore()},onDragChange:function(b){this.columns=a.map(this.div.find(".preview_table_header th"),function(d,c){return a(d).attr("data-column")});this.updateStore()},findLastItemOfLine:function(b){var d=b.position().top;var c=false;b.nextAll(".selector").each(function(f,h){if(c){return}var g=a(h);if(g.position().top!=d){c=g}});return c?c.prevAll(".selector").first():b.parent(".selector_list").find("> .selector").last()},placeUnderlay:function(b,c){b.insertAfter(c);if(!b.__underlay_height){b.__underlay_height=b.height()}b.css("max-height",b.__underlay_height)},_initSelectorCheck:function(){var k=this;var b=this.div;var d=this.column_titles;var c=this.header_labels=b.find(".preview_table_header .sortable_header");b.find(".selector_list .selector[data-column]").each(function(n,q){var p=a(q);var m=p.find(".sub_selector_toggle");var o=m.length?m:p;var r=o.text();if(p.parent().is(".underlay_selector_list")){r=d[p.parents(".selector").attr("data-column")]+"  "+r}d[p.attr("data-column")]=r.trim();var l=p.find("> input[type=checkbox]");p.find("> label").click(function(i){i.preventDefault();i.stopPropagation();l.prop("checked",!l.prop("checked")).change()})});b.find(".selector_list input[type=checkbox]").bind("change",function(i){k.onColumnChanged(i.target)});var j=this.store.attr("value");if(j){var h=j.split(",");this.store.attr("value","");var f=[];for(var e in h){f.push(undefined)}b.find(".selector_list input[type=checkbox]").each(function(m,n){var l=h.indexOf(n.parentElement.getAttribute("data-column"));if(l!=-1){f[l]=n}});for(var e in f){var g=f[e];if(g){a(g).prop("checked",true).change()}}}else{this.updatePreview()}},_initPreviewTable:function(){var e=this.div;var d=this.underlays;e.find(".remove_all_columns").click(function(g){g.preventDefault();e.find(".selector input[type=checkbox]:checked").prop("checked",false).change();for(var f in d){d[f].find(".selector input[type=checkbox]:checked").prop("checked",false).change()}});var b=this;var c=this.div.parents(".ui-dialog-content").first();if(c.length==0){c=a(document.body)}e.find(".preview_table").dragtable({dataHeader:"data-column",appendTarget:c,change:function(f){b.onDragChange(f)}})},_initSelectorFilters:function(){var b=this.div;b.find(".field_selector_filter").each(function(){var d=a(this);d.data("oldVal",d.val());var c=d.attr("data-type");d.bind("propertychange keyup input paste",function(){var g=d.val();if(d.data("oldVal")==g){return}d.data("oldVal",g);g=g.toLowerCase();if(c=="relationships"){if(g==""){b.find(".relationship_selectors .selector_list .selector").css("display","inline-block");b.find(".relationship_selectors .filter_result").text("")}else{var f=0;var e=0;b.find(".relationship_selectors .selector_list .selector").each(function(j,h){var k=a(h);var l=k.text().toLowerCase();if(l.indexOf(g)==-1){k.css("display","none")}else{k.css("display","inline-block");e+=1}f+=1});b.find(".relationship_selectors .filter_result").text(gettext("%s result(s) on %s").format(e,f))}}else{b.find(".field_selectors .selector_list .selector").each(function(j,h){var k=a(h);var l=k.text().toLowerCase();k.css("opacity",l.indexOf(g)==-1?0.4:1)})}})})},_toggleSelectorUnderlay:function(i){var l=this;var n=this.underlays;var e=i.parent(".selector");var d=e.attr("data-column");var c=n[d];if(!c){n[d]=c=a("<div>").attr("data-column",d).addClass("underlay").data("underlay_selector",e).append(e.find(".underlay-container"))}var m=this.findLastItemOfLine(e);var b=e.parents(".selector_list").find(".underlay");if(b.length==0){this.placeUnderlay(c,m);c.children().css("opacity",1);c.find(".underlay-content").css("opacity",0);c.css("max-height",0).css("opacity",1);var h=c.__underlay_height;c.find(".underlay-content").animate({opacity:1},400);c.children().delay(100).animate({opacity:1},400);c.animate({"max-height":h},300,function(){})}else{if(b.attr("data-column")==d){b.find(".underlay-content").animate({opacity:0},150);b.children().delay(130).animate({opacity:0},150);b.animate({"max-height":0},300,function(o){b.detach()})}else{b.animate({opacity:0},100,function(o){b.detach();c.css("opacity",0);l.placeUnderlay(c,m);c.animate({opacity:1},150);c.find(".underlay-content").animate({opacity:1},150);c.children().animate({opacity:1},150)})}}var j=c.find(".arrow");var f=17;var g=i.offset().left-i.parents(".field_selectors").offset().left;var k=g+(i.width()-f)/2;j.css("left",k+"px")},_initSelectorUnderlays:function(){var b=this;var c=this.div;a(document).on("click",".underlay .selector_close",function(g){g.preventDefault();var d=a(this).parents(".underlay:first").attr("data-column");var f=c.find('.selector[data-column="'+d+'"] .sub_selector_toggle');b._toggleSelectorUnderlay(f)});c.find(".sub_selector_toggle").click(function(d){d.preventDefault();b._toggleSelectorUnderlay(a(this))})}}}(jQuery));(function(a){creme.exports=creme.exports||{};creme.exports.exportAs=function(d,b,c){b=b||[["","No backend found"]];return creme.dialogs.choice(gettext("Select the export format"),{title:gettext("Export"),choices:b.map(function(e){return{value:e[0],label:e[1]}}),required:true}).onOk(function(e,f){creme.utils.goTo(d+"&"+c+"="+f)}).open()}}(jQuery));(function(a){creme.merge=creme.merge||{};creme.merge.initializeMergeForm=function(d){var b=function(f){if(f.is('input[type="checkbox"]')){return f.prop("checked")}else{if(f.is("input, select, textarea")){return f.val()}else{if(f.is(".ui-creme-widget")){return f.creme().widget().val()}}}};var e=function(f,g){if(f.is(".ui-creme-widget")){f.creme().widget().val(g)}else{if(f.is(".ui-creme-input")){f.parents(".ui-creme-widget:first").creme().widget().val(g)}else{if(f.is('input[type="checkbox"]')){f.prop("checked",g)}else{if(f.is("input, select, textarea")){f.val(g).change()}}}}};var c=function(g,f){e(f,b(g))};d.each(function(){var f='<input type="button" />';var g='<li class="li_merge_button"></li>';a(this).find(".merge_entity_field").each(function(){var l=a(".li_merge_result",this);var i=a(this).attr("name");var h=a('[name="'+i+'_merged"]',this);var k=a('[name="'+i+'_1"]',this);var j=a('[name="'+i+'_2"]',this);l.before(a(g).append(a(f).val(">").click(function(){c(k,h)})));l.after(a(g).append(a(f).val("<").click(function(){c(j,h)})))})})}}(jQuery));(function(a){creme.relations=creme.relations||{};creme.relations.addRelationTo=function(g,e,j,m,f){var d=a("body");var i=d.attr("data-save-relations-url");var b=d.attr("data-select-relations-objects-url");var h=new creme.ajax.Backend().query().url(i);var m=m||{};var k=m.reloadOnSuccess;if(k==="window"){h.onDone(function(n,o){creme.utils.reload(window)})}else{if(k!==false){h.onDone(function(){new creme.bricks.BricksReloader().dependencies(["creme_core.relation","creme_core.relation."+e]).action().start()})}}var l=a.extend({subject_id:g,rtype_id:e,objects_ct_id:j,selection:m.multiple?"multiple":"single"},f||{});var c=creme.lv_widget.listViewAction(b,{multiple:m.multiple?true:false},l);c.onDone(function(n,o){h.post({entities:o,subject_id:g,predicate_id:e})});return c.start()}}(jQuery));(function(a){creme.jobs={};creme.jobs.decorateJobStatus=function(h,g,b,f,c){var e=false;var d="";if(f){e=true;h.find("[data-job-ack-errors][data-job-id="+g+"]").each(function(k,l){var j=a(l);if(!j.find(".ack-errors").length){j.append('<span class="ack-errors">'+gettext("Communication error with the job manager (last changes have not been taken into consideration)")+"</span>")}})}else{h.find("[data-job-ack-errors][data-job-id="+g+"] .ack-errors").remove()}switch(b){case 1:e=true;if(c){h.find("[data-job-status][data-job-id="+g+"]").each(function(m,n){var l=a(n);var k=c.label;var j=c.percentage;if(k){l.find(".job-progress-bar-label").text(k)}else{if(j!==null){l.find(".job-progress-percentage-value").text(j)}}if(j!==null){l.find("progress.job-progress-bar").prop("value",j)}})}break;case 10:h.find("[data-job-status][data-job-id="+g+"]").text(gettext("Error")).attr("data-job-status",10);break;case 20:h.find("[data-job-status][data-job-id="+g+"]").text(gettext("Finished")).attr("data-job-status",20);break}return e};creme.jobs.checkJobManager=function(c,g,b){var f=a("#"+g);var d=[];f.find("[data-job-id][data-job-status][data-job-ack-errors]").each(function(h,k){var j=k.getAttribute("data-job-id");if(creme.jobs.decorateJobStatus(f,j,Number(k.getAttribute("data-job-status")),Number(k.getAttribute("data-job-ack-errors")),null)){d.push(j)}});var e=c;if(d.length){e+="?"+a.param({id:d})}a.ajax({url:e,dataType:"json",error:function(k,i,j){var h=f.find(".global-error");h.css("display","");h.text(gettext("HTTP server error"))},success:function(l,i){var k=true;var h=f.find(".global-error");var j=l.error;if(j!==undefined){h.css("display","");h.text(j);k=false}else{h.css("display","none")}d.forEach(function(o,m,p){var n=l[o];if(Object.isString(n)){console.log("Server returned an error for job <",o,"> => ",n);return}if(Object.isNone(n)){console.log("Invalid data for job <",o,"> => ",n);return}if(creme.jobs.decorateJobStatus(f,o,n.status,n.ack_errors,n.progress)){k=false}});if(!k){setTimeout(creme.jobs.checkJobManager,5000,c,g,b)}else{if(b){window.location=window.location}}}})}}(jQuery));(function(a){creme.persons=creme.persons||{};creme.persons.copyTo=function(c,d){var e=a("#"+c);var f=a("#"+d);if(e.size()>0&&f.size()>0){var b=f.find("input, textarea, select");e.find("input, textarea, select").each(function(g){a(b[g]).val(a(this).val())})}};creme.persons.become=function(c,b){if(Object.isEmpty(b)){return}if(b&&b.length>1){creme.dialogs.choice(gettext("Select the concerned organisation."),{choices:b,title:gettext("Organisation")}).onOk(function(e,d){creme.utils.ajaxQuery(c,{action:"post",reloadOnSuccess:true,warnOnFail:true},{id:d}).start()}).open()}else{creme.utils.ajaxQuery(c,{action:"post",reloadOnSuccess:true,warnOnFail:true},{id:b[0].value}).start()}}}(jQuery));(function(a){creme.activities={};creme.activities.exportAsICal=function(d,b){var c=a(d).list_view("getSelectedEntities").trim();if(!c){creme.dialogs.warning(gettext("Please select at least a line in order to export.")).open();return false}document.location.href=b+"?"+a.param({id:c.split(",")})};creme.activities.calendar={};creme.activities.calendar.loading=function(b){a(".calendar .loading-indicator").toggleClass("is-loading",b)};creme.activities.calendar.addFilteringInput=function(b,c){b.data("oldVal",b.val());b.bind("propertychange input paste",function(){var d=b.val();if(b.data("oldVal")===d){return}b.data("oldVal",d);c(d.toUpperCase())})};creme.activities.calendar.loadCalendarEventListeners=function(c,e){var b=function(f){a(".floating_event").each(function(g,h){var i=a(h);i.toggleClass("hidden",i.text().toUpperCase().indexOf(f)===-1)})};var d=function(g){for(var f in e){var m=e[f];var o=f.toUpperCase().indexOf(g)!==-1;var l=0;for(var j=0,p=m.length;j<p;++j){var h=m[j];var n=h.name.toUpperCase();var k=(n.indexOf(g)!==-1)||o;if(k){l++}a(".calendar_label_container[data-calendar="+h.id+"]").toggleClass("hidden",!k)}a('.calendar_label_owner[data-user="'+f+'"]').toggleClass("hidden",l===0)}};a('input[type="checkbox"]').change(function(h){var i=a(".calendar");var f=a(this);var g=f.val();if(f.is(":checked")){i.fullCalendar("refetchEvents")}else{i.fullCalendar("removeEvents",function(j){return g===j.calendar})}});a(".floating_event_filter input").each(function(){creme.activities.calendar.addFilteringInput(a(this),b)});a(".calendar_filter input").each(function(){creme.activities.calendar.addFilteringInput(a(this),d)});a(".floating_event").each(function(){var g=a(this);var j=g.attr("data-calendar");var h=g.attr("data-type");var f=g.attr("data-color");var i={id:g.attr("data-id"),title:a.trim(g.text()),type:h,user:c,calendar:j,className:"event event-"+j,url:g.attr("data-popup_url"),calendar_color:f};g.data("eventObject",i);g.draggable({zIndex:999,revert:true,revertDuration:0,appendTo:"body",containment:"window",scroll:false,helper:"clone"})})};creme.activities.calendar.chooseForeground=function(d,c){var b=creme.color.HEXtoRGB(c);d.css("color",creme.color.maxContrastingColor(b.r,b.g,b.b))};creme.activities.calendar.updater=function(c,b,d,f,j,e,g,i,h){creme.ajax.query(c,{action:"POST"},{id:b.id,start:b.start.getTime(),end:b.end.getTime(),allDay:j}).onFail(function(l,m,k){if(k.status===403){creme.dialogs.warning(gettext("You do not have permission, the change will not be saved.")).open()}else{if(k.status===409){creme.dialogs.warning(unescape(m)).open()}else{if(k.status>=300||k.status===0){creme.dialogs.warning(gettext("Error, please reload the page.")).open()}}}e()}).onStart(function(){creme.activities.calendar.loading(true)}).onComplete(function(){creme.activities.calendar.loading(false);creme.activities.calendar.resizeSidebar()}).start()};creme.activities.calendar.resizeSidebar=function(){var c=a(".calendar");var e=c.height();var b=a(".menu_calendar");var d=parseInt(b.css("margin-top"));b.css("height",(e-d)+"px")};creme.activities.calendar.fullCalendar=function(e,c,b){a(".calendar").fullCalendar({weekends:true,header:{left:"title",center:"today, prev,next",right:"agendaWeek,month"},theme:false,firstDay:1,weekMode:"fixed",aspectRatio:2,defaultView:"month",allDaySlot:true,allDayText:gettext("All day"),axisFormat:"H'h'mm",slotMinutes:15,defaultEventMinutes:60,firstHour:new Date().toString("HH"),minTime:0,maxTime:24,timeFormat:"H'h'mm",columnFormat:{month:"dddd",agendaWeek:"dddd d MMMM",agendaDay:"dddd d MMMM"},titleFormat:{month:"MMMM yyyy",week:"d[ yyyy]{ '&#8212;' d MMMM yyyy}",day:"dddd d MMMM yyyy"},buttonText:{prev:"&nbsp;&#9668;&nbsp;",next:"&nbsp;&#9658;&nbsp;",prevYear:"&nbsp;&lt;&lt;&nbsp;",nextYear:"&nbsp;&gt;&gt;&nbsp;",today:gettext("Today"),month:gettext("Month"),week:gettext("Week"),day:gettext("Day")},monthNames:[gettext("January"),gettext("February"),gettext("March"),gettext("April"),gettext("May"),gettext("June"),gettext("July"),gettext("August"),gettext("September"),gettext("October"),gettext("November"),gettext("December")],dayNames:[gettext("Sunday"),gettext("Monday"),gettext("Tuesday"),gettext("Wesnesday"),gettext("Thursday"),gettext("Friday"),gettext("Saturday")],events:function(j,g,i){var f='input[type="checkbox"][name="selected_calendars"]';var h=a(f+":checked").map(function(){return a(this).val()});a(f).enable(false);a.ajax({url:e,dataType:"json",data:{calendar_id:h.get(),start:Math.round(j.getTime()/1000),end:Math.round(g.getTime()/1000)},success:function(k){i(k);creme.activities.calendar.resizeSidebar();a(f).enable(true)}})},editable:true,droppable:true,drop:function(g,j){var i=a(this);var l=i.data("eventObject");var h=a.extend({},l);h.start=g;h.allDay=j;var k=new Date(g);if(j){k.setHours(23,59,59)}else{k.setHours(g.getHours()+1)}h.end=k;a(".calendar").fullCalendar("renderEvent",h);i.hide();var f=function(){i.show();a(".calendar").fullCalendar("removeEvents",h.id)};creme.activities.calendar.updater(b,h,null,null,j,f)},loading:function(g,f){creme.activities.calendar.loading(g)},dayClick:function(h,j,g,f){var i={year:h.getFullYear(),month:h.getMonth()+1,day:h.getDate(),hour:h.getHours(),minute:h.getMinutes()};creme.dialogs.form(c,{},i).onFormSuccess(function(){a(".calendar").fullCalendar("refetchEvents")}).open({width:"80%"})},eventRender:function(i,h,f){if(i.type){var g=a("<span>").addClass("fc-event-type").text(i.type);var j=h.find(".fc-event-time");if(j.length>0){if(f.name==="month"){g.text("  "+g.text())}g.insertAfter(j)}else{h.find(".fc-event-inner").prepend(g)}}h.css("background-color",i.calendar_color);creme.activities.calendar.chooseForeground(h,i.calendar_color)},eventDragStart:function(i,g,h,f){},eventDrop:function(k,i,h,m,j,g,l,f){creme.activities.calendar.updater(b,k,i,h,m,j,g,l,f)},eventClick:function(f){creme.dialogs.url(f.url).open({width:"80%"});return false},eventResize:function(k,i,h,j,g,l,f){creme.activities.calendar.updater(b,k,i,h,null,j,g,l,f)}});var d=a("<img>").attr("src",creme_media_url("images/wait.gif"));a('<div class="loading-indicator">').append(d,'<div class="loading-label">'+gettext("Loading...")+"</div>").insertBefore(".fc-content")}}(jQuery));(function(a){creme.billing=creme.billing||{};creme.billing.checkPositiveDecimal=function(b){return b.val().match(/^[0-9]+(\.[0-9]{1,2}){0,1}$/)!==null};creme.billing.checkPositiveInteger=function(b){return b.val().match(/^[0-9]+$/)!==null};creme.billing.checkDecimal=function(b){return b.val().match(/^[\-]{0,1}[0-9]+(\.[0-9]{1,2}){0,1}$/)!==null};creme.billing.checkPercent=function(b){return b.val().match(/^(100(\.[0]{1,2}){0,1}|[0-9]{1,2}(\.[0-9]{1,2}){0,1})$/)!==null};creme.billing.checkValue=function(b){return Boolean(b.val())};creme.billing.checkDiscount=function(e){var d=e.closest("tr");var h=parseInt(a("select[name*=discount_unit]",d).val());var f=a("input[name*=total_discount]",d).is(":checked");var c=parseFloat(a("input[name*=discount]",d).val());var b=parseFloat(a("input[name*=unit_price]",d).val());var g=parseInt(a("input[name*=quantity]",d).val());if(!creme.billing.checkPercent(e)&&h==1){return false}if(f&&h==2&&c>b*g){return false}if(!f&&h==2&&c>b){return false}return true};creme.billing.markDelete=function(f,e){var g=f+"-DELETE";var d=a("#id_"+g);var c=a("#line_content_"+e);var b=!d.is(":checked");if(!b){d.uncheck();c.removeClass("bline-deletion-mark")}else{d.check();c.addClass("bline-deletion-mark")}};creme.billing.inputs=function(b){return a("input, select, textarea",b)};creme.billing.forms=function(b){return a(".bline-form",b)};creme.billing.modifiedBLineForms=function(){return a(".bline-form").filter(function(){return Boolean((a("> :not(.hidden-form) .bline-input-modified, .bline-deletion-mark",a(this)).first().length))})};creme.billing.formsHaveErrors=function(){return Boolean(a(".bline-form > :not(.hidden-form) .bline-input-error").first().length)};creme.billing.serializeInput=function(c,b){var d=c.attr("name");var e=c.attr("type")==="checkbox"?(c.is(":checked")?c.val():undefined):c.val();if(c.attr("o2m")&&b){e=c.attr("initial")}if(d!==undefined&&e!==undefined){return{key:d,value:e}}return};creme.billing.validateInput=function(c){var d=c.attr("validator")?creme.billing["check"+c.attr("validator")]:undefined;var b=c.attr("isvalid")||false;if(Object.isFunc(d)){b=d(c)}else{b=true}c.attr("isvalid",b);c.toggleClass("bline-input-error",!b);return b};creme.billing.initializeForm=function(b){creme.billing.inputs(b).each(function(){var c=a(this);var d=creme.billing.serializeInput(c,true);c.attr("initial",d!==undefined?d.value:undefined);creme.billing.validateInput(c)});creme.billing.inputs(b).bind("propertychange input change paste",function(){var c=a(this);var d=creme.billing.serializeInput(c,false);var e=(d!==undefined&&(""+d.value!==c.attr("initial")));if(c.attr("type")==="checkbox"&&d===undefined&&c.attr("initial")){e=true}creme.billing.validateInput(c);c.toggleClass("bline-input-modified",e)})};creme.billing.initializeForms=function(b){creme.billing.forms(b).each(function(){creme.billing.initializeForm(a(this))})};creme.billing.hideEmptyForm=function(c,b,d){a(".empty_form_"+c).toggleClass("hidden-form",true);var e=a("#id_"+b+"-TOTAL_FORMS");e.val(parseInt(e.val())-1);a(".add_on_the_fly_"+c).removeClass("forbidden");if(d===0){a(".empty_msg_"+c).attr("style","display:table-row")}};creme.billing.showEmptyForm=function(b,e,d,f){if(b.hasClass("forbidden")){return}b.addClass("forbidden");var h=a("#id_"+d+"-TOTAL_FORMS");var g=a(".empty_form_inputs_"+e);var c=parseInt(h.val());a("input,select,textarea",g).each(function(k){var i=a(this);i.removeClass("bline-input-error");var j=i.attr("id");if(j){i.attr("id",j.replace("__prefix__",c))}var l=i.attr("name");if(l){i.attr("name",l.replace("__prefix__",c))}creme.billing.restoreValue(i)});h.val(c+1);a(".empty_form_"+e).toggleClass("hidden-form",false);if(f===0){a(".space_line_"+e).attr("style","display:none");a(".empty_msg_"+e).attr("style","display:none")}};creme.billing.restoreValue=function(b){var c=b.attr("initial");if(b.attr("type")==="checkbox"){b.get().checked=!Object.isNone(c)}else{b.val(c)}b.change()};creme.billing.restoreInitialValues=function(c,b,d){creme.dialogs.confirm(gettext("Do you really want to restore initial values of this line ?")).onOk(function(){a("input,select,textarea",a(".restorable_"+c)).each(function(){creme.billing.restoreValue(a(this))});var g=a("#id_"+b+"-DELETE");var f=a("#line_content_"+c);var e=!g.is(":checked");if(!e){g.uncheck();f.removeClass("bline-input-error");f.addClass("block_header_line_dark")}}).open()};creme.billing.initBoundedFields=function(f,c,g){var e=a('[name="discounted"]',f);var b=a('[name="inclusive_of_tax"]',f);var d=a('[name="exclusive_of_tax"]',f);f.delegate(".bound","change",function(){var j=a('[name*="quantity"]',f);var m=a('td input[name*="unit_price"]',f);var r=a('input[name*="discount"]',f);var k=a('select[name*="vat_value"]',f);var l=a("option[value='"+k.val()+"']",k).text();var p=a('[name*="discount_unit"]',f).val();var i;switch(p){case"1":i=j.val()*(m.val()-(m.val()*r.val()/100));break;case"2":i=j.val()*m.val()-r.val();break;case"3":i=j.val()*(m.val()-r.val());break;default:console.log("Bad discount value ?!",p)}i=i-(i*g/100);var n=Math.round(i*100)/100;var o=!creme.billing.checkDiscount(r);r.toggleClass("bline-input-error",o);if(isNaN(n)||o||!creme.billing.checkPositiveDecimal(j)){e.text("###");b.text("###");d.text("###")}else{var q=Math.round(j.val()*m.val()*100)/100;var h=Math.round((parseFloat(n)+parseFloat(n)*l/100)*100)/100;d.text(q.toFixed(2).replace(".",",")+" "+c);e.text(n.toFixed(2).replace(".",",")+" "+c);b.text(h.toFixed(2).replace(".",",")+" "+c);e.attr("data-value",n);b.attr("data-value",h);creme.billing.updateBrickTotals(c)}if(!k.val()){b.text("###")}})};creme.billing.checkModifiedOnUnload=function(){if(creme.billing.modifiedBLineForms().first().length){return gettext("You modified your lines.")}};creme.billing.initLinesBrick=function(d){var c=d._element;var b=c.attr("data-type-currency");var e=parseFloat(c.attr("data-type-global-discount"));creme.billing.initializeForms(c);a(".linetable",c).each(function(f){creme.billing.initBoundedFields(a(this),b,e)});a('select[name*="vat_value"]',c).each(function(f){a(this).addClass("bound line-vat")});a("textarea.line-comment",c).each(function(){new creme.layout.TextAreaAutoSize().bind(a(this))})};creme.billing.serializeForm=function(b){var c={};creme.billing.inputs(a(b)).each(function(){var d=creme.billing.serializeInput(a(this),false);if(d!==undefined){c[d.key]=d.value}});return c};creme.billing.updateBrickTotals=function(c){var f=a("h1[name=total_no_vat]");var b=a("h1[name=total_vat]");var e=0;var d=0;a("td[name=discounted]").each(function(){e+=parseFloat(a(this).attr("data-value"))});a("td[name=inclusive_of_tax]").each(function(){d+=parseFloat(a(this).attr("data-value"))});f.text(e.toFixed(2).replace(".",",")+" "+c);b.text(d.toFixed(2).replace(".",",")+" "+c)};creme.billing.EXPORT_FORMATS=[{value:"pdf",label:gettext("Pdf file (PDF)")}];creme.billing.exportAs=function(c,b){var b=b||creme.billing.EXPORT_FORMATS;if(b.length===1){window.location.href=c.format(b[0].value);return}creme.dialogs.choice(gettext("Select the export format of your billing document"),{choices:b}).onOk(function(d,e){window.location.href=c.format(e)}).open()};creme.billing.generateInvoiceNumber=function(b){return creme.utils.ajaxQuery(b,{action:"post",warnOnFail:true,reloadOnSuccess:true}).start()};(function(){var b={_action_billing_line_addonfly:function(d,c,f,g){return new creme.component.Action(function(){var e=f.count?parseInt(f.count):0;creme.billing.showEmptyForm(a(g.currentTarget),f.ctype_id,f.prefix,e);this.done()})},_action_billing_line_saveall:function(d,c,g,h){var f=this;return new creme.component.Action(function(){if(creme.billing.formsHaveErrors()){creme.dialogs.alert("<p>"+gettext("There are some errors in your lines.")+"</p>").open()}else{var e={};creme.billing.modifiedBLineForms().each(function(){var i=a(this);e[i.attr("ct_id")]=a.toJSON(creme.billing.serializeForm(i))});if(e.length===0){console.log("Forms not modified !");return this.cancel()}creme.utils.ajaxQuery(d,{action:"post",warnOnFail:true,warnOnFailTitle:gettext("Errors report")},e).onDone(function(){f.refresh()}).onFail(this.fail.bind(this)).start()}})},_action_billing_line_clearonfly:function(c,g,f,h){var d=this;return new creme.component.Action(function(){creme.billing.hideEmptyForm(f.ctype_id,f.prefix,f.count);a('[data-action="billing-line-addonfly"]',d._element).removeClass("forbidden");this.done()})}};a(document).on("brick-before-bind",".brick.billing-lines-brick",function(d,c){a.extend(c,b)}).on("brick-ready",function(f,d,c){creme.billing.initLinesBrick(d)})}())}(jQuery));(function(a){creme.opportunities=creme.opportunities||{}}(jQuery));(function(a){creme.commercial=creme.commercial||{};creme.commercial.setScore=function(h,d,g,b,f){var c=a(h);var e=c.parents(".brick").creme().widget().brick();var i={score:c.val(),model_id:g,segment_desc_id:b,orga_id:f};creme.utils.ajaxQuery(d,{action:"post",warnOnFail:true},i).onDone(function(){e.refresh()}).start()}}(jQuery));(function(a){if(!creme.reports){creme.reports={}}creme.reports.load=function(b,g,d){if(!b||b==undefined){return}var f=a(b.ct).val();var c=a(b.hf);this.loadHeaderFilters(g,f,c);var e=a(b.filter);this.loadEntityFilters(d,f,e)};creme.reports.__loadFilters=function(d,h,b,g){if(b.size()!=1){return}var i=a.extend({err_label:gettext("None available"),always_option:null,empty_option:null,error_option:null},g);var e=a('<option value="">'+i.err_label+"</option>");var c=function(l,n,k){b.empty();if(l.length==0&&!i.empty_option){b.append(e)}if(l.length==0&&i.empty_option){b.append(i.empty_option)}if(l.length>0&&i.always_option){b.append(i.always_option)}for(var j in l){var m=l[j];b.append(a('<option value="'+m[0]+'">'+m[1]+"</option>"))}};var f=function(k,l,j){if(!i.error_option){b.empty().append(e)}else{b.empty().append(i.empty_option)}};creme.ajax.json.get(d,{},c,f,false,this.loading_options)};creme.reports.loadHeaderFilters=function(c,d,b){var c=c+"?"+a.param({ct_id:d});var e={always_option:a('<option value="">'+gettext("No selected view")+"</option>")};creme.reports.__loadFilters(c,d,b,e)};creme.reports.loadEntityFilters=function(c,e,b){var c=c+"?"+a.param({ct_id:e});var d=a('<option value="">'+gettext("All")+"</option>");var f={empty_option:d,always_option:d,error_option:d};creme.reports.__loadFilters(c,e,b,f)};creme.reports.AJAX_BACKEND=new creme.ajax.CacheBackend(new creme.ajax.Backend(),{condition:new creme.ajax.CacheBackendTimeout(120*1000),dataType:"json"});creme.reports.toggleDisableOthers=function(d,c){var b=d.checked;a.each(c,function(e,f){a(f).attr("disabled",b)})};creme.utils.converters.register("creme.graphael.BargraphData","jqplotData",function(b){var h=b.x||[];var i=b.y||[];var e=[];var f=function(l){var k=parseFloat(l);return isNaN(k)?0:k};for(var d=0;d<Math.min(h.length,i.length);++d){var c=h[d];var g=i[d];var j;if(typeof g==="string"){j=[c,f(g),undefined]}else{if(a.isArray(g)){j=[c,f(g[0]),g[1]]}else{j=[c,g,undefined]}}e.push(j)}return e.length?[e]:[]});creme.reports.exportReport=function(e,d,c,b){creme.dialogs.form(d,{title:e||""}).on("frame-update",function(f,g){new creme.reports.PreviewController(c,b).bind(g.delegate())}).onFormSuccess(function(g,h,i,f){creme.utils.goTo(a(h).attr("redirect"))}).open({width:1024})};creme.reports.PreviewController=creme.component.Component.sub({_init_:function(c,b){this._redirectUrl=c+"?%s";this._downloadUrl=b+"?%s";this._listeners={update:a.proxy(this._updateHeader,this),redirect:a.proxy(this.redirect,this),download:a.proxy(this.download,this)}},bind:function(b){if(this._header!==undefined){throw"creme.reports.PreviewController is already bound."}var c=this._listeners;var d=this._header=a(".report-preview-header",b);a('select[name="date_field"]',d).change(c.update);a('button[name="generate"]',d).click(c.redirect);a('button[name="download"]',d).click(c.download);this._updateHeader();return this},unbind:function(b){var c=this._listeners;var d=this._header;if(d!==undefined){a('select[name="date_field"]',d).unbind("change",c.update);a('button[name="generate"]',d).unbind("click",c.redirect);a('button[name="download"]',d).unbind("click",c.download)}this._header=undefined;return this},_updateHeader:function(){var c=this._header;var b=!Object.isEmpty(a('[name="date_field"]',c).val());a(".date-filter",c).toggle(b);if(!b){a(".ui-creme-daterange",c).creme().widget().reset()}},redirect:function(){creme.utils.goTo(this._redirectUrl.format(a("form",this._header).serialize()))},download:function(){creme.utils.goTo(this._downloadUrl.format(a("form",this._header).serialize()))}});creme.reports.toggleDaysField=function(d,e){var c=d.val()&&e&&e.indexOf(d.val())!==-1;var b=a(d).parents(".block-form:first").find('[name="days"]');b.parents("tr:first").toggleClass("hidden",!c)};creme.reports.ChartController=creme.component.Component.sub({_init_:function(b){this._properties=b||{}},initialize:function(d,g){var i=this;var h=this._properties||{};var f=this._plot=creme.widget.create(a(".ui-creme-plotselector",d));var b=a.extend({},g);var e=function(l){b=i._state=a.extend({},b,l);a(".graph-controls-type .graph-control-value",d).text(h.charts[b.chart]);a(".graph-controls-sort .graph-control-value",d).text(h.sorts[b.sort]);f.reload(b)};var k=function(m,n,l){var n=Object.entries(n).filter(function(o){return o[0]!==l});var n=n.map(function(o){var q=o[0],p=o[1];return a('<a class="popover-list-item" title="%s" alt="%s">%s</a>'.format(p,p,p)).click(function(r){r.preventDefault();m.close(q)})});return n};var j=new creme.dialog.Popover().on("closed",function(l,m){e({chart:m})});var c=new creme.dialog.Popover({direction:"right"}).on("closed",function(l,m){e({sort:m})});j.fill(k(j,h.charts,b.chart));c.fill(k(c,h.sorts,b.sort));a(".graph-controls-type .graph-control-value",d).click(function(l){l.stopPropagation();j.fill(k(j,h.charts,b.chart)).toggle(this)});a(".graph-controls-sort .graph-control-value",d).click(function(l){l.stopPropagation();c.fill(k(c,h.sorts,b.sort)).toggle(this)});e(g)},reset:function(){this._plot.resetBackend();this._plot.reload(this._state)}})}(jQuery));(function(a){creme.crudity={};(function(){var c=function(d){return new creme.component.Action(function(){var e=this;creme.dialogs.warning(d).onClose(function(){e.fail()}).open()})};var b={_action_crudity_validate:function(g,f,h,i){var d=a(h.selector).getValues();if(d.length===0){return c(gettext("Nothing is selected."))}return this._action_update(g,{messageOnSuccess:gettext("Process done")},{ids:d},i)},_action_crudity_delete:function(g,f,h,i){var d=a(h.selector).getValues();if(d.length===0){return c(gettext("Nothing is selected."))}return this._action_update(g,{messageOnSuccess:gettext("Process done")},{ids:d},i)},};a(document).on("brick-before-bind",".brick.crudity-actions-brick",function(f,d){a.extend(d,b)})}())}(jQuery));(function(a){creme.emails={};(function(){var c=function(e){return new creme.component.Action(function(){var f=this;creme.dialogs.warning(e).onClose(function(){f.fail()}).open()})};var d={_action_emailsync_link:function(h,g,i,j){var f=a(i.selector).getValues();if(f.length===0){return c(gettext("Please select at least one entity."))}h+="?"+a.param({persist:"id",ids:f,rtype:i.rtypes});return this._action_form(h,g,i,j)},_action_emailsync_action:function(h,g,i,j){var f=a(i.selector).getValues();if(f.length===0){return c(gettext("Nothing is selected."))}return this._action_update(h,{messageOnSuccess:gettext("Process done")},{ids:f},j)},_action_emailsync_delete:function(h,g,i,j){var f=a(i.selector).getValues();if(f.length===0){return c(gettext("Nothing is selected."))}return this._action_update(h,{messageOnSuccess:gettext("Process done")},{ids:f.join(",")},j)},};a(document).on("brick-before-bind",".brick.emails-emailsync-brick",function(g,f){a.extend(f,d)});var b={_action_email_toggle_images:function(g,f,j,k){var h=this._element.find("iframe[data-html-field]");var i=document.createElement("a");i.href=h.attr("src");var m=i.search.indexOf("external_img=on")!==-1;var g=i.pathname+(m?"":"?external_img=on");var l=a(k.target).find(".brick-action-title");if(l.length){l.text(m?j.inlabel:j.outlabel)}else{a(k.target).text(m?j.inlabel:j.outlabel)}h.attr("src",g)},};a(document).on("brick-before-bind",".brick.emails-email-brick",function(g,f){a.extend(f,b)})}())}(jQuery));(function(a){creme.events=creme.events||{};creme.events.saveContactStatus=function(c,b){creme.utils.ajaxQuery(c,{warnOnFail:true,reloadOnFail:true}).post({status:a(b).val()})}}(jQuery));(function(d){creme.geolocation=creme.geolocation||{};var a={NONE:0,RUNNING:1,LOADED:2};var b={loadStatus:a.NONE,available:false};var c=new creme.component.EventHandler();window.__googleAPILoaderCb=function(){b.loadStatus=a.LOADED;b.available=true;c.trigger("google-api-loaded",[d({},b)])};window.gm_authFailure=function(){b.available=false;c.trigger("google-api-error",[d({},b)])};creme.geolocation.googleAPIState=function(){return d.extend({},b)};creme.geolocation.GoogleAPILoader=creme.component.Action.sub({_init_:function(e){this._super_(creme.component.Action,"_init_",this._loadAPI,e)},_loadAPI:function(g){g=d.extend({language:LANGUAGE_CODE||"en"},this.options(),g);var f=this;if(b.loadStatus===a.LOADED){return f.done(d({},b))}c.on("google-api-loaded",function(j,i){f.done(i)});if(b.status!==a.RUNNING){b.status=a.RUNNING;if(!g.apiKey){console.warn('creme.geolocation.googleAPILoader(): empty "apiKey" is deprecated ; configure it in settings.')}var e=document.createElement("script");var h={v:"3.exp",callback:"__googleAPILoaderCb",language:g.language,key:g.apiKey||""};e.type="text/javascript";e.src="https://maps.googleapis.com/maps/api/js?"+d.param(h);document.head.appendChild(e)}}});creme.geolocation.LocationStatus={UNDEFINED:0,MANUAL:1,PARTIAL:2,COMPLETE:3};creme.geolocation.GoogleMapController=creme.component.Component.sub({MAPSTYLES:[{id:"creme",label:gettext("Map"),style:[{stylers:[{hue:"#94c6db"},{weight:2}]},{featureType:"road",elementType:"geometry",stylers:[{visibility:"simplified"}]}]}],_init_:function(e){this.defaultZoomValue=12;this.defaultLat=48;this.defaultLn=2;this.defaultLargeZoom=4;this._infoUrl=e.infoUrl;this._events=new creme.component.EventHandler();this.marker_manager=new creme.geolocation.GoogleMapMarkerManager(this);this.shape_manager=new creme.geolocation.GoogleMapShapeRegistry(this)},loadAPI:function(e,g){e=e||{};var f=this._events;var h=function(){var i=false;try{if(Object.isNone(this.geocoder)){this.geocoder=new google.maps.Geocoder()}i=true}catch(j){console.warn("creme.geolocation.GoogleMapController(): unable to build google.maps.Geocoder instance",j)}if(i&&!Object.isNone(e.container)){this.enableMap(e.container,e.styles)}}.bind(this);f.one(g||{});if(this.isAPILoaded()){setTimeout(h,200);return this}c.on("google-api-error",function(j,i){console.warn("creme.geolocation.GoogleMapController(): google map API is now disabled");f.trigger("api-status",[false])});new creme.geolocation.GoogleAPILoader({apiKey:e.apiKey}).on("done",function(){setTimeout(h,200)}).on("fail",function(){f.trigger("api-status",[false])}).start();return this},enableMap:function(e,g){if(this.isMapEnabled()){return this}g=g||this.MAPSTYLES.slice();e=(e instanceof jQuery)?e.get(0):e;var f=g.map(function(i){return i.id}).concat(google.maps.MapTypeId.SATELLITE);var h=this._map=new google.maps.Map(e,{zoom:this.defaultZoomValue,mapTypeControlOptions:{mapTypeIds:f}});g.forEach(function(i){h.mapTypes.set(i.id,new google.maps.StyledMapType(i.style,{name:i.label}))});h.setMapTypeId(f[0]);this._mapContainer=e;this.resize();this.adjustMap();this._events.trigger("map-status",[true]);return this},disableMap:function(){if(!this.isMapEnabled()){return this}delete this._map;this._mapContainer.empty();this._mapContainer=undefined;this._events.trigger("map-status",[false]);return this},assertAPIAvailable:function(){if(!this.isAPIAvailable()){throw new Error("The google API is not available")}},isMapEnabled:function(){return Object.isNone(this._map)===false},isAPILoaded:function(){return b.loadStatus===a.LOADED},isAPIAvailable:function(){return b.available},on:function(f,g,e){this._events.on(f,g,e);return this},off:function(e,f){this._events.off(e,f);return this},one:function(e,f){this._events.one(e,f);return this},adjustMap:function(){if(!this.isMapEnabled()){return this}var f=this.marker_manager.count(true);if(f===0){var g=new google.maps.LatLng(this.defaultLat,this.defaultLn);this._map.setCenter(g);this._map.setZoom(this.defaultLargeZoom)}else{var e=this.marker_manager.getBoundBox();this._map.setCenter(e.getCenter());if(f===1){this._map.setZoom(this.defaultZoomValue)}else{this._map.fitBounds(e)}}return this},adjustMapToShape:function(e){if(!this.isMapEnabled()){return this}this._map.setCenter(e.getCenter());this._map.fitBounds(e.getBounds())},_isPartialMatch:function(f){if(f.length>1){return true}var e=f[0];if(e.partial_match===false){return false}return e.address_components.length<7},geocode:function(g){var f=this.marker_manager;var e=this.saveLocation.bind(this);var h=this._isPartialMatch.bind(this);this.geocoder.geocode(g.data,function(n,m){var l=g.address;if(m===google.maps.GeocoderStatus.OK){var k=f.get(l.id);var j=n[0];var i=j.geometry.location;var o=h(n);var p=creme.geolocation.LocationStatus.COMPLETE;if(o){p=creme.geolocation.LocationStatus.PARTIAL}if(!k){k=f.Marker({address:l,draggable:g.draggable,position:i})}else{k.setPosition(i)}e(k,{address:l,initial_position:g.initial_position},true,p);if(Object.isFunc(g.callback)){g.callback(k,j,p)}}else{if(Object.isFunc(g.fail)){g.fail(gettext("No matching location"))}}});return this},saveLocation:function(g,i,e,f){var h=this;creme.ajax.query(this._infoUrl,{},{id:i.address.id,latitude:g.position.lat(),longitude:g.position.lng(),geocoded:e,status:f}).onFail(function(){g.setPosition(i.initial_position)}).onDone(function(){h._events.trigger("save-location",[i.address,g,f])}).post();return this},findLocation:function(e,f){return this.geocode({address:e,draggable:f.draggable,data:{address:e.content},fail:f.fail,callback:f.done})},getMarker:function(e){return this.marker_manager.get(e)},map:function(){return this._map},isAddressLocated:function(e){return e&&!Object.isNone(e.latitude)&&!Object.isNone(e.longitude)},resize:function(){google.maps.event.trigger(this._map,"resize");return this}});creme.geolocation.GoogleMapShapeRegistry=creme.component.Component.sub({_init_:function(e){this._controller=e;this._shapes={}},register:function(e,f){if(e in this._shapes){throw new Error('Shape "'+e+'" is already registered')}this._shapes[e]=f},unregister:function(e){if(e in this._shapes){this._shapes[e].setMap(null);delete this._shapes[e]}else{throw new Error('Shape "'+e+'" not registered')}},get:function(e){if(e in this._shapes){return this._shapes[e]}else{return false}},adjustMap:function(e){this._controller.adjustMapToShape(this.get(e));return this}});creme.geolocation.GoogleMapMarkerManager=creme.component.Component.sub({_init_:function(e){this._controller=e;this._markers={}},markers:function(f){var e=Object.values(this._markers);if(f===undefined){return e}return e.filter(function(g){return g.getVisible()===f})},count:function(e){return this.markers(e).length},register:function(e){var f=e.address.id;if(f in this._markers){throw new Error('marker "'+f+'" is already registered')}this._markers[f]=e},Marker:function(h){h=d.extend({map:this._controller.map(),draggable:false},h||{});var g=h.address;h.position=h.position||new google.maps.LatLng(g.latitude,g.longitude);h.title="%s\n%s".format(g.owner,g.title||g.content);var f=new google.maps.Marker(h);this.register(f);if(h.redirect){google.maps.event.addListener(f,"click",function(){creme.utils.goTo(h.redirect)})}if(h.draggable){var e=this._controller.saveLocation.bind(this._controller);google.maps.event.addListener(f,"dragstart",function(){h.initial_position=this.getPosition()});google.maps.event.addListener(f,"dragend",function(){e(f,h,true,creme.geolocation.LocationStatus.MANUAL)})}return f},get:function(e){return this._markers[e]},show:function(e){this.toggle(e,true)},hide:function(e){this.toggle(e,false)},toggle:function(g,f){var e=this.get(g);if(e){e.setVisible(f===undefined?!e.getVisible():f);this._controller.adjustMap()}},hideAll:function(){for(var e in this._markers){this._markers[e].setVisible(false)}},getBoundBox:function(){var e=new google.maps.LatLngBounds();this.markers(true).forEach(function(f){e.extend(f.getPosition())});return e}})}(jQuery));(function(a){creme.geolocation=creme.geolocation||{};creme.geolocation.PersonsBrick=creme.component.Component.sub({STATUS_LABELS:{0:gettext("Not localized"),1:gettext("Manual location"),2:gettext("Partially matching location"),3:""},_init_:function(e,d){d=a.extend({addresses:[]},d||{});var c=this;this._brick=e;this._addresses=d.addresses;var b=this._controller=new creme.geolocation.GoogleMapController(d);b.on("save-location",this._onSaveLocation.bind(this)).on("api-status",this._onAPIStatus.bind(this)).on("map-status",this._onCanvasStatus.bind(this));e.on("state-update",this._onBrickStateUpdate.bind(this));this.addressItems().each(function(){var g=a('input[type="checkbox"]',this);var f=a(".brick-geoaddress-reset",this);f.click(c._onRefreshLocation.bind(c));g.change(c._onToggleLocation.bind(c));c._toggleLocation(g.val(),g.is(":checked"))});b.loadAPI({apiKey:d.apiKey,container:this.canvas()})},_onBrickStateUpdate:function(b,c){if(!c.collapsed){this._controller.resize();this._controller.adjustMap()}},_onAPIStatus:function(c,b){this._brick.element().toggleClass("is-geolocation-disabled",!b)},_onCanvasStatus:function(c,b){if(b){this._addresses.forEach(this._geocodeAddress.bind(this))}},_onSaveLocation:function(e,d,c,b){this._showPosition(d.id,c);this._showStatus(d.id,b);this._brick.trigger("geoaddress-location",[d,c])},_geocodeAddress:function(c){var d=this;var b=this._controller;if(b.isAddressLocated(c)){b.marker_manager.Marker({address:c,draggable:true,visible:false})}else{b.findLocation(c,{draggable:true,done:function(e){b.marker_manager.hideAll()},fail:function(e){d._showStatus(c.id,e)}})}},addressItem:function(b){return a('.brick-geoaddress-item[data-addressid="'+b+'"]',this._brick.element())},addressItems:function(){return a(".brick-geoaddress-item",this._brick.element())},canvas:function(){return a(".brick-geoaddress-canvas",this._brick.element())},_showStatus:function(e,b){var d=this.addressItem(e);var c=(b===creme.geolocation.LocationStatus.COMPLETE);d.find(".brick-geoaddress-status").html(this.STATUS_LABELS[b]);d.find(".brick-geoaddress-action").toggleClass("brick-geoaddress-iscomplete",c)},_showPosition:function(d,b){var c="";if(!Object.isEmpty(b)){c="%3.6f, %3.6f".format(b.position.lat(),b.position.lng())}this.addressItem(d).find(".brick-geoaddress-position").html(c)},_toggleLocation:function(c,b){this._controller.marker_manager.toggle(c,b);this.addressItem(c).toggleClass("item-selected",b)},_onRefreshLocation:function(f){var d=this;var c=this._controller;var e=parseInt(a(f.target).attr("data-addressid"));var b=c.getMarker(e);if(b){this._controller.findLocation(b.address,{done:function(i,g,h){c.adjustMap()},fail:function(g){d._showPosition(e);d._showStatus(e,g)}})}},_onToggleLocation:function(b){this._toggleLocation(a(b.target).val(),a(b.target).is(":checked"))}});creme.geolocation.AddressesBrick=creme.component.Component.sub({_init_:function(d,c){c=c||{};this._brick=d;this._addressesUrl=c.addressesUrl;var b=this._controller=new creme.geolocation.GoogleMapController(c);b.on("api-status",this._onAPIStatus.bind(this)).on("map-status",this._onCanvasStatus.bind(this));d.on("state-update",this._onBrickStateUpdate.bind(this));b.loadAPI({apiKey:c.apiKey,container:this.canvas()})},_onBrickStateUpdate:function(b,c){if(!c.collapsed){this._controller.resize();this._controller.adjustMap()}},_onAPIStatus:function(c,b){this._brick.element().toggleClass("is-geolocation-disabled",!b)},_onCanvasStatus:function(c,b){if(b){var d=this._filterSelector=a(".brick-geoaddress-filter",this._brick.element());d.change(this._onFilterChange.bind(this));this._updateFilter(d.val())}},_queryAddresses:function(g,f){var d=this;var c=this._controller;var b=this._updateAddress.bind(this);var e=this._addressesUrl;creme.ajax.query(e,{},{id:g}).converter(JSON.parse).onDone(function(h,i){i.addresses.forEach(b);c.adjustMap();d._showCount(i.addresses.length)}).onFail(function(){c.adjustMap();d._showCount(0)}).on(f||{}).get()},_updateAddress:function(d){var c=this._controller;var b=c.marker_manager.get(d.id);if(!b){if(c.isAddressLocated(d)){c.marker_manager.Marker({address:d,draggable:false,redirect:d.url})}}else{b.setVisible(true)}},_onFilterChange:function(d){var b=this._controller;var c=a(d.target).val();b.marker_manager.hideAll();this._updateFilter(c,{fail:function(){a(d.target).val("")}})},_updateFilter:function(c,b){if(c){this._queryAddresses(c,b)}else{this._controller.adjustMap();this._showCount(0)}},_showCount:function(c){var b=!c?gettext("No address from"):ngettext("%0$d address from","%0$d addresses from",c).format(c);a(".brick-geoaddress-counter",this._brick.element()).html(b)},canvas:function(){return a(".brick-geoaddress-canvas",this._brick.element())}});creme.geolocation.PersonsNeighborhoodBrick=creme.component.Component.sub({_init_:function(d,c){c=c||{};this._radius=c.radius||1;this._brick=d;this._neighboursUrl=c.neighboursUrl;var b=this._controller=new creme.geolocation.GoogleMapController(c);b.on("api-status",this._onAPIStatus.bind(this)).on("map-status",this._onCanvasStatus.bind(this));d.on("state-update",this._onBrickStateUpdate.bind(this));b.loadAPI({apiKey:c.apiKey,container:this.canvas()})},_onBrickStateUpdate:function(b,c){if(!c.collapsed){this._controller.resize();this._controller.shape_manager.adjustMap("NeighbourhoodCircle")}},_onAPIStatus:function(c,b){this._brick.element().toggleClass("is-geolocation-disabled",!b)},_onCanvasStatus:function(d,c){if(c){var b=this._brick.element();this._sourceSelector=a(".brick-geoaddress-source",b).change(this._onChange.bind(this));this._filterSelector=a(".brick-geoaddress-filter",b).change(this._onChange.bind(this));this._onChange()}},_queryNeighbours:function(b,d){if(!b){this._controller.adjustMap();return}var f=this._updateNeighbours.bind(this);var e={address_id:b,filter_id:d};var c=this._neighboursUrl+"?"+a.param(e);creme.ajax.query(c).converter(JSON.parse).onDone(function(g,h){f(h.source_address,h.addresses)}).onFail(function(){f(b,[])}).get()},_clearNeighbours:function(){var b=this._controller;b.marker_manager.hideAll();if(b.shape_manager.get("NeighbourhoodCircle")){b.shape_manager.unregister("NeighbourhoodCircle")}},_updateMarker:function(d,e){if(Object.isNone(d)){return}var c=this._controller;var b=c.marker_manager.get(d.id);if(c.isAddressLocated(d)){if(b){b.setPosition(new google.maps.LatLng(d.latitude,d.longitude))}else{e=a.extend({address:d,draggable:false},e||{});b=c.marker_manager.Marker(e)}b.setVisible(true)}return b},_updateNeighbours:function(c,f){this._clearNeighbours();var b=this._controller;var e=this._updateMarker(c,{icon:{path:google.maps.SymbolPath.CIRCLE,scale:5}});if(!e){return this}b.shape_manager.register("NeighbourhoodCircle",new google.maps.Circle({strokeColor:"#dea29b",strokeOpacity:0.9,strokeWeight:2,fillColor:"#dea29b",fillOpacity:0.4,map:b.map(),center:e.position,radius:this._radius}));this._showCount(f.length);var d=this._updateMarker.bind(this);f.forEach(function(g){d(g,{redirect:g.url})});b.shape_manager.adjustMap("NeighbourhoodCircle")},sourcePosition:function(c,b){var d=this._controller.getMarker(c.id);if(d){d.setPosition(b);if(this._sourceSelector.val()===""+c.id){this._queryNeighbours(this._sourceSelector.val(),this._filterSelector.val())}}},_onChange:function(b){this._queryNeighbours(this._sourceSelector.val(),this._filterSelector.val())},_showCount:function(c){var b=!c?gettext("None of"):ngettext("%0$d of","%0$d of",c).format(c);a(".brick-geoaddress-counter",this._brick.element()).html(b)},canvas:function(){return a(".brick-geoaddress-canvas",this._brick.element())}})}(jQuery));